# UpCoach Testing Docker Compose Configuration
# Testing services for E2E, integration, and performance testing

services:
  # Playwright for E2E Testing
  playwright:
    image: mcr.microsoft.com/playwright:v1.40.0-focal
    container_name: upcoach-playwright
    volumes:
      - ./tests/e2e:/tests
      - ./test-results:/test-results
    environment:
      BASE_URL: http://landing-page:3000
      ADMIN_URL: http://admin-panel:3001
      CMS_URL: http://cms-panel:3002
      API_URL: http://backend-api:8080
      NODE_ENV: test
    depends_on:
      - landing-page
      - admin-panel
      - cms-panel
      - backend-api
    command: ["npx", "playwright", "test"]
    working_dir: /tests

  # Flutter Mobile App Testing
  flutter-test:
    build:
      context: ./apps/mobile
      dockerfile: Dockerfile.test
    container_name: upcoach-flutter-test
    volumes:
      - ./apps/mobile:/app
      - ./test-results/flutter:/test-results
    environment:
      FLUTTER_TEST: true
      API_URL: http://backend-api:8080
    command: ["flutter", "test", "--coverage"]
    working_dir: /app

  # React Native Testing (if using RN instead of Flutter)
  react-native-test:
    build:
      context: ./apps/mobile-rn
      dockerfile: Dockerfile.test
    container_name: upcoach-rn-test
    volumes:
      - ./apps/mobile-rn:/app
      - ./test-results/react-native:/test-results
    environment:
      NODE_ENV: test
      API_URL: http://backend-api:8080
    command: ["npm", "test", "--", "--coverage", "--watchAll=false"]
    working_dir: /app
    profiles:
      - react-native

  # API Testing & Load Testing
  k6-load-test:
    image: grafana/k6:latest
    container_name: upcoach-k6
    volumes:
      - ./tests/load:/scripts
      - ./test-results/k6:/results
    environment:
      API_URL: http://backend-api:8080
    depends_on:
      - backend-api
    command: ["run", "--out", "json=/results/load-test-results.json", "/scripts/load-test.js"]
    profiles:
      - load-test

  # Test Database (Isolated for testing)
  postgres-test:
    image: postgres:15-alpine
    container_name: upcoach-db-test
    environment:
      POSTGRES_USER: ${DB_USER:-upcoach}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-upcoach_test_pass}
      POSTGRES_DB: ${DB_NAME:-upcoach_test}
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./services/api/migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-upcoach}"]
      interval: 5s
      timeout: 3s
      retries: 5
    profiles:
      - test-db

  # Test Redis
  redis-test:
    image: redis:7-alpine
    container_name: upcoach-redis-test
    ports:
      - "6380:6379"
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    profiles:
      - test-db

  # Selenium Grid for Browser Testing
  selenium-hub:
    image: selenium/hub:4.15.0
    container_name: upcoach-selenium-hub
    ports:
      - "4444:4444"
    environment:
      GRID_MAX_SESSION: 16
    profiles:
      - selenium

  selenium-chrome:
    image: selenium/node-chrome:4.15.0
    container_name: upcoach-selenium-chrome
    environment:
      HUB_HOST: selenium-hub
      NODE_MAX_SESSION: 4
    depends_on:
      - selenium-hub
    profiles:
      - selenium

  selenium-firefox:
    image: selenium/node-firefox:4.15.0
    container_name: upcoach-selenium-firefox
    environment:
      HUB_HOST: selenium-hub
      NODE_MAX_SESSION: 4
    depends_on:
      - selenium-hub
    profiles:
      - selenium

volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local