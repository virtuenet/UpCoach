# UpCoach Mobile E2E Tests CI/CD Pipeline
#
# This workflow runs end-to-end tests on pull requests and main branch pushes.
# It supports both Android and iOS testing with comprehensive reporting.

name: E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/e2e_tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/mobile/**'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - all
          - smoke
          - auth
          - habits
          - goals
          - accessibility
      platform:
        description: 'Platform to test'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - both

env:
  FLUTTER_VERSION: '3.35.3'
  JAVA_VERSION: '17'
  WORKING_DIRECTORY: apps/mobile

jobs:
  # ===========================================================================
  # Android E2E Tests
  # ===========================================================================
  android-e2e:
    name: Android E2E Tests
    runs-on: macos-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.platform != 'ios' }}

    strategy:
      fail-fast: false
      matrix:
        api-level: [30]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}

      - name: Create AVD and Generate Snapshot
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run E2E Tests on Android
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          working-directory: ${{ env.WORKING_DIRECTORY }}
          script: |
            # Determine test file based on input or default
            TEST_SUITE="${{ github.event.inputs.test_suite || 'smoke' }}"

            case $TEST_SUITE in
              all)
                TEST_FILE="integration_test/app_test.dart"
                ;;
              smoke|auth)
                TEST_FILE="integration_test/flows/auth_flow_test.dart"
                ;;
              habits)
                TEST_FILE="integration_test/flows/habits_flow_test.dart"
                ;;
              goals)
                TEST_FILE="integration_test/flows/goals_flow_test.dart"
                ;;
              accessibility)
                TEST_FILE="integration_test/accessibility/accessibility_test.dart"
                ;;
              *)
                TEST_FILE="integration_test/flows/auth_flow_test.dart"
                ;;
            esac

            echo "Running test file: $TEST_FILE"

            # Set CI environment variables
            export SKIP_SLOW_TESTS=true
            export CAPTURE_SCREENSHOTS=true
            export TEST_ENV=staging

            # Run integration tests
            flutter test $TEST_FILE --coverage

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-e2e-results
          path: |
            ${{ env.WORKING_DIRECTORY }}/test_screenshots/
            ${{ env.WORKING_DIRECTORY }}/coverage/
          retention-days: 7

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: e2e-android
          name: android-e2e-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # iOS E2E Tests
  # ===========================================================================
  ios-e2e:
    name: iOS E2E Tests
    runs-on: macos-latest
    timeout-minutes: 60
    if: ${{ github.event.inputs.platform != 'android' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Start iOS Simulator
        run: |
          # List available simulators
          xcrun simctl list devices

          # Boot the latest iPhone simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')

          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
          fi

          echo "Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true

          # Wait for simulator to boot
          sleep 30

      - name: Run E2E Tests on iOS
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          # Determine test file
          TEST_SUITE="${{ github.event.inputs.test_suite || 'smoke' }}"

          case $TEST_SUITE in
            all)
              TEST_FILE="integration_test/app_test.dart"
              ;;
            smoke|auth)
              TEST_FILE="integration_test/flows/auth_flow_test.dart"
              ;;
            habits)
              TEST_FILE="integration_test/flows/habits_flow_test.dart"
              ;;
            goals)
              TEST_FILE="integration_test/flows/goals_flow_test.dart"
              ;;
            accessibility)
              TEST_FILE="integration_test/accessibility/accessibility_test.dart"
              ;;
            *)
              TEST_FILE="integration_test/flows/auth_flow_test.dart"
              ;;
          esac

          echo "Running test file: $TEST_FILE"

          # Set CI environment variables
          export SKIP_SLOW_TESTS=true
          export CAPTURE_SCREENSHOTS=true
          export TEST_ENV=staging

          # Run integration tests
          flutter test $TEST_FILE --coverage

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-e2e-results
          path: |
            ${{ env.WORKING_DIRECTORY }}/test_screenshots/
            ${{ env.WORKING_DIRECTORY }}/coverage/
          retention-days: 7

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: e2e-ios
          name: ios-e2e-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # Report Results
  # ===========================================================================
  report:
    name: Test Report
    needs: [android-e2e, ios-e2e]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download Android Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: android-e2e-results
          path: android-results

      - name: Download iOS Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ios-e2e-results
          path: ios-results

      - name: Generate Summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite:** ${{ github.event.inputs.test_suite || 'smoke' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** ${{ github.event.inputs.platform || 'both' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.android-e2e.result }}" == "success" ]; then
            echo "- :white_check_mark: **Android:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.android-e2e.result }}" == "failure" ]; then
            echo "- :x: **Android:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :warning: **Android:** ${{ needs.android-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.ios-e2e.result }}" == "success" ]; then
            echo "- :white_check_mark: **iOS:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.ios-e2e.result }}" == "failure" ]; then
            echo "- :x: **iOS:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :warning: **iOS:** ${{ needs.ios-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Test screenshots and coverage reports are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check Results
        run: |
          if [ "${{ needs.android-e2e.result }}" == "failure" ] || [ "${{ needs.ios-e2e.result }}" == "failure" ]; then
            echo "One or more E2E test jobs failed"
            exit 1
          fi
