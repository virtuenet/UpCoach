# UpCoach Mobile PR Validation
# Fast validation for pull requests

name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/pr-validation.yml'

env:
  FLUTTER_VERSION: '3.35.3'
  WORKING_DIRECTORY: 'apps/mobile'

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Quick Validation
  # =============================================================================
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Get Dependencies
        run: flutter pub get

      - name: Check Formatting
        id: format
        run: |
          dart format --output=none --set-exit-if-changed . 2>&1 | tee format_output.txt || true
          if [ -s format_output.txt ]; then
            echo "::warning::Some files need formatting"
            echo "needs_format=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Code
        run: flutter analyze --no-fatal-infos

      - name: Run Tests
        run: flutter test --reporter=github

      - name: Check for Generated Files
        run: |
          # Check if generated files are up to date
          flutter pub run build_runner build --delete-conflicting-outputs 2>/dev/null || true

          if ! git diff --quiet; then
            echo "::warning::Generated files may be out of date. Run 'flutter pub run build_runner build'"
          fi

  # =============================================================================
  # Build Check
  # =============================================================================
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Android (Debug)
        run: flutter build apk --debug

      - name: Check Build Size
        run: |
          APK_SIZE=$(du -m build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "ğŸ“¦ APK Size: ${APK_SIZE}MB"

          # Warn if APK is over 100MB
          if [ "$APK_SIZE" -gt 100 ]; then
            echo "::warning::APK size is ${APK_SIZE}MB - consider optimizing"
          fi

  # =============================================================================
  # iOS Build Check (Optional)
  # =============================================================================
  ios-build-check:
    name: iOS Build Check
    runs-on: macos-latest
    needs: validate
    if: contains(github.event.pull_request.labels.*.name, 'check-ios')
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS (Debug Simulator)
        run: flutter build ios --debug --simulator --no-codesign

  # =============================================================================
  # PR Comment
  # =============================================================================
  comment:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate, build-check]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const validate = '${{ needs.validate.result }}';
            const build = '${{ needs.build-check.result }}';

            const status = (result) => result === 'success' ? 'âœ…' : result === 'skipped' ? 'â­ï¸' : 'âŒ';

            const body = `## ğŸ” PR Validation Results

            | Check | Status |
            |-------|--------|
            | Code Analysis & Tests | ${status(validate)} |
            | Android Build | ${status(build)} |

            ${validate === 'success' && build === 'success' ? '### âœ… All checks passed!' : '### âš ï¸ Some checks need attention'}

            <details>
            <summary>ğŸ“‹ Checklist before merging</summary>

            - [ ] Code has been reviewed
            - [ ] Tests cover new functionality
            - [ ] Documentation updated if needed
            - [ ] No breaking changes (or documented)
            </details>

            ---
            *Automated by GitHub Actions*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Validation Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
