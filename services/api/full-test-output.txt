
> @upcoach/api@1.0.0 test
> NODE_OPTIONS='--max-old-space-size=2048' jest --passWithNoTests --verbose

ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/services/api/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/e2e-critical/coach-revenue-journey.test.ts
  E2E Critical Journey: Coach Revenue Flow
    Step 1: Coach Registration & Profile Creation
      âœ• should successfully register as a coach (35 ms)
      âœ• should create complete coach profile (8 ms)
      âœ• should appear in coach search results (6 ms)
    Step 2: Set Availability & Pricing
      âœ• should set weekly availability schedule (6 ms)
      âœ• should verify available time slots are bookable (8 ms)
    Step 3: Client Books Session
      âœ• should register a client user (5 ms)
      âœ• should successfully book session with coach (5 ms)
      âœ• coach should see booked session in their schedule (6 ms)
    Step 4: Coach Delivers Session
      âœ• should mark session as complete with notes (10 ms)
      âœ• client should be able to rate the session (7 ms)
    Step 5: Coach Receives Payment
      âœ• should release payment to coach after session completion (6 ms)
      âœ• should see payment in earnings history (6 ms)
    Step 6: Coach Views Analytics
      âœ• should view comprehensive coach analytics dashboard (6 ms)
      âœ• should view earnings breakdown by period (6 ms)
    Journey Completion
      âœ• should have completed full coach revenue journey (5 ms)

  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should successfully register as a coach

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should create complete coach profile

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should appear in coach search results

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 2: Set Availability & Pricing â€º should set weekly availability schedule

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 2: Set Availability & Pricing â€º should verify available time slots are bookable

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º should register a client user

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º should successfully book session with coach

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º coach should see booked session in their schedule

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 4: Coach Delivers Session â€º should mark session as complete with notes

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 4: Coach Delivers Session â€º client should be able to rate the session

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 5: Coach Receives Payment â€º should release payment to coach after session completion

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 5: Coach Receives Payment â€º should see payment in earnings history

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 6: Coach Views Analytics â€º should view comprehensive coach analytics dashboard

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 6: Coach Views Analytics â€º should view earnings breakdown by period

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Journey Completion â€º should have completed full coach revenue journey

    AggregateError:



  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/integration/user-registration-flow.test.ts
  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should register new user with valid credentials

    expected 201 "Created", got 404 "Not Found"

      52 |
      53 |     jest.clearAllMocks();
    > 54 |   });
         |      ^
      55 |
      56 |   describe('Step 1: User Registration', () => {
      57 |     test('should register new user with valid credentials', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:54:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should send verification email after registration

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      66 |
      67 |       expect(response.body).toMatchObject({
    > 68 |         success: true,
         |                       ^
      69 |         message: expect.stringContaining('registered'),
      70 |         userId: expect.any(String),
      71 |       });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:68:48)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should prevent duplicate email registration

    expected 201 "Created", got 404 "Not Found"

      79 |     });
      80 |
    > 81 |     test('should send verification email after registration', async () => {
         |                  ^
      82 |       (emailService.send as jest.Mock).mockResolvedValue({ success: true });
      83 |
      84 |       await request(app)

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:81:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should validate email format

    expected 400 "Bad Request", got 404 "Not Found"

       98 |     test('should prevent duplicate email registration', async () => {
       99 |       // First registration
    > 100 |       await request(app)
          |                  ^
      101 |         .post('/api/auth/register')
      102 |         .send(testUser)
      103 |         .expect(201);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:100:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should enforce strong password policy

    expected 400 "Bad Request", got 404 "Not Found"

      117 |     test('should validate email format', async () => {
      118 |       const response = await request(app)
    > 119 |         .post('/api/auth/register')
          |                      ^
      120 |         .send({
      121 |           email: 'invalid-email',
      122 |           password: testUser.password,

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:119:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should initialize user gamification on registration

    expected 201 "Created", got 404 "Not Found"

      125 |         .expect(400);
      126 |
    > 127 |       expect(response.body.error).toMatch(/valid email/i);
          |                  ^
      128 |     });
      129 |
      130 |     test('should enforce strong password policy', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:127:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should verify email with valid token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should reject invalid verification token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should reject expired verification token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should allow resending verification email

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should login with verified credentials

    expected 200 "OK", got 404 "Not Found"

      206 |     test('should reject invalid verification token', async () => {
      207 |       const response = await request(app)
    > 208 |         .get('/api/auth/verify-email?token=invalid-token')
          |                  ^
      209 |         .expect(400);
      210 |
      211 |       expect(response.body.error).toMatch(/invalid.*token/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:208:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should reject login before email verification

    expected 403 "Forbidden", got 404 "Not Found"

      230 |
      231 |       const response = await request(app)
    > 232 |         .post('/api/auth/resend-verification')
          |                  ^
      233 |         .send({ email: testUser.email })
      234 |         .expect(200);
      235 |

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:232:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should reject invalid password

    expected 401 "Unauthorized", got 404 "Not Found"

      240 |
      241 |       expect(emailService.send).toHaveBeenCalled();
    > 242 |     });
          |        ^
      243 |   });
      244 |
      245 |   describe('Step 3: User Login', () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:242:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should track login attempts and lock account after 5 failures

    expected 401 "Unauthorized", got 404 "Not Found"

      252 |     });
      253 |
    > 254 |     test('should login with verified credentials', async () => {
          |                      ^
      255 |       const response = await request(app)
      256 |         .post('/api/auth/login')
      257 |         .send({

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:254:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should complete profile with additional information

    expected 200 "OK", got 404 "Not Found"

      299 |           email: testUser.email,
      300 |           password: 'WrongPassword123!',
    > 301 |         })
          |           ^
      302 |         .expect(401);
      303 |
      304 |       expect(response.body.error).toMatch(/invalid.*credentials/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:301:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should upload profile picture

    expected 200 "OK", got 404 "Not Found"

      316 |           })
      317 |           .expect(401);
    > 318 |       }
          |        ^
      319 |
      320 |       // Next attempt should be locked
      321 |       const response = await request(app)

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:318:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should require authentication for profile updates

    expected 401 "Unauthorized", got 404 "Not Found"

      326 |         })
      327 |         .expect(423);
    > 328 |
          | ^
      329 |       expect(response.body.error).toMatch(/locked/i);
      330 |     });
      331 |   });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:328:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should complete onboarding with goals and interests

    expected 200 "OK", got 404 "Not Found"

      355 |           language: 'en',
      356 |           notifications: {
    > 357 |             email: true,
          |                  ^
      358 |             push: true,
      359 |             sms: false,
      360 |           },

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:357:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should award onboarding completion points

    expected 200 "OK", got 404 "Not Found"

      372 |         .expect(200);
      373 |
    > 374 |       expect(response.body).toMatchObject({
          |                  ^
      375 |         success: true,
      376 |         profile: expect.objectContaining({
      377 |           bio: profileData.bio,

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:374:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should send welcome email after onboarding

    TypeError: Cannot read properties of undefined (reading 'mockClear')

      382 |       // Verify in database
      383 |       const user = await User.findOne({ where: { email: testUser.email } });
    > 384 |       expect(user?.profile).toMatchObject(profileData);
          |                                                ^
      385 |     });
      386 |
      387 |     test('should upload profile picture', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:384:48)

  â— Integration: User Registration Flow â€º End-to-End: Complete Registration Flow â€º should complete entire registration flow successfully

    expected 201 "Created", got 404 "Not Found"

      400 |     test('should require authentication for profile updates', async () => {
      401 |       const response = await request(app)
    > 402 |         .put('/api/user/profile')
          |                  ^
      403 |         .send({ bio: 'Test' })
      404 |         .expect(401);
      405 |

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:402:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º End-to-End: Complete Registration Flow â€º should track registration flow metrics

    TypeError: Cannot read properties of undefined (reading 'SELECT')

      464 |       const gamificationData = await sequelize.query(
      465 |         'SELECT * FROM user_levels WHERE user_id = ?',
    > 466 |         {
          |          ^
      467 |           replacements: [user?.id],
      468 |           type: sequelize.QueryTypes.SELECT,
      469 |         }

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:466:53)

  â— Integration: User Registration Flow â€º Error Recovery and Edge Cases â€º should handle concurrent registration attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      477 |
      478 |       await request(app)
    > 479 |         .post('/api/onboarding/complete')
          |                                          ^
      480 |         .set('Authorization', `Bearer ${authToken}`)
      481 |         .send({
      482 |           interests: ['fitness'],

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:479:49)

  â— Integration: User Registration Flow â€º Error Recovery and Edge Cases â€º should rollback on registration failure

    Property `query` does not exist in the provided object

      496 |   describe('End-to-End: Complete Registration Flow', () => {
      497 |     test('should complete entire registration flow successfully', async () => {
    > 498 |       // Step 1: Register
          |                          ^
      499 |       const registerResponse = await request(app)
      500 |         .post('/api/auth/register')
      501 |         .send(testUser)

      at ModuleMocker.spyOn (../../node_modules/jest-environment-node/node_modules/jest-mock/build/index.js:731:13)
      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:498:28)


  â— Test suite failed to run

    TypeError: models_1.sequelize.close is not a function

      31 |   let authToken: string;
      32 |
    > 33 |   beforeAll(async () => {
         |                          ^
      34 |     // Connect to test database
      35 |     await sequelize.sync({ force: true });
      36 |   });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:33:34)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/e2e-critical/subscription-monetization-journey.test.ts
  E2E Critical Journey: Subscription & Monetization Flow
    Step 1: User Registration (Free Tier)
      âœ• should successfully register with free tier access (9 ms)
      âœ• should be blocked from accessing premium features (7 ms)
    Step 2: Subscription Purchase (Premium Tier)
      âœ• should fetch available subscription plans (11 ms)
      âœ• should successfully create premium subscription (6 ms)
      âœ• should have updated user profile with premium tier (5 ms)
    Step 3: Premium Feature Access
      âœ• should now have access to premium analytics (7 ms)
      âœ• should have access to premium content library (6 ms)
      âœ• should have increased resource limits (9 ms)
    Step 4: Successful Payment Processing
      âœ• should process first subscription payment successfully (6 ms)
      âœ• should generate invoice for payment (11 ms)
    Step 5: Subscription Tier Upgrade
      âœ• should successfully upgrade to enterprise tier (5 ms)
      âœ• should have enterprise features enabled (5 ms)
    Journey Completion
      âœ• should have completed full monetization journey (8 ms)

  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 1: User Registration (Free Tier) â€º should successfully register with free tier access

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 1: User Registration (Free Tier) â€º should be blocked from accessing premium features

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should fetch available subscription plans

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should successfully create premium subscription

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should have updated user profile with premium tier

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should now have access to premium analytics

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should have access to premium content library

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should have increased resource limits

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 4: Successful Payment Processing â€º should process first subscription payment successfully

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 4: Successful Payment Processing â€º should generate invoice for payment

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 5: Subscription Tier Upgrade â€º should successfully upgrade to enterprise tier

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 5: Subscription Tier Upgrade â€º should have enterprise features enabled

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Journey Completion â€º should have completed full monetization journey

    AggregateError:



  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-efdg9k', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-efdg9k



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-wz7lam',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-wz7lam



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-8ucj77',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-8ucj77



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-rv9fa', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-rv9fa



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-d8wsk', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-d8wsk



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-fpm4xm',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-fpm4xm



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-w2l78f', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-w2l78f



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-3mopl1',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-3mopl1



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-1braq', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-1braq



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-mwz03q', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-mwz03q



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-e9b6rb',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-e9b6rb



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-uofpz', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-uofpz



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-jcv8vp', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-jcv8vp



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-8vow9r',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-8vow9r



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-fzccaf',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-fzccaf



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-b7trj9', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-b7trj9



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-1ug3tn',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-1ug3tn



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-t031e5',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-t031e5



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'testuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-rpbcwr',
      email: 'testuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-rpbcwr



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-wq9npn', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-wq9npn



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-0ryira',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-0ryira



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-336vr7',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-336vr7



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'testuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-nevy7q',
      email: 'testuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-nevy7q



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-ppmxlf', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-ppmxlf



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-nkyvca',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-nkyvca



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-s0dgcj',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-s0dgcj



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'testuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-iebge5',
      email: 'testuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-iebge5



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-rcyo8', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-rcyo8



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-y6wx6k',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-y6wx6k



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-tqsavbm',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-tqsavbm



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'testuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-ktstre',
      email: 'testuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-ktstre



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:113:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'testuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:170:58)

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-ktstre', email: 'testuser@example.com' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:170:58)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-yowcoe', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-yowcoe



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-kh9tfv',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-kh9tfv



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-thty5v',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-thty5v



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'refreshuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-pk60ij',
      email: 'refreshuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-pk60ij



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-wu0uop', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-wu0uop



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-mmh4jh',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-mmh4jh



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-7zr66n',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-7zr66n



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'refreshuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-otto4n',
      email: 'refreshuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-otto4n



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-6rz23j', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-6rz23j



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-6fy9nr',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-6fy9nr



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-82m5pd',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-82m5pd



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'refreshuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-i5r68d',
      email: 'refreshuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-i5r68d



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:190:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-24jy7g', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-24jy7g



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-fd92sq',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-fd92sq



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-2wvs5', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-2wvs5



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'logoutuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-1bab2u',
      email: 'logoutuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-1bab2u



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-zqfbma', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-zqfbma



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-x7uo1', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-x7uo1



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-tihomo',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-tihomo



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'logoutuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-e3ksct',
      email: 'logoutuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-e3ksct



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:247:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-u2xng9', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-u2xng9



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-cie1up',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-cie1up



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-a72q4', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-a72q4



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'changepassuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-yzjjf5',
      email: 'changepassuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-yzjjf5



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-y4ork', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-y4ork



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-vlo73', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-vlo73



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-wk6rj8',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-wk6rj8



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'changepassuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-pmdza9',
      email: 'changepassuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-pmdza9



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-e08age', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-e08age



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-v5vkks',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-v5vkks



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-u70lk', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-u70lk



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'changepassuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:58)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-jhzwpc',
      email: 'changepassuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-jhzwpc



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:287:26)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-r8bum', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-r8bum



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-qdd5aq',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-qdd5aq



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-k56o2', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-k56o2



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'verifyuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-34y57',
      email: 'verifyuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-34y57



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-f7n7wi', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-f7n7wi



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-jz6ril',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-jz6ril



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-neiqv2',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-neiqv2



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'verifyuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-24ds7',
      email: 'verifyuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-24ds7



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-0tsign', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-0tsign



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-24dg3', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-24dg3



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-6kibw6',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-6kibw6



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'verifyuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-4xz3ma',
      email: 'verifyuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-4xz3ma



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:354:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-54j2l', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-54j2l



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-dc7x7b',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-dc7x7b



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-lyfshd',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-lyfshd



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'forgotuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-iy4xcn',
      email: 'forgotuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-iy4xcn



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'forgotuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-iy4xcn', email: 'forgotuser@example.com' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-dhvpp4', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-dhvpp4



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-khbkf', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-khbkf



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-69hcy', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-69hcy



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'forgotuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-yzo9qm',
      email: 'forgotuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-yzo9qm



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'nonexistent@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-95tg3', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-95tg3



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-zb098', email: 'admin@example.com', totalUsers: 2 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-zb098



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-eg62av',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-eg62av



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'forgotuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:45)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-2dtxs',
      email: 'forgotuser@example.com',
      totalUsers: 4
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-2dtxs



      at Function.create (src/services/userService.ts:3531:15)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:399:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'forgotuser@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-2dtxs', email: 'forgotuser@example.com' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at src/routes/auth.ts:3022:62
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-ng2cup', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-ng2cup



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-65d1bh',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-65d1bh



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-678npm',
      email: 'coach@example.com',
      totalUsers: 3
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-678npm



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:54)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:61)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-omg3u', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-omg3u



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:45:22)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'admin@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-3poddc',
      email: 'admin@example.com',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-3poddc



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:52:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'coach@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:55)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-fxu9w', email: 'coach@example.com', totalUsers: 3 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-fxu9w



      at Function.create (src/services/userService.ts:3531:15)
      at seedTestData (src/__tests__/helpers/database.helper.ts:59:23)
      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:22:20)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/auth/auth-routes.test.ts
  Authentication Routes
    POST /auth/register
      âœ• should register a new user successfully (31 ms)
      âœ• should return 400 for invalid email format (18 ms)
      âœ• should return 400 for weak password (27 ms)
      âœ• should return 400 for duplicate email (18 ms)
      âœ“ should enforce rate limiting (22 ms)
    POST /auth/login
      âœ• should login successfully with valid credentials (20 ms)
      âœ• should return 401 for invalid email (21 ms)
      âœ• should return 401 for invalid password (17 ms)
      âœ• should return 401 for inactive user (17 ms)
    POST /auth/refresh
      âœ• should refresh tokens successfully (16 ms)
      âœ• should return 401 for invalid refresh token (15 ms)
      âœ• should return 401 for revoked refresh token (19 ms)
    POST /auth/logout
      âœ• should logout successfully (20 ms)
      âœ• should return 401 without access token (19 ms)
    POST /auth/change-password
      âœ• should change password successfully (16 ms)
      âœ• should return 400 for invalid current password (16 ms)
      âœ• should return 400 for weak new password (19 ms)
    GET /auth/verify
      âœ• should verify valid token (17 ms)
      âœ• should return 401 for invalid token (14 ms)
      âœ• should return 401 without token (15 ms)
    POST /auth/forgot-password
      âœ“ should handle forgot password request (19 ms)
      âœ“ should return same response for non-existent email (16 ms)
      âœ“ should enforce rate limiting (25 ms)
    POST /auth/google
      âœ“ should return 400 for missing Google ID token (13 ms)
      âœ“ should return 400 for invalid Google ID token (425 ms)

  â— Authentication Routes â€º POST /auth/register â€º should register a new user successfully

    expected 201 "Created", got 500 "Internal Server Error"

      37 |       bio: 'Test user bio'
      38 |     };
    > 39 |
         | ^
      40 |     test('should register a new user successfully', async () => {
      41 |       const response = await request(app)
      42 |         .post('/auth/register')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:39:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for invalid email format

    expected 400 "Bad Request", got 500 "Internal Server Error"

      66 |       expect(user?.email).toBe(validRegistrationData.email);
      67 |     });
    > 68 |
         | ^
      69 |     test('should return 400 for invalid email format', async () => {
      70 |       const response = await request(app)
      71 |         .post('/auth/register')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:68:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for weak password

    expected 400 "Bad Request", got 500 "Internal Server Error"

      77 |
      78 |       expect(response.body.success).toBe(false);
    > 79 |       expect(response.body.message).toContain('Invalid email format');
         |                  ^
      80 |     });
      81 |
      82 |     test('should return 400 for weak password', async () => {

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:79:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for duplicate email

    expected 201 "Created", got 500 "Internal Server Error"

      86 |           ...validRegistrationData,
      87 |           password: '123'
    > 88 |         })
         |           ^
      89 |         .expect(400);
      90 |
      91 |       expect(response.body.success).toBe(false);

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:88:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should login successfully with valid credentials

    expected 200 "OK", got 429 "Too Many Requests"

      124 |       // At least one should be rate limited
      125 |       const rateLimitedResponse = responses.find(r => r.status === 429);
    > 126 |       expect(rateLimitedResponse).toBeTruthy();
          |                  ^
      127 |     });
      128 |   });
      129 |

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:126:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for invalid email

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      151 |         message: 'Login successful',
      152 |         data: {
    > 153 |           user: {
          |                  ^
      154 |             email: 'testuser@example.com',
      155 |             name: 'Test User'
      156 |           },

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:153:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for invalid password

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      162 |       });
      163 |
    > 164 |       // Verify refresh token was stored in Redis
          |                  ^
      165 |       const user = await UserService.findByEmail('testuser@example.com');
      166 |       const storedToken = await mockRedis.get(`refresh_token:${user?.id}`);
      167 |       expect(storedToken).toBe(response.body.data.tokens.refreshToken);

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:164:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for inactive user

    TypeError: userService_1.UserService.updateActiveStatus is not a function

      170 |     test('should return 401 for invalid email', async () => {
      171 |       const response = await request(app)
    > 172 |         .post('/auth/login')
          |                             ^
      173 |         .send({
      174 |           email: 'nonexistent@example.com',
      175 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:172:49)

  â— Authentication Routes â€º POST /auth/refresh â€º should refresh tokens successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/refresh â€º should return 401 for invalid refresh token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/refresh â€º should return 401 for revoked refresh token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/logout â€º should logout successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      257 |       expect(response.body.data.tokens.refreshToken).not.toBe(refreshToken);
      258 |     });
    > 259 |
          | ^
      260 |     test('should return 401 for invalid refresh token', async () => {
      261 |       const response = await request(app)
      262 |         .post('/auth/refresh')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:259:51)

  â— Authentication Routes â€º POST /auth/logout â€º should return 401 without access token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      257 |       expect(response.body.data.tokens.refreshToken).not.toBe(refreshToken);
      258 |     });
    > 259 |
          | ^
      260 |     test('should return 401 for invalid refresh token', async () => {
      261 |       const response = await request(app)
      262 |         .post('/auth/refresh')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:259:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should change password successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should return 400 for invalid current password

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should return 400 for weak new password

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º GET /auth/verify â€º should verify valid token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

  â— Authentication Routes â€º GET /auth/verify â€º should return 401 for invalid token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

  â— Authentication Routes â€º GET /auth/verify â€º should return 401 without token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/controllers/FinancialDashboardController.test.ts
  FinancialDashboardController
    getDashboardMetrics
      âœ“ should return dashboard metrics for admin users (5 ms)
      âœ• should deny access for non-admin users (4 ms)
      âœ• should handle service errors gracefully (4 ms)
    getRevenueMetrics
      âœ• should calculate revenue metrics for specified date range (4 ms)
      âœ• should use current month if no date range specified (4 ms)
      âœ• should handle null revenue values (4 ms)
    getSubscriptionMetrics
      âœ• should return subscription analytics (3 ms)
      âœ• should handle zero subscriptions (4 ms)
    getCostMetrics
      âœ• should retrieve and categorize costs (4 ms)
      âœ• should handle missing month parameter (7 ms)
    getProfitLossStatement
      âœ• should generate P&L statement for specified period (4 ms)
    createReport
      âœ• should create a new financial report (4 ms)
      âœ• should validate required fields (5 ms)
      âœ• should handle report generation errors (4 ms)
    downloadReport
      âœ• should export report in Excel format (4 ms)
      âœ• should export report in PDF format (3 ms)
      âœ• should handle report not found (3 ms)
    getRevenueForecast
      âœ• should generate revenue forecast (4 ms)
      âœ• should use default forecast period (5 ms)
    getCohortAnalysis
      âœ• should perform cohort analysis (5 ms)
    getUnitEconomics
      âœ• should calculate unit economics metrics (3 ms)
      âœ• should handle calculation errors (4 ms)
    getBillingEvents
      âœ• should retrieve billing events with pagination (8 ms)
      âœ• should filter by date range (4 ms)
    triggerAutomation
      âœ• should trigger financial automation task (4 ms)
      âœ• should validate automation task (4 ms)
    sendTestEmail
      âœ• should send test email to admin (4 ms)
      âœ• should handle email sending failure (4 ms)
    Role-based Access Control
      âœ“ should allow admin access to all endpoints (5 ms)
      âœ• should allow finance role access to financial data (4 ms)
      âœ• should deny regular user access to financial data (4 ms)
    Error Handling
      âœ• should handle ApiError with custom status code (4 ms)
      âœ• should handle database connection errors (4 ms)

  â— FinancialDashboardController â€º getDashboardMetrics â€º should deny access for non-admin users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      83 |       const mockMetrics = {
      84 |         revenue: 50000,
    > 85 |         expenses: 20000,
         |                         ^
      86 |         profit: 30000,
      87 |         mrr: 5000,
      88 |         arr: 60000,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:85:47)

  â— FinancialDashboardController â€º getDashboardMetrics â€º should handle service errors gracefully

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.getDashboardMetrics (src/controllers/financial/FinancialDashboardController.ts:20394:36)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:92:13)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should calculate revenue metrics for specified date range

    TypeError: Cannot read properties of undefined (reading 'sum')

      103 |     });
      104 |
    > 105 |     test('should deny access for non-admin users', async () => {
          |                                  ^
      106 |       mockRequest.user = { ...mockUser, role: 'user' };
      107 |
      108 |       await controller.getDashboardMetrics(

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:105:34)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should use current month if no date range specified

    TypeError: Cannot read properties of undefined (reading 'sum')

      120 |       (financialService.getDashboardMetrics as jest.Mock).mockRejectedValue(
      121 |         new Error('Database connection failed')
    > 122 |       );
          |         ^
      123 |
      124 |       await controller.getDashboardMetrics(
      125 |         mockRequest as Request,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:122:34)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should handle null revenue values

    TypeError: Cannot read properties of undefined (reading 'sum')

      132 |       });
      133 |     });
    > 134 |   });
          |      ^
      135 |
      136 |   describe('getRevenueMetrics', () => {
      137 |     test('should calculate revenue metrics for specified date range', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:134:34)

  â— FinancialDashboardController â€º getSubscriptionMetrics â€º should return subscription analytics

    TypeError: Cannot read properties of undefined (reading 'count')

      147 |       (financialService.calculateMRR as jest.Mock).mockResolvedValue(8000);
      148 |       (financialService.calculateARR as jest.Mock).mockResolvedValue(96000);
    > 149 |
          | ^
      150 |       await controller.getRevenueMetrics(
      151 |         mockRequest as Request,
      152 |         mockResponse as Response

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:149:35)

  â— FinancialDashboardController â€º getSubscriptionMetrics â€º should handle zero subscriptions

    TypeError: Cannot read properties of undefined (reading 'count')

      162 |       });
      163 |     });
    > 164 |
          | ^
      165 |     test('should use current month if no date range specified', async () => {
      166 |       mockRequest.query = {};
      167 |

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:164:35)

  â— FinancialDashboardController â€º getCostMetrics â€º should retrieve and categorize costs

    TypeError: Cannot read properties of undefined (reading 'findAll')

      181 |         }),
      182 |       });
    > 183 |     });
          |        ^
      184 |
      185 |     test('should handle null revenue values', async () => {
      186 |       (Transaction.sum as jest.Mock).mockResolvedValue(null);

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:183:35)

  â— FinancialDashboardController â€º getCostMetrics â€º should handle missing month parameter

    TypeError: Cannot read properties of undefined (reading 'findAll')

      193 |       );
      194 |
    > 195 |       expect(mockJson).toHaveBeenCalledWith({
          |                                   ^
      196 |         gross: 0,
      197 |         refunds: 0,
      198 |         net: 0,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:195:35)

  â— FinancialDashboardController â€º getProfitLossStatement â€º should generate P&L statement for specified period

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      207 |       (Subscription.count as jest.Mock)
      208 |         .mockResolvedValueOnce(150) // active
    > 209 |         .mockResolvedValueOnce(20) // new
          |                                          ^
      210 |         .mockResolvedValueOnce(5); // churned
      211 |
      212 |       (financialService.calculateChurnRate as jest.Mock).mockResolvedValue(3.33);

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:209:77)

  â— FinancialDashboardController â€º createReport â€º should create a new financial report

    TypeError: Cannot read properties of undefined (reading 'create')

      239 |         new: 0,
      240 |         churned: 0,
    > 241 |         churnRate: 0,
          |                      ^
      242 |       });
      243 |     });
      244 |   });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:241:38)

  â— FinancialDashboardController â€º createReport â€º should validate required fields

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.createReport (src/controllers/financial/FinancialDashboardController.ts:22040:37)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:256:30)

  â— FinancialDashboardController â€º createReport â€º should handle report generation errors

    TypeError: Cannot read properties of undefined (reading 'create')

      267 |       );
      268 |       expect(mockJson).toHaveBeenCalledWith(expect.objectContaining({
    > 269 |         total: 23000,
          |                      ^
      270 |         byCategory: expect.any(Object),
      271 |       }));
      272 |     });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:269:38)

  â— FinancialDashboardController â€º downloadReport â€º should export report in Excel format

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      287 |       }));
      288 |     });
    > 289 |   });
          |      ^
      290 |
      291 |   describe('getProfitLossStatement', () => {
      292 |     test('should generate P&L statement for specified period', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:289:38)

  â— FinancialDashboardController â€º downloadReport â€º should export report in PDF format

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      300 |         costs: 150000,
      301 |         grossProfit: 150000,
    > 302 |         operatingExpenses: 50000,
          |                                  ^
      303 |         netProfit: 100000,
      304 |         margin: 33.33,
      305 |       });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:302:38)

  â— FinancialDashboardController â€º downloadReport â€º should handle report not found

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      306 |
      307 |       await controller.getProfitLossStatement(
    > 308 |         mockRequest as Request,
          |                                ^
      309 |         mockResponse as Response
      310 |       );
      311 |

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:308:38)

  â— FinancialDashboardController â€º getRevenueForecast â€º should generate revenue forecast

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      317 |         revenue: 300000,
      318 |         netProfit: 100000,
    > 319 |         margin: 33.33,
          |                       ^
      320 |       }));
      321 |     });
      322 |   });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:319:73)

  â— FinancialDashboardController â€º getRevenueForecast â€º should use default forecast period

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      340 |
      341 |       (FinancialReport.create as jest.Mock).mockResolvedValue(mockReport);
    > 342 |
          | ^
      343 |       await controller.createReport(
      344 |         mockRequest as Request,
      345 |         mockResponse as Response

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:342:73)

  â— FinancialDashboardController â€º getCohortAnalysis â€º should perform cohort analysis

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      373 |       });
      374 |     });
    > 375 |
          | ^
      376 |     test('should handle report generation errors', async () => {
      377 |       mockRequest.body = {
      378 |         type: 'monthly',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:375:72)

  â— FinancialDashboardController â€º getUnitEconomics â€º should calculate unit economics metrics

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      390 |         mockResponse as Response
      391 |       );
    > 392 |
          | ^
      393 |       expect(mockStatus).toHaveBeenCalledWith(500);
      394 |       expect(mockJson).toHaveBeenCalledWith({
      395 |         error: 'Report generation failed',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:392:72)

  â— FinancialDashboardController â€º getUnitEconomics â€º should handle calculation errors

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      396 |       });
      397 |     });
    > 398 |   });
          |      ^
      399 |
      400 |   describe('downloadReport', () => {
      401 |     test('should export report in Excel format', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:398:72)

  â— FinancialDashboardController â€º getBillingEvents â€º should retrieve billing events with pagination

    TypeError: Cannot read properties of undefined (reading 'findAndCountAll')

      427 |
      428 |     test('should export report in PDF format', async () => {
    > 429 |       mockRequest.params = { id: 'report-123' };
          |                                   ^
      430 |       mockRequest.query = { format: 'pdf' };
      431 |
      432 |       const mockReport = {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:429:35)

  â— FinancialDashboardController â€º getBillingEvents â€º should filter by date range

    TypeError: Cannot read properties of undefined (reading 'findAndCountAll')

      452 |       mockRequest.params = { id: 'non-existent' };
      453 |
    > 454 |       (FinancialReport.findByPk as jest.Mock).mockResolvedValue(null);
          |                                   ^
      455 |
      456 |       await controller.downloadReport(
      457 |         mockRequest as Request,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:454:35)

  â— FinancialDashboardController â€º triggerAutomation â€º should trigger financial automation task

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      469 |     test('should generate revenue forecast', async () => {
      470 |       mockRequest.query = { months: '6' };
    > 471 |
          | ^
      472 |       (financialService.generateRevenueForecast as jest.Mock).mockResolvedValue({
      473 |         predictions: [
      474 |           { month: '2024-01', revenue: 10000 },

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:471:60)

  â— FinancialDashboardController â€º triggerAutomation â€º should validate automation task

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.triggerAutomation (src/controllers/financial/FinancialDashboardController.ts:24371:38)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:488:30)

  â— FinancialDashboardController â€º sendTestEmail â€º should send test email to admin

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      499 |     test('should use default forecast period', async () => {
      500 |       mockRequest.query = {};
    > 501 |
          | ^
      502 |       (financialService.generateRevenueForecast as jest.Mock).mockResolvedValue({
      503 |         predictions: [],
      504 |         confidence: 0,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:501:48)

  â— FinancialDashboardController â€º sendTestEmail â€º should handle email sending failure

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      515 |   });
      516 |
    > 517 |   describe('getCohortAnalysis', () => {
          |                                        ^
      518 |     test('should perform cohort analysis', async () => {
      519 |       mockRequest.query = {
      520 |         startMonth: '2024-01',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:517:48)

  â— FinancialDashboardController â€º Role-based Access Control â€º should allow finance role access to financial data

    TypeError: Cannot read properties of undefined (reading 'sum')

      533 |             month: '2024-02',
      534 |             users: 120,
    > 535 |             retention: [120, 108, 102],
          |                                  ^
      536 |             revenue: [12000, 10800, 10200],
      537 |           },
      538 |         ],

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:535:34)

  â— FinancialDashboardController â€º Role-based Access Control â€º should deny regular user access to financial data

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      543 |       (financialService.generateCohortAnalysis as jest.Mock).mockResolvedValue(mockCohortData);
      544 |
    > 545 |       await controller.getCohortAnalysis(
          |                                          ^
      546 |         mockRequest as Request,
      547 |         mockResponse as Response
      548 |       );

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:545:47)

  â— FinancialDashboardController â€º Error Handling â€º should handle ApiError with custom status code

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      550 |       expect(financialService.generateCohortAnalysis).toHaveBeenCalledWith(
      551 |         '2024-01',
    > 552 |         '2024-03'
          |                  ^
      553 |       );
      554 |       expect(mockJson).toHaveBeenCalledWith(mockCohortData);
      555 |     });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:552:73)

  â— FinancialDashboardController â€º Error Handling â€º should handle database connection errors

    TypeError: Cannot read properties of undefined (reading 'sum')

      558 |   describe('getUnitEconomics', () => {
      559 |     test('should calculate unit economics metrics', async () => {
    > 560 |       const mockUnitEconomics = {
          |                                  ^
      561 |         cac: 150, // Customer Acquisition Cost
      562 |         ltv: 1200, // Lifetime Value
      563 |         ltvCacRatio: 8,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:560:34)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/integration/payment-flow.test.ts
  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:21:41)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should handle payment failure gracefully

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should handle payment failure gracefully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process subscription.updated webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process subscription.updated webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.succeeded webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.succeeded webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.payment_failed webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.payment_failed webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process customer.subscription.deleted webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process customer.subscription.deleted webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should handle duplicate webhook events (idempotency)

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should handle duplicate webhook events (idempotency)

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should upgrade subscription to premium tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should upgrade subscription to premium tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should downgrade subscription to free tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should downgrade subscription to free tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription immediately

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription immediately

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription at period end

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription at period end

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should reactivate canceled subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should reactivate canceled subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should add new payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should add new payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should set payment method as default

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should set payment method as default

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should remove payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should remove payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should not allow removing default payment method with active subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should not allow removing default payment method with active subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve billing history

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve billing history

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve specific invoice

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve specific invoice

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should download invoice PDF

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should download invoice PDF

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Refund Processing â€º should process full refund

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Refund Processing â€º should process full refund

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Refund Processing â€º should process partial refund

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Refund Processing â€º should process partial refund

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should create subscription with trial period

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should create subscription with trial period

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should convert trial to paid subscription after trial ends

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should convert trial to paid subscription after trial ends

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should deny premium features for free tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should deny premium features for free tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should allow premium features for active subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should allow premium features for active subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should revoke access after subscription cancellation

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should revoke access after subscription cancellation

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should handle past_due subscription status

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should handle past_due subscription status

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should retry failed payment with new payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should retry failed payment with new payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      35 |     // Setup Stripe mock
      36 |     mockStripe = new Stripe('sk_test_mock') as jest.Mocked<Stripe>;
    > 37 |   });
         |      ^
      38 |
      39 |   afterAll(async () => {
      40 |     await sequelize.close();

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:37:34)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/e2e-critical/user-onboarding-journey.test.ts
  E2E Critical Journey: User Onboarding Flow
    Step 1: User Registration
      âœ• should successfully register a new user account (12 ms)
      âœ• should be able to retrieve current user profile (11 ms)
    Step 2: Create First Goal
      âœ• should successfully create first goal and unlock achievement (18 ms)
      âœ• should be able to retrieve the created goal (10 ms)
      âœ• should see goal in goals list (10 ms)
    Step 3: Book First Coaching Session
      âœ• should find available coaches (10 ms)
      âœ• should successfully book first coaching session (10 ms)
      âœ• should see booked session in upcoming sessions (8 ms)
    Journey Completion
      âœ• should have completed full onboarding journey (41 ms)

  â— E2E Critical Journey: User Onboarding Flow â€º Step 1: User Registration â€º should successfully register a new user account

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 1: User Registration â€º should be able to retrieve current user profile

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should successfully create first goal and unlock achievement

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should be able to retrieve the created goal

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should see goal in goals list

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should find available coaches

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should successfully book first coaching session

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should see booked session in upcoming sessions

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Journey Completion â€º should have completed full onboarding journey

    AggregateError:



  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-9sfhf',
      email: 'integration.test@upcoach.ai',
      totalUsers: 1
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-9sfhf



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-9sfhf' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-9sfhf' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-9sfhf' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-g2g0e',
      email: 'integration.test@upcoach.ai',
      totalUsers: 1
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-g2g0e



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-g2g0e' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-g2g0e' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-g2g0e' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-g2g0e', email: 'integration.test@upcoach.ai' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: {
      isValid: false,
      errors: [
        'Password must contain at least one uppercase letter',
        'Password must contain at least one special character'
      ]
    }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-x2y69m',
      email: 'integration.test@upcoach.ai',
      totalUsers: 1
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-x2y69m



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-x2y69m' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-x2y69m' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-x2y69m' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-x2y69m' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-x2y69m' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-x2y69m', email: 'integration.test@upcoach.ai' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-x2y69m' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2720:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-x2y69m' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2720:35

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-qs74r',
      email: 'integration.test@upcoach.ai',
      totalUsers: 1
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-qs74r



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-qs74r' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-qs74r' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-qs74r' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-qs74r' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-qs74r' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-qs74r', email: 'integration.test@upcoach.ai' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'integration.test@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'integration.test@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-6ymm1t',
      email: 'integration.test@upcoach.ai',
      totalUsers: 1
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-6ymm1t



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-6ymm1t' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-6ymm1t' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-6ymm1t' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-6ymm1t' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-6ymm1t' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at TestDataSeeder.verifyUser (src/tests/helpers/TestDataSeeder.ts:54:29)
      at Object.<anonymous> (src/tests/integration/api.test.ts:164:38)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'unverified@upcoach.ai' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Integration Test', email: 'unverified@upcoach.ai' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'unverified@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: {
      id: 'test-user-id-vc0den',
      email: 'unverified@upcoach.ai',
      totalUsers: 2
    }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-vc0den



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-vc0den' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-vc0den' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-vc0den' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'unverified@upcoach.ai' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne found match: { id: 'test-user-id-vc0den', email: 'unverified@upcoach.ai' }

      32 |           return record[key] === value || record[camelKey] === value;
      33 |         });
    > 34 |       });
         |          ^
      35 |
      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });

      at Object.findOne (src/services/__mocks__/database.ts:34:25)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.verifyPassword (src/services/userService.ts:3725:45)
      at src/routes/auth.ts:2674:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    === TEST ERROR ===



      at errorMiddleware (src/middleware/errorHandler.ts:3401:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    Status: 500



      at errorMiddleware (src/middleware/errorHandler.ts:3404:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    Message: Expected property name or '}' in JSON at position 2



      at errorMiddleware (src/middleware/errorHandler.ts:3407:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    Stack: SyntaxError: Expected property name or '}' in JSON at position 2
        at JSON.parse (<anonymous>)
        at parse (/Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/node_modules/body-parser/lib/types/json.js:92:19)
        at /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/node_modules/body-parser/lib/read.js:128:18
        at AsyncResource.runInAsyncScope (node:async_hooks:206:9)
        at invokeCallback (/Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/node_modules/raw-body/index.js:238:16)
        at done (/Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/node_modules/raw-body/index.js:227:7)
        at IncomingMessage.onEnd (/Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/node_modules/raw-body/index.js:287:7)
        at IncomingMessage.emit (node:events:524:28)
        at endReadableNT (node:internal/streams/readable:1698:12)
        at processTicksAndRejections (node:internal/process/task_queues:82:21)



      at errorMiddleware (src/middleware/errorHandler.ts:3410:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    Request: POST /api/v1/goals



      at errorMiddleware (src/middleware/errorHandler.ts:3413:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    Body: {}



      at errorMiddleware (src/middleware/errorHandler.ts:3416:15)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (../../node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (../../node_modules/express/lib/router/index.js:326:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:130:7
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/tests/integration/api.test.ts
  API Integration Tests
    Authentication Endpoints
      POST /auth/register
        âœ“ should register a new user successfully (24 ms)
        âœ“ should reject duplicate email registration (21 ms)
        âœ“ should validate required fields (13 ms)
        âœ“ should reject weak passwords (10 ms)
      POST /auth/login
        âœ“ should authenticate user with valid credentials (19 ms)
        âœ“ should reject invalid credentials (16 ms)
        âœ“ should reject login for unverified user (31 ms)
        âœ• should implement rate limiting (7 ms)
      POST /auth/logout
        âœ• should logout user successfully (7 ms)
      POST /auth/refresh-token
        âœ• should refresh valid token (6 ms)
      POST /auth/forgot-password
        âœ• should initiate password reset (6 ms)
        âœ• should handle non-existent email gracefully (6 ms)
    User Management Endpoints
      GET /user/profile
        âœ• should get user profile (4 ms)
        âœ• should require authentication (3 ms)
      PUT /user/profile
        âœ• should update user profile (4 ms)
        âœ• should validate update data (3 ms)
      POST /user/change-password
        âœ• should change password with valid credentials (4 ms)
        âœ• should reject incorrect current password (5 ms)
    Goals Management Endpoints
      POST /goals
        âœ• should create a new goal (6 ms)
        âœ• should validate goal data (6 ms)
      GET /goals
        âœ• should get all user goals (7 ms)
        âœ• should support pagination (5 ms)
        âœ• should support filtering (5 ms)
      GET /goals/:id
        âœ• should get specific goal (6 ms)
        âœ• should return 404 for non-existent goal (6 ms)
      PUT /goals/:id
        âœ• should update goal (6 ms)
        âœ• should validate progress range (6 ms)
      DELETE /goals/:id
        âœ• should delete goal (7 ms)
    Habits Management Endpoints
      POST /habits
        âœ• should create a new habit (8 ms)
      POST /habits/:id/check-in
        âœ• should record habit completion (6 ms)
        âœ• should update streak correctly (6 ms)
    File Upload Endpoints
      POST /upload/avatar
        âœ• should upload user avatar (7 ms)
        âœ• should validate file type (7 ms)
        âœ• should validate file size (9 ms)
    Real-time WebSocket Connections
      âœ• should establish WebSocket connection with authentication (9 ms)
      âœ• should reject unauthenticated WebSocket connections (7 ms)
    Error Handling and Edge Cases
      âœ• should handle malformed JSON (17 ms)
      âœ• should handle missing required headers (6 ms)
      âœ• should handle database connection errors gracefully (4 ms)
      âœ• should return appropriate CORS headers (6 ms)
      âœ• should handle concurrent requests safely (18 ms)
    Performance and Load Testing
      âœ• should handle multiple simultaneous requests (68 ms)
      âœ• should maintain response times under load (11 ms)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/login â€º should implement rate limiting

    TypeError: Cannot read properties of undefined (reading 'id')

      160 |           .expect(400);
      161 |
    > 162 |         expect(response.body.success).toBe(false);
          |                                                   ^
      163 |         expect(response.body.details.errors).toBeDefined();
      164 |         expect(response.body.error).toBe('Validation Error');
      165 |       });

      at Object.<anonymous> (src/tests/integration/api.test.ts:162:53)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/logout â€º should logout user successfully

    expected 200 "OK", got 401 "Unauthorized"

      239 |           email: 'unverified@upcoach.ai',
      240 |         };
    > 241 |
          | ^
      242 |         await request(app)
      243 |           .post(`${API_BASE_URL}/auth/register`)
      244 |           .send(unverifiedUser);

      at Object.<anonymous> (src/tests/integration/api.test.ts:241:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/refresh-token â€º should refresh valid token

    expected 200 "OK", got 404 "Not Found"

      257 |       it('should implement rate limiting', async () => {
      258 |         const maxAttempts = 5;
    > 259 |         const promises: Promise<unknown>[] = [];
          |                      ^
      260 |
      261 |         // Make multiple rapid login attempts
      262 |         for (let i = 0; i < maxAttempts + 2; i++) {

      at Object.<anonymous> (src/tests/integration/api.test.ts:259:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/forgot-password â€º should initiate password reset

    TypeError: Cannot read properties of undefined (reading 'id')

      267 |                 email: testUser.email,
      268 |                 password: 'WrongPassword123!',
    > 269 |               })
          |                 ^
      270 |           );
      271 |         }
      272 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:269:53)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/forgot-password â€º should handle non-existent email gracefully

    TypeError: Cannot read properties of undefined (reading 'id')

      267 |                 email: testUser.email,
      268 |                 password: 'WrongPassword123!',
    > 269 |               })
          |                 ^
      270 |           );
      271 |         }
      272 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:269:53)

  â— API Integration Tests â€º User Management Endpoints â€º GET /user/profile â€º should get user profile

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º GET /user/profile â€º should require authentication

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º PUT /user/profile â€º should update user profile

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º PUT /user/profile â€º should validate update data

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º POST /user/change-password â€º should change password with valid credentials

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º POST /user/change-password â€º should reject incorrect current password

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º Goals Management Endpoints â€º POST /goals â€º should create a new goal

    expected 201 "Created", got 404 "Not Found"

      398 |       });
      399 |
    > 400 |       it('should validate update data', async () => {
          |                      ^
      401 |         const invalidData = {
      402 |           email: 'invalid-email-format',
      403 |         };

      at Object.<anonymous> (src/tests/integration/api.test.ts:400:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Goals Management Endpoints â€º POST /goals â€º should validate goal data

    expected 400 "Bad Request", got 404 "Not Found"

      417 |         const passwordData = {
      418 |           currentPassword: testUser.password,
    > 419 |           newPassword: 'NewSecurePassword123!',
          |                      ^
      420 |           confirmPassword: 'NewSecurePassword123!',
      421 |         };
      422 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:419:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should get all user goals

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should support pagination

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should support filtering

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals/:id â€º should get specific goal

    TypeError: Cannot read properties of undefined (reading 'id')

      471 |   describe('Goals Management Endpoints', () => {
      472 |     beforeEach(async () => {
    > 473 |       authToken = await authHelper.getAuthToken(testUser);
          |                                             ^
      474 |     });
      475 |
      476 |     describe('POST /goals', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:473:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals/:id â€º should return 404 for non-existent goal

    TypeError: Cannot read properties of undefined (reading 'id')

      471 |   describe('Goals Management Endpoints', () => {
      472 |     beforeEach(async () => {
    > 473 |       authToken = await authHelper.getAuthToken(testUser);
          |                                             ^
      474 |     });
      475 |
      476 |     describe('POST /goals', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:473:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º PUT /goals/:id â€º should update goal

    TypeError: Cannot read properties of undefined (reading 'id')

      497 |           title: '', // Empty title
      498 |           category: 'invalid-category',
    > 499 |         };
          |           ^
      500 |
      501 |         const response = await request(app)
      502 |           .post(`${API_BASE_URL}/goals`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:499:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º PUT /goals/:id â€º should validate progress range

    TypeError: Cannot read properties of undefined (reading 'id')

      497 |           title: '', // Empty title
      498 |           category: 'invalid-category',
    > 499 |         };
          |           ^
      500 |
      501 |         const response = await request(app)
      502 |           .post(`${API_BASE_URL}/goals`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:499:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º DELETE /goals/:id â€º should delete goal

    TypeError: Cannot read properties of undefined (reading 'id')

      528 |       it('should get all user goals', async () => {
      529 |         const response = await request(app)
    > 530 |           .get(`${API_BASE_URL}/goals`)
          |                                        ^
      531 |           .set('Authorization', `Bearer ${authToken}`)
      532 |           .expect(200);
      533 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:530:45)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits â€º should create a new habit

    expected 201 "Created", got 404 "Not Found"

      553 |       it('should support filtering', async () => {
      554 |         const response = await request(app)
    > 555 |           .get(`${API_BASE_URL}/goals?category=development`)
          |                      ^
      556 |           .set('Authorization', `Bearer ${authToken}`)
      557 |           .expect(200);
      558 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:555:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits/:id/check-in â€º should record habit completion

    TypeError: Cannot read properties of undefined (reading 'id')

      569 |           .send(testGoal);
      570 |
    > 571 |         goalId = response.body.goal.id;
          |                                        ^
      572 |       });
      573 |
      574 |       it('should get specific goal', async () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:571:47)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits/:id/check-in â€º should update streak correctly

    TypeError: Cannot read properties of undefined (reading 'id')

      569 |           .send(testGoal);
      570 |
    > 571 |         goalId = response.body.goal.id;
          |                                        ^
      572 |       });
      573 |
      574 |       it('should get specific goal', async () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:571:47)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should upload user avatar

    expected 200 "OK", got 404 "Not Found"

      611 |         };
      612 |
    > 613 |         const response = await request(app)
          |                      ^
      614 |           .put(`${API_BASE_URL}/goals/${goalId}`)
      615 |           .set('Authorization', `Bearer ${authToken}`)
      616 |           .send(updateData)

      at Object.<anonymous> (src/tests/integration/api.test.ts:613:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should validate file type

    expected 400 "Bad Request", got 404 "Not Found"

      621 |
      622 |       it('should validate progress range', async () => {
    > 623 |         const invalidUpdate = { progress: 150 }; // Over 100%
          |                      ^
      624 |
      625 |         const response = await request(app)
      626 |           .put(`${API_BASE_URL}/goals/${goalId}`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:623:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should validate file size

    write ECONNRESET



  â— API Integration Tests â€º Real-time WebSocket Connections â€º should establish WebSocket connection with authentication

    Unexpected server response: 404

      at ClientRequest.<anonymous> (../../node_modules/ws/lib/websocket.js:913:7)

  â— API Integration Tests â€º Real-time WebSocket Connections â€º should reject unauthenticated WebSocket connections

    expect(received).toBe(expected) // Object.is equality

    Expected: 1008
    Received: 1006

      653 |           .get(`${API_BASE_URL}/goals/${goalId}`)
      654 |           .set('Authorization', `Bearer ${authToken}`)
    > 655 |           .expect(404);
          |                        ^
      656 |       });
      657 |     });
      658 |   });

      at WebSocket.<anonymous> (src/tests/integration/api.test.ts:655:45)
      at WebSocket.emitClose (../../node_modules/ws/lib/websocket.js:262:12)
      at emitErrorAndClose (../../node_modules/ws/lib/websocket.js:1042:13)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle malformed JSON

    expected 400 "Bad Request", got 500 "Internal Server Error"

      672 |
      673 |         expect(response.body.habit).toMatchObject({
    > 674 |           name: testHabit.name,
          |                  ^
      675 |           description: testHabit.description,
      676 |           category: testHabit.category,
      677 |           frequency: testHabit.frequency,

      at Object.<anonymous> (src/tests/integration/api.test.ts:674:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle missing required headers

    expected 401 "Unauthorized", got 404 "Not Found"

      679 |
      680 |         habitId = response.body.habit.id;
    > 681 |       });
          |          ^
      682 |     });
      683 |
      684 |     describe('POST /habits/:id/check-in', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:681:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle database connection errors gracefully

    TypeError: DatabaseService_1.DatabaseService.disconnect is not a function

      684 |     describe('POST /habits/:id/check-in', () => {
      685 |       beforeEach(async () => {
    > 686 |         const response = await request(app)
          |                                            ^
      687 |           .post(`${API_BASE_URL}/habits`)
      688 |           .set('Authorization', `Bearer ${authToken}`)
      689 |           .send(testHabit);

      at Object.<anonymous> (src/tests/integration/api.test.ts:686:53)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should return appropriate CORS headers

    expected 200 "OK", got 204 "No Content"

      696 |           completed: true,
      697 |           notes: 'Completed morning code review',
    > 698 |           quality: 8,
          |                  ^
      699 |         };
      700 |
      701 |         const response = await request(app)

      at Object.<anonymous> (src/tests/integration/api.test.ts:698:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle concurrent requests safely

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 0

      710 |
      711 |       it('should update streak correctly', async () => {
    > 712 |         // Complete habit for today
          |                                    ^
      713 |         await request(app)
      714 |           .post(`${API_BASE_URL}/habits/${habitId}/check-in`)
      715 |           .set('Authorization', `Bearer ${authToken}`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:712:47)

  â— API Integration Tests â€º Performance and Load Testing â€º should handle multiple simultaneous requests

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      727 |   });
      728 |
    > 729 |   describe('File Upload Endpoints', () => {
          |                                            ^
      730 |     beforeEach(async () => {
      731 |       authToken = await authHelper.getAuthToken(testUser);
      732 |     });

      at Object.<anonymous> (src/tests/integration/api.test.ts:729:73)

  â— API Integration Tests â€º Performance and Load Testing â€º should maintain response times under load

    expected 200 "OK", got 404 "Not Found"

      739 |           .post(`${API_BASE_URL}/upload/avatar`)
      740 |           .set('Authorization', `Bearer ${authToken}`)
    > 741 |           .attach('avatar', testImage, 'test-avatar.png')
          |                      ^
      742 |           .expect(200);
      743 |
      744 |         expect(response.body.success).toBe(true);

      at Object.<anonymous> (src/tests/integration/api.test.ts:741:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/integration/goal-management-flow.test.ts
  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:20:41)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should handle recurring goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should handle recurring goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should archive completed goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should archive completed goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should create goal with all optional fields

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should create goal with all optional fields

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate required fields

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate required fields

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate target date is in future

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate target date is in future

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate category from allowed list

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate category from allowed list

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should add progress update

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should add progress update

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should retrieve progress history

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should retrieve progress history

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should calculate progress trend

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should calculate progress trend

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should create milestone with correct order

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should create milestone with correct order

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should update milestone status

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should update milestone status

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should auto-update goal progress when milestones complete

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should auto-update goal progress when milestones complete

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should reorder milestones

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should reorder milestones

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI recommendations for goal

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI recommendations for goal

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI-suggested milestones

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI-suggested milestones

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get personalized goal insights

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get personalized goal insights

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award points for goal creation

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award points for goal creation

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award achievement for completing multiple goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award achievement for completing multiple goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should track goal completion streak

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should track goal completion streak

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should share goal with coach

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should share goal with coach

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should allow coach to provide feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should allow coach to provide feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should make goal public and visible to community

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should make goal public and visible to community

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should calculate comprehensive goal analytics

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should calculate comprehensive goal analytics

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should provide monthly progress report

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should provide monthly progress report

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      31 |   let testUser: any;
      32 |   let authToken: string;
    > 33 |   let coachUser: any;
         |                      ^
      34 |   let coachToken: string;
      35 |
      36 |   beforeAll(async () => {

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:33:34)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/e2e/complete-user-journeys.test.ts
  â— E2E: Complete User Journeys â€º Journey 1: New User Complete Onboarding to Premium Subscription â€º should complete full user journey from registration to premium subscription

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 1: New User Complete Onboarding to Premium Subscription â€º should complete full user journey from registration to premium subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 2: Coach Onboarding and Session Management â€º should complete full coach journey from registration to receiving payments

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 2: Coach Onboarding and Session Management â€º should complete full coach journey from registration to receiving payments

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 3: Cross-Service Integration - Goal â†’ AI â†’ Coaching â†’ Gamification â€º should validate integration between all major services

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 3: Cross-Service Integration - Goal â†’ AI â†’ Coaching â†’ Gamification â€º should validate integration between all major services

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle payment failure and retry successfully

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle payment failure and retry successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle session cancellation and rescheduling

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle session cancellation and rescheduling

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      75 |         name: 'Premium Member',
      76 |         description: 'Subscribed to premium',
    > 77 |         category: 'subscription',
         |                                  ^
      78 |         points: 200,
      79 |         icon: 'crown',
      80 |       },

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:77:34)

  â— Test suite failed to run

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:21:41)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/integration/coaching-session-flow.test.ts
  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should complete entire coaching session lifecycle successfully

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should complete entire coaching session lifecycle successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session cancellation by client

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session cancellation by client

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session rescheduling

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session rescheduling

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should search coaches by specialization

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should search coaches by specialization

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by minimum rating

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by minimum rating

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by price range

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by price range

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by language

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by language

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should sort coaches by rating

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should sort coaches by rating

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent double-booking the same time slot

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent double-booking the same time slot

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking outside coach availability

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking outside coach availability

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking in the past

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking in the past

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should require minimum advance booking time

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should require minimum advance booking time

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should submit valid feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should submit valid feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent duplicate feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent duplicate feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should validate rating range (1-5)

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should validate rating range (1-5)

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent feedback before session completion

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent feedback before session completion

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should calculate coach analytics correctly

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should calculate coach analytics correctly

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should retrieve session statistics by date range

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should retrieve session statistics by date range

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should track top-performing coaches

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should track top-performing coaches

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Notifications â€º should send reminder before session starts

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Notifications â€º should send reminder before session starts

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      31 |   });
      32 |
    > 33 |   afterAll(async () => {
         |                         ^
      34 |     await sequelize.close();
      35 |   });
      36 |

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:33:34)

  â— Test suite failed to run

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:19:41)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/GDPRService.test.ts
  GDPRService
    Singleton Pattern
      âœ• should return the same instance (4 ms)
    recordConsent
      âœ• should record user consent successfully (3 ms)
      âœ• should hash IP address for privacy (3 ms)
      âœ• should set expiration date for granted consent (4 ms)
      âœ• should not set expiration for revoked consent (4 ms)
      âœ• should handle database errors gracefully (3 ms)
    getConsentStatus
      âœ• should retrieve all consent statuses for a user (4 ms)
      âœ• should handle expired consent (6 ms)
      âœ• should default necessary consent to true (4 ms)
      âœ• should handle Redis errors gracefully (3 ms)
    requestDataPortability
      âœ• should create data portability request (5 ms)
      âœ• should process data export in background (4 ms)
      âœ• should support different export formats (3 ms)
      âœ• should set expiration for download links (3 ms)
    requestDeletion
      âœ• should create deletion request with grace period (4 ms)
      âœ• should prevent deletion if user not found (3 ms)
      âœ• should allow specifying data to retain (3 ms)
    cancelDeletion
      âœ• should cancel pending deletion request (4 ms)
      âœ• should not cancel if request not found (4 ms)
      âœ• should not cancel if user does not match (4 ms)
      âœ• should not cancel already completed deletions (3 ms)
    reportDataBreach
      âœ• should record data breach incident (4 ms)
      âœ• should handle critical breaches with urgency (4 ms)
      âœ• should track containment actions (6 ms)
    getDataRetentionPolicy
      âœ• should return data retention policy (4 ms)
      âœ• should include legal basis for retention (4 ms)
    runDataRetentionCleanup
      âœ• should clean up expired data (4 ms)
      âœ• should handle cleanup errors gracefully (3 ms)
      âœ• should respect retention periods (3 ms)
    generatePrivacyPolicyData
      âœ• should generate comprehensive privacy policy data (3 ms)
      âœ• should include all user rights (4 ms)
      âœ• should include security measures (4 ms)
    Edge Cases and Error Handling
      âœ• should handle concurrent consent updates (3 ms)
      âœ• should handle invalid consent purposes gracefully (4 ms)
      âœ• should validate user input in deletion requests (4 ms)
    Performance Considerations
      âœ• should batch operations where possible (3 ms)
      âœ• should use caching for frequently accessed data (3 ms)

  â— GDPRService â€º Singleton Pattern â€º should return the same instance

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should record user consent successfully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should hash IP address for privacy

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should set expiration date for granted consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should not set expiration for revoked consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should handle database errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should retrieve all consent statuses for a user

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should handle expired consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should default necessary consent to true

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should handle Redis errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should create data portability request

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should process data export in background

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should support different export formats

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should set expiration for download links

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should create deletion request with grace period

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should prevent deletion if user not found

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should allow specifying data to retain

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should cancel pending deletion request

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel if request not found

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel if user does not match

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel already completed deletions

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should record data breach incident

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should handle critical breaches with urgency

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should track containment actions

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getDataRetentionPolicy â€º should return data retention policy

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getDataRetentionPolicy â€º should include legal basis for retention

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should clean up expired data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should handle cleanup errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should respect retention periods

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should generate comprehensive privacy policy data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should include all user rights

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should include security measures

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should handle concurrent consent updates

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should handle invalid consent purposes gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should validate user input in deletion requests

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Performance Considerations â€º should batch operations where possible

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Performance Considerations â€º should use caching for frequently accessed data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/CoachIntelligenceService.test.ts
  â— CoachIntelligenceService â€º processCoachingSession â€º should process a coaching session and store memory

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      52 |     };
      53 |
    > 54 |     test('should process a coaching session and store memory', async () => {
         |                                       ^
      55 |       const mockAIResponse = {
      56 |         content: 'Great progress on your goals! Key insights: improved focus and consistency.',
      57 |       };

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:54:39)

  â— CoachIntelligenceService â€º processCoachingSession â€º should handle AI service errors gracefully

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      75 |             role: 'system',
      76 |             content: expect.stringContaining('extract insights'),
    > 77 |           }),
         |              ^
      78 |         ])
      79 |       );
      80 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:77:39)

  â— CoachIntelligenceService â€º processCoachingSession â€º should extract and store user feedback

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      86 |           avatarId: testAvatarId,
      87 |           contentType: 'conversation',
    > 88 |         })
         |           ^
      89 |       );
      90 |     });
      91 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:88:39)

  â— CoachIntelligenceService â€º getRelevantMemories â€º should retrieve relevant memories for a user

    TypeError: memory.updateRelevanceScore is not a function



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60346:14)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:108:28)

  â— CoachIntelligenceService â€º getRelevantMemories â€º should apply topic filtering when provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": ObjectContaining {Symbol(or): ArrayContaining [{"content": ObjectContaining {Symbol(iLike): "%specific topic%"}}, {"keyTopics": ObjectContaining {Symbol(contains): ["specific topic"]}}]}}
    Received: {"order": [["conversationDate", "DESC"]], "where": {"conversationDate": {Symbol(gte): 2025-08-17T06:45:59.504Z}, "userId": "user-123"}}

    Number of calls: 1

      126 |           sentiment: expect.any(Number),
      127 |         })
    > 128 |       );
          |         ^
      129 |     });
      130 |   });
      131 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:128:60)

  â— CoachIntelligenceService â€º generateCoachingRecommendations â€º should generate recommendations based on user history

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      156 |       expect(result[0]).toHaveProperty('relevance');
      157 |     });
    > 158 |
          | ^
      159 |     test('should handle empty memory results', async () => {
      160 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue([]);
      161 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:158:39)

  â— CoachIntelligenceService â€º generateCoachingRecommendations â€º should provide fallback recommendations on AI failure

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      182 |               { content: expect.objectContaining({ [Op.iLike]: '%specific topic%' }) },
      183 |               { keyTopics: expect.objectContaining({ [Op.contains]: ['specific topic'] }) },
    > 184 |             ]),
          |                ^
      185 |           }),
      186 |         })
      187 |       );

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:184:39)

  â— CoachIntelligenceService â€º generateWeeklyReport â€º should generate a comprehensive weekly report

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      224 |               implementation: ['Block calendar', 'Set timers'],
      225 |             },
    > 226 |           ],
          |             ^
      227 |         }),
      228 |       });
      229 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:226:39)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should calculate comprehensive user analytics

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:290:28)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should handle missing analytics record

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))



      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60842:5)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:311:28)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should calculate correct engagement metrics

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:331:28)

  â— CoachIntelligenceService â€º Error Handling â€º should handle database errors gracefully

    Database connection failed

      358 |       const mockGoals = [
      359 |         { id: '1', progress: 80, status: 'in_progress' },
    > 360 |         { id: '2', progress: 100, status: 'completed' },
          |                                                         ^
      361 |       ];
      362 |
      363 |       const mockAnalytics = {

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:360:77)

  â— CoachIntelligenceService â€º Error Handling â€º should handle invalid JSON from AI service

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      365 |         save: jest.fn(),
      366 |       };
    > 367 |
          | ^
      368 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue(mockMemories);
      369 |       mockKpiTracker.findAll = jest.fn().mockResolvedValue(mockGoals);
      370 |       mockUserAnalytics.findOne = jest.fn().mockResolvedValue(mockAnalytics);

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:367:39)

  â— CoachIntelligenceService â€º Error Handling â€º should handle null or undefined inputs

    TypeError: allMemories is not iterable



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60343:26)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:375:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should calculate mood trends accurately

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:390:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should identify achievement patterns

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:411:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should identify challenge areas

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:433:28)

  â— CoachIntelligenceService â€º Recommendation Generation â€º should prioritize recommendations based on user needs

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      446 |       ];
      447 |
    > 448 |       // Test via public method that uses private calculateStreakCount
          |                                       ^
      449 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue(memories);
      450 |       mockKpiTracker.findAll = jest.fn().mockResolvedValue([]);
      451 |       mockUserAnalytics.findOne = jest.fn().mockResolvedValue({

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:448:39)

  â— CoachIntelligenceService â€º Recommendation Generation â€º should generate schedule recommendations based on patterns

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:66483:59
          at Array.map (<anonymous>)
      at CoachIntelligenceService.analyzeEmotionalPatterns (src/services/coaching/CoachIntelligenceService.ts:66475:49)
      at CoachIntelligenceService.generateCoachingRecommendations (src/services/coaching/CoachIntelligenceService.ts:60529:37)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:475:37)

  â— CoachIntelligenceService â€º Performance Optimizations â€º should batch database queries efficiently

    TypeError: Cannot read properties of undefined (reading 'length')



      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60614:37)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:482:13)

  â— CoachIntelligenceService â€º Performance Optimizations â€º should cache frequently accessed data

    TypeError: allMemories is not iterable



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60343:26)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:489:13)


  â— Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/WebAuthnService.test.ts
  WebAuthnService
    getInstance
      âœ“ should return singleton instance (5 ms)
    configure
      âœ“ should update configuration settings (5 ms)
      âœ“ should merge partial configuration (8 ms)
    generateRegistrationOptions
      âœ• should generate registration options for new credential (4 ms)
      âœ• should exclude existing credentials (4 ms)
      âœ• should store challenge in Redis (3 ms)
      âœ“ should handle errors gracefully (4 ms)
    verifyRegistrationResponse
      âœ• should verify valid registration response (4 ms)
      âœ• should reject invalid challenge (5 ms)
      âœ• should reject expired challenge (5 ms)
      âœ• should store credential after successful verification (4 ms)
      âœ“ should delete challenge after verification (4 ms)
    generateAuthenticationOptions
      âœ• should generate authentication options (4 ms)
      âœ• should work without user ID (discoverable credentials) (3 ms)
      âœ• should store authentication challenge (6 ms)
    verifyAuthenticationResponse
      âœ• should verify valid authentication response (4 ms)
      âœ• should update counter after successful authentication (4 ms)
      âœ• should reject if credential not found (5 ms)
      âœ• should update lastUsedAt timestamp (5 ms)
    getUserCredentials
      âœ“ should retrieve user credentials from Redis (4 ms)
      âœ“ should return empty array if no credentials (3 ms)
      âœ“ should handle Redis errors gracefully (5 ms)
    deleteCredential
      âœ“ should delete specific credential (4 ms)
      âœ• should handle credential not found (5 ms)
    Rate Limiting
      âœ• should rate limit registration attempts (5 ms)
      âœ• should rate limit authentication attempts (5 ms)
      âœ• should allow requests within rate limit (4 ms)
    Security Features
      âœ“ should validate origin during verification (5 ms)
      âœ“ should enforce user verification when required (6 ms)
      âœ• should prevent credential ID reuse (5 ms)

  â— WebAuthnService â€º generateRegistrationOptions â€º should generate registration options for new credential

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:101:28)

  â— WebAuthnService â€º generateRegistrationOptions â€º should exclude existing credentials

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:128:13)

  â— WebAuthnService â€º generateRegistrationOptions â€º should store challenge in Redis

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:149:13)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should verify valid registration response

    Failed to store credential



      at WebAuthnService.storeCredential (src/services/WebAuthnService.ts:3797:13)
      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3442:9)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:188:28)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should reject invalid challenge

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid or expired challenge"
    Received message:   "Registration challenge not found or expired"

      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3380:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:206:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:206:148)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should reject expired challenge

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid or expired challenge"
    Received message:   "Registration challenge not found or expired"

      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3380:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:225:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:225:142)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should store credential after successful verification

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "webauthn:credentials:user123", StringContaining "test-credential-id-123"
    Received
           1: "webauthn:credentials:user123", "[{\"credentialID\":\"dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==\",\"credentialPublicKey\":\"cHVibGljLWtleQ==\",\"counter\":0,\"userId\":\"user123\",\"name\":\"test-challenge-abc123\",\"createdAt\":\"2025-11-15T06:46:00.024Z\",\"backedUp\":false,\"deviceType\":\"unknown\"}]"
           2: "webauthn:credential:dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==", "{\"credentialID\":\"dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==\",\"credentialPublicKey\":\"cHVibGljLWtleQ==\",\"counter\":0,\"userId\":\"user123\",\"name\":\"test-challenge-abc123\",\"createdAt\":\"2025-11-15T06:46:00.024Z\",\"backedUp\":false,\"deviceType\":\"unknown\"}"

    Number of calls: 2

      254 |       mockRedis.get.mockResolvedValue(
      255 |         JSON.stringify({
    > 256 |           challenge: testChallenge,
          |                                    ^
      257 |           userId: testUserId,
      258 |           type: 'registration',
      259 |         })

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:256:50)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should generate authentication options

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:308:28)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should work without user ID (discoverable credentials)

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:328:28)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should store authentication challenge

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:338:13)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should verify valid authentication response

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |     test('should delete challenge after verification', async () => {
    > 375 |       const registrationResponse: RegistrationResponseJSON = {
          |                                                    ^
      376 |         id: testCredentialId,
      377 |         rawId: testCredentialId,
      378 |         response: {

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:375:52)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should update counter after successful authentication

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "webauthn:credentials:user123", StringContaining "\"counter\":10"

    Number of calls: 0

      410 |     });
      411 |   });
    > 412 |
          | ^
      413 |   describe('generateAuthenticationOptions', () => {
      414 |     test('should generate authentication options', async () => {
      415 |       const existingCredentials = [

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:412:50)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should reject if credential not found

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"verified": false}

      428 |         timeout: 60000,
      429 |         userVerification: 'preferred',
    > 430 |         rpId: 'test.upcoach.ai',
          |                                 ^
      431 |         allowCredentials: [{
      432 |           id: Buffer.from(testCredentialId).toString('base64'),
      433 |           type: 'public-key',

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:430:40)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should update lastUsedAt timestamp

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, StringContaining "\"lastUsedAt\""

    Number of calls: 0

      461 |         rpId: 'test.upcoach.ai',
      462 |       };
    > 463 |
          | ^
      464 |       mockGenerateAuthenticationOptions.mockResolvedValue(mockOptions);
      465 |
      466 |       const result = await webAuthnService.generateAuthenticationOptions();

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:463:50)

  â— WebAuthnService â€º deleteCredential â€º should handle credential not found

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: undefined

      514 |           challenge: testChallenge,
      515 |           type: 'authentication',
    > 516 |         })
          |           ^
      517 |       );
      518 |       mockRedis.get.mockResolvedValueOnce(JSON.stringify([storedCredential]));
      519 |

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:516:40)

  â— WebAuthnService â€º Rate Limiting â€º should rate limit registration attempts

    expect(received).rejects.toThrow(expected)

    Expected substring: "Too many registration attempts"
    Received message:   "Failed to generate registration options"

      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:524:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:524:141)

  â— WebAuthnService â€º Rate Limiting â€º should rate limit authentication attempts

    expect(received).rejects.toThrow(expected)

    Expected substring: "Too many authentication attempts"
    Received message:   "Failed to generate authentication options"

      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:530:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:530:108)

  â— WebAuthnService â€º Rate Limiting â€º should allow requests within rate limit

    expect(received).resolves.toBeDefined()

    Received promise rejected instead of resolved
    Rejected to value: [Error: Failed to generate registration options]

      534 |       );
      535 |
    > 536 |       expect(result.verified).toBe(true);
          |                                        ^
      537 |       expect(result.credential).toEqual(
      538 |         expect.objectContaining({
      539 |           credentialID: testCredentialId,

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:536:40)

  â— WebAuthnService â€º Security Features â€º should prevent credential ID reuse

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"credentialId": "dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==", "verified": true}

      599 |           authenticatorData: 'authenticator-data',
      600 |           signature: 'signature',
    > 601 |         },
          |           ^
      602 |         type: 'public-key',
      603 |       };
      604 |

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:601:40)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/AIService.test.ts
  AIService
    generateResponse
      âœ• should generate response using OpenAI by default (7 ms)
      âœ• should generate response using Claude when specified (4 ms)
      âœ• should use cache when useCache option is enabled (4 ms)
      âœ• should handle prompt injection detection (6 ms)
      âœ• should handle API errors gracefully (9 ms)
      âœ• should apply custom temperature and maxTokens (4 ms)
    generateStreamResponse
      âœ• should generate streaming response (5 ms)
    validateApiKeys
      âœ• should validate API keys successfully (4 ms)
      âœ• should handle invalid API keys (5 ms)
    getUsageStats
      âœ• should return usage statistics (4 ms)
    clearCache
      âœ• should clear AI service cache (4 ms)
    healthCheck
      âœ• should perform health check (4 ms)
      âœ• should detect unhealthy services (4 ms)

  â— AIService â€º generateResponse â€º should generate response using OpenAI by default

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:78:28)

  â— AIService â€º generateResponse â€º should generate response using Claude when specified

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:126:28)

  â— AIService â€º generateResponse â€º should use cache when useCache option is enabled

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:166:28)

  â— AIService â€º generateResponse â€º should handle prompt injection detection

    expect(received).rejects.toThrow(expected)

    Expected substring: "Input validation failed: Potential prompt injection detected"
    Received message:   "Cannot read properties of undefined (reading 'message')"

      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:180:13)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:180:87)

  â— AIService â€º generateResponse â€º should handle API errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "AI service error: API Error"
    Received message:   "Cannot read properties of undefined (reading 'message')"

      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:188:13)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:188:87)

  â— AIService â€º generateResponse â€º should apply custom temperature and maxTokens

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:215:13)

  â— AIService â€º generateStreamResponse â€º should generate streaming response

    TypeError: aiService.generateStreamResponse is not a function

      249 |       ];
      250 |
    > 251 |       const options: AIOptions = {
          |                                   ^
      252 |         temperature: 0.9,
      253 |         maxTokens: 1000,
      254 |       };

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:251:44)

  â— AIService â€º validateApiKeys â€º should validate API keys successfully

    TypeError: aiService.validateApiKeys is not a function

      265 |   });
      266 |
    > 267 |   describe('generateStreamResponse', () => {
          |                                            ^
      268 |     test('should generate streaming response', async () => {
      269 |       const mockStream = {
      270 |         [Symbol.asyncIterator]: async function* () {

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:267:44)

  â— AIService â€º validateApiKeys â€º should handle invalid API keys

    TypeError: aiService.validateApiKeys is not a function

      273 |               delta: {
      274 |                 content: 'Hello',
    > 275 |               },
          |                 ^
      276 |             }],
      277 |           };
      278 |           yield {

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:275:44)

  â— AIService â€º getUsageStats â€º should return usage statistics

    TypeError: aiService.getUsageStats is not a function

      282 |               },
      283 |             }],
    > 284 |           };
          |             ^
      285 |         },
      286 |       };
      287 |

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:284:43)

  â— AIService â€º clearCache â€º should clear AI service cache

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).invalidate is not a function



      at AIService.clearCache (src/services/ai/AIService.ts:5484:56)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:293:29)

  â— AIService â€º healthCheck â€º should perform health check

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).getStats is not a function



      at AIService.healthCheck (src/services/ai/AIService.ts:5543:78)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:302:44)

  â— AIService â€º healthCheck â€º should detect unhealthy services

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).getStats is not a function



      at AIService.healthCheck (src/services/ai/AIService.ts:5543:78)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:315:44)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/middleware/auth.test.ts
  Auth Middleware
    generateTokens
      âœ• should generate valid access and refresh tokens (6 ms)
      âœ• should include IP and user agent in token metadata (4 ms)
    verifyRefreshToken
      âœ• should verify valid refresh token (4 ms)
      âœ“ should throw error for invalid refresh token (4 ms)
      âœ“ should throw error for access token used as refresh token (4 ms)
    blacklistToken
      âœ• should blacklist token in Redis (3 ms)
      âœ• should set appropriate TTL for blacklisted token (5 ms)
    authMiddleware
      âœ• should authenticate valid token (5 ms)
      âœ• should reject missing authorization header (7 ms)
      âœ• should reject malformed authorization header (4 ms)
      âœ• should reject invalid token (5 ms)
      âœ• should reject blacklisted token (4 ms)
      âœ• should reject refresh token used as access token (5 ms)
      âœ• should handle expired token gracefully (4 ms)
      âœ• should handle Redis connection errors gracefully (5 ms)
    Token Security
      âœ• should use different secrets for access and refresh tokens (5 ms)
      âœ• should include unique jti in tokens (5 ms)
      âœ“ should validate token expiration correctly (7 ms)

  â— Auth Middleware â€º generateTokens â€º should generate valid access and refresh tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: "test@example.com"
    Received: undefined

      40 |       });
      41 |
    > 42 |       const tokens = generateTokens(userId, email, role, req);
         |                                                        ^
      43 |
      44 |       expect(tokens).toHaveProperty('accessToken');
      45 |       expect(tokens).toHaveProperty('refreshToken');

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:42:56)

  â— Auth Middleware â€º generateTokens â€º should include IP and user agent in token metadata

    expect(received).toBe(expected) // Object.is equality

    Expected: "192.168.1.1"
    Received: undefined

      55 |
      56 |       // Verify refresh token payload
    > 57 |       const refreshPayload = jwt.verify(tokens.refreshToken, 'test-refresh-secret') as unknown;
         |                                                     ^
      58 |       expect(refreshPayload.userId).toBe(userId);
      59 |       expect(refreshPayload.type).toBe('refresh');
      60 |     });

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:57:53)

  â— Auth Middleware â€º verifyRefreshToken â€º should verify valid refresh token

    Invalid refresh token



      at verifyRefreshToken (src/middleware/auth.ts:3439:11)
      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:66:58)

  â— Auth Middleware â€º blacklistToken â€º should blacklist token in Redis

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      86 |
      87 |     test('should throw error for invalid refresh token', () => {
    > 88 |       expect(() => {
         |                     ^
      89 |         verifyRefreshToken('invalid-token');
      90 |       }).toThrow();
      91 |     });

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:88:48)

  â— Auth Middleware â€º blacklistToken â€º should set appropriate TTL for blacklisted token

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   -2

      93 |     test('should throw error for access token used as refresh token', () => {
      94 |       const req = createMockRequest();
    > 95 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', req);
         |                                        ^
      96 |
      97 |       expect(() => {
      98 |         verifyRefreshToken(tokens.accessToken);

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:95:40)

  â— Auth Middleware â€º authMiddleware â€º should authenticate valid token

    expect(received).toEqual(expected) // deep equality

    Expected: {"email": "test@example.com", "id": "test-user-id", "role": "user"}
    Received: null

      115 |       const req = createMockRequest();
      116 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', req);
    > 117 |
          | ^
      118 |       await blacklistToken(tokens.accessToken);
      119 |
      120 |       const ttl = await mockRedis.ttl(`blacklist:${tokens.accessToken}`);

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:117:45)

  â— Auth Middleware â€º authMiddleware â€º should reject missing authorization header

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Access token required",
    +   "error": "Authentication required",
        "success": false,
      },

    Number of calls: 1

      125 |   describe('authMiddleware', () => {
      126 |     let req: AuthenticatedRequest;
    > 127 |     let res: Response;
          |                       ^
      128 |     let next: NextFunction;
      129 |
      130 |     beforeEach(() => {

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:127:45)

  â— Auth Middleware â€º authMiddleware â€º should reject malformed authorization header

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid token format",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      137 |       const userId = 'test-user-id';
      138 |       const email = 'test@example.com';
    > 139 |       const role = 'user';
          |                           ^
      140 |       const mockReq = createMockRequest();
      141 |       const tokens = generateTokens(userId, email, role, mockReq);
      142 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:139:45)

  â— Auth Middleware â€º authMiddleware â€º should reject invalid token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      149 |       expect(req.user).toEqual({
      150 |         id: userId,
    > 151 |         email: email,
          |                      ^
      152 |         role: role
      153 |       });
      154 |       expect(next).toHaveBeenCalledWith();

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:151:45)

  â— Auth Middleware â€º authMiddleware â€º should reject blacklisted token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Token has been revoked",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      166 |     });
      167 |
    > 168 |     test('should reject malformed authorization header', async () => {
          |                                             ^
      169 |       req.headers = {
      170 |         authorization: 'Invalid format'
      171 |       };

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:168:45)

  â— Auth Middleware â€º authMiddleware â€º should reject refresh token used as access token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid token type",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      180 |       expect(next).not.toHaveBeenCalled();
      181 |     });
    > 182 |
          | ^
      183 |     test('should reject invalid token', async () => {
      184 |       req.headers = {
      185 |         authorization: 'Bearer invalid-token'

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:182:45)

  â— Auth Middleware â€º authMiddleware â€º should handle expired token gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      200 |       const mockReq = createMockRequest();
      201 |       const tokens = generateTokens(userId, 'test@example.com', 'user', mockReq);
    > 202 |
          | ^
      203 |       // Blacklist the token
      204 |       await blacklistToken(tokens.accessToken);
      205 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:202:45)

  â— Auth Middleware â€º authMiddleware â€º should handle Redis connection errors gracefully

    expect(received).toEqual(expected) // deep equality

    Expected: {"email": "test@example.com", "id": "test-user-id", "role": "user"}
    Received: null

      218 |     });
      219 |
    > 220 |     test('should reject refresh token used as access token', async () => {
          |                                             ^
      221 |       const mockReq = createMockRequest();
      222 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', mockReq);
      223 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:220:45)

  â— Auth Middleware â€º Token Security â€º should use different secrets for access and refresh tokens

    expect(received).toThrow()

    Received function did not throw

      235 |       expect(next).not.toHaveBeenCalled();
      236 |     });
    > 237 |
          | ^
      238 |     test('should handle expired token gracefully', async () => {
      239 |       // Create expired token
      240 |       const expiredToken = jwt.sign(

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:237:16)

  â— Auth Middleware â€º Token Security â€º should include unique jti in tokens

    expect(received).toBeDefined()

    Received: undefined

      247 |         'test-jwt-secret',
      248 |         { expiresIn: '-1s' } // Already expired
    > 249 |       );
          |         ^
      250 |
      251 |       req.headers = {
      252 |         authorization: `Bearer ${expiredToken}`

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:249:49)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/TwoFactorAuthService.test.ts
  â— TwoFactorAuthService â€º generateSecret â€º should generate a new 2FA secret successfully

    Failed to save 2FA secret



      at TwoFactorAuthService.generateSecret (src/services/TwoFactorAuthService.ts:12247:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:51:28)

  â— TwoFactorAuthService â€º generateSecret â€º should handle QR code generation failure

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate QR code"
    Received message:   "Failed to save 2FA secret"

      at TwoFactorAuthService.generateSecret (src/services/TwoFactorAuthService.ts:12247:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:80:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:81:26)

  â— TwoFactorAuthService â€º Error handling â€º should handle Redis connection errors gracefully

    Redis connection failed

      302 |
      303 |       const result = await twoFactorService.generateBackupCodes(testUserId);
    > 304 |
          | ^
      305 |       expect(result).toHaveLength(10);
      306 |       expect(result.every(code => typeof code === 'string' && code.length === 8)).toBe(true);
      307 |       expect(mockUserInstance.update).toHaveBeenCalledWith({

      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:304:69)


  â— Test suite failed to run

    2FA is not enabled



      at TwoFactorAuthService.generateBackupCodes (src/services/TwoFactorAuthService.ts:12625:13)

  â— Test suite failed to run

    2FA is not enabled



      at TwoFactorAuthService.generateBackupCodes (src/services/TwoFactorAuthService.ts:12625:13)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/RedisService.test.ts
  RedisService
    Connection Management
      âœ• should connect to Redis successfully (5 ms)
      âœ• should handle connection errors (3 ms)
      âœ• should disconnect from Redis (3 ms)
      âœ• should check if Redis is ready (4 ms)
    Basic Operations
      âœ• should get value by key (5 ms)
      âœ• should set key-value pair (4 ms)
      âœ• should set key-value pair with expiration (7 ms)
      âœ• should delete key (5 ms)
      âœ• should check if key exists (4 ms)
      âœ• should set expiration for key (4 ms)
      âœ• should get TTL for key (4 ms)
    Advanced Operations
      âœ• should get multiple keys (4 ms)
      âœ• should set multiple key-value pairs (4 ms)
      âœ• should increment counter (4 ms)
      âœ• should decrement counter (3 ms)
    Hash Operations
      âœ• should get hash field (6 ms)
      âœ• should set hash field (4 ms)
      âœ• should get all hash fields (4 ms)
      âœ• should delete hash field (4 ms)
    List Operations
      âœ• should push to left of list (6 ms)
      âœ• should push to right of list (3 ms)
      âœ• should pop from left of list (3 ms)
      âœ• should get range from list (5 ms)
    Set Operations
      âœ• should add to set (5 ms)
      âœ• should remove from set (3 ms)
      âœ• should get all set members (4 ms)
    Utility Operations
      âœ• should get keys matching pattern (6 ms)
      âœ• should flush database (4 ms)
      âœ• should ping Redis (3 ms)
    Health Check
      âœ• should perform health check successfully (3 ms)
      âœ• should detect unhealthy Redis (5 ms)
    Error Handling
      âœ• should handle Redis errors gracefully (3 ms)
      âœ• should handle connection timeout (4 ms)

  â— RedisService â€º Connection Management â€º should connect to Redis successfully

    expect(received).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      26 |   });
      27 |
    > 28 |   describe('Connection Management', () => {
         |                                            ^
      29 |     test('should connect to Redis successfully', async () => {
      30 |       mockRedisClient.connect.mockResolvedValue(undefined);
      31 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:28:60)

  â— RedisService â€º Connection Management â€º should handle connection errors

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      31 |
      32 |       await redisService.connect();
    > 33 |
         | ^
      34 |       expect(mockRedisClient.connect).toHaveBeenCalled();
      35 |     });
      36 |

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:33:76)

  â— RedisService â€º Connection Management â€º should disconnect from Redis

    expect(received).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      37 |     test('should handle connection errors', async () => {
      38 |       const connectionError = new Error('Connection failed');
    > 39 |       mockRedisClient.connect.mockRejectedValue(connectionError);
         |                                                               ^
      40 |
      41 |       await expect(redisService.connect()).rejects.toThrow('Connection failed');
      42 |       expect(mockRedisClient.connect).toHaveBeenCalled();

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:39:63)

  â— RedisService â€º Connection Management â€º should check if Redis is ready

    TypeError: redis_1.default.isReady is not a function

      40 |
      41 |       await expect(redisService.connect()).rejects.toThrow('Connection failed');
    > 42 |       expect(mockRedisClient.connect).toHaveBeenCalled();
         |                                             ^
      43 |     });
      44 |
      45 |     test('should disconnect from Redis', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:42:45)

  â— RedisService â€º Basic Operations â€º should get value by key

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-value"
    Received: undefined

      50 |       expect(mockRedisClient.disconnect).toHaveBeenCalled();
      51 |     });
    > 52 |
         | ^
      53 |     test('should check if Redis is ready', () => {
      54 |       const isReady = redisService.isReady();
      55 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:52:43)

  â— RedisService â€º Basic Operations â€º should set key-value pair

    expect(received).toHaveBeenCalledWith(...expected)

    Expected: "test-key", "test-value"

    Number of calls: 0

      58 |   });
      59 |
    > 60 |   describe('Basic Operations', () => {
         |                                       ^
      61 |     test('should get value by key', async () => {
      62 |       const key = 'test-key';
      63 |       const expectedValue = 'test-value';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:60:56)

  â— RedisService â€º Basic Operations â€º should set key-value pair with expiration

    expect(received).toHaveBeenCalledWith(...expected)

    Expected: "test-key", 3600, "test-value"

    Number of calls: 0

      66 |       const result = await redisService.get(key);
      67 |
    > 68 |       expect(result).toBe(expectedValue);
         |                                          ^
      69 |       expect(mockRedisClient.get).toHaveBeenCalledWith(key);
      70 |     });
      71 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:68:58)

  â— RedisService â€º Basic Operations â€º should delete key

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      72 |     test('should set key-value pair', async () => {
      73 |       const key = 'test-key';
    > 74 |       const value = 'test-value';
         |                                  ^
      75 |       mockRedisClient.set.mockResolvedValue('OK');
      76 |
      77 |       await redisService.set(key, value);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:74:43)

  â— RedisService â€º Basic Operations â€º should check if key exists

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      79 |       expect(mockRedisClient.set).toHaveBeenCalledWith(key, value);
      80 |     });
    > 81 |
         | ^
      82 |     test('should set key-value pair with expiration', async () => {
      83 |       const key = 'test-key';
      84 |       const value = 'test-value';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:81:43)

  â— RedisService â€º Basic Operations â€º should set expiration for key

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      87 |
      88 |       await redisService.set(key, value, ttl);
    > 89 |
         | ^
      90 |       expect(mockRedisClient.setEx).toHaveBeenCalledWith(key, ttl, value);
      91 |     });
      92 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:89:43)

  â— RedisService â€º Basic Operations â€º should get TTL for key

    expect(received).toBe(expected) // Object.is equality

    Expected: 3600
    Received: undefined

       95 |       mockRedisClient.del.mockResolvedValue(1);
       96 |
    >  97 |       const result = await redisService.del(key);
          |                                           ^
       98 |
       99 |       expect(result).toBe(1);
      100 |       expect(mockRedisClient.del).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:97:43)

  â— RedisService â€º Advanced Operations â€º should get multiple keys

    TypeError: redis_1.default.mget is not a function

      104 |       const key = 'test-key';
      105 |       mockRedisClient.exists.mockResolvedValue(1);
    > 106 |
          | ^
      107 |       const result = await redisService.exists(key);
      108 |
      109 |       expect(result).toBe(1);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:106:50)

  â— RedisService â€º Advanced Operations â€º should set multiple key-value pairs

    TypeError: redis_1.default.mset is not a function

      111 |     });
      112 |
    > 113 |     test('should set expiration for key', async () => {
          |                                                  ^
      114 |       const key = 'test-key';
      115 |       const ttl = 3600;
      116 |       mockRedisClient.expire.mockResolvedValue(1);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:113:50)

  â— RedisService â€º Advanced Operations â€º should increment counter

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      119 |
      120 |       expect(result).toBe(true);
    > 121 |       expect(mockRedisClient.expire).toHaveBeenCalledWith(key, ttl);
          |                                           ^
      122 |     });
      123 |
      124 |     test('should get TTL for key', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:121:43)

  â— RedisService â€º Advanced Operations â€º should decrement counter

    TypeError: redis_1.default.decr is not a function

      125 |       const key = 'test-key';
      126 |       const ttl = 3600;
    > 127 |       mockRedisClient.ttl.mockResolvedValue(ttl);
          |                                                  ^
      128 |
      129 |       const result = await redisService.ttl(key);
      130 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:127:50)

  â— RedisService â€º Hash Operations â€º should get hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      135 |
      136 |   describe('Advanced Operations', () => {
    > 137 |     test('should get multiple keys', async () => {
          |                                  ^
      138 |       const keys = ['key1', 'key2', 'key3'];
      139 |       const values = ['value1', 'value2', 'value3'];
      140 |       mockRedisClient.mget.mockResolvedValue(values);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:137:34)

  â— RedisService â€º Hash Operations â€º should set hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      144 |       expect(result).toEqual(values);
      145 |       expect(mockRedisClient.mget).toHaveBeenCalledWith(keys);
    > 146 |     });
          |        ^
      147 |
      148 |     test('should set multiple key-value pairs', async () => {
      149 |       const keyValues = { key1: 'value1', key2: 'value2' };

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:146:34)

  â— RedisService â€º Hash Operations â€º should get all hash fields

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      152 |       const result = await redisService.mset(keyValues);
      153 |
    > 154 |       expect(result).toBe('OK');
          |                                 ^
      155 |       expect(mockRedisClient.mset).toHaveBeenCalledWith(keyValues);
      156 |     });
      157 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:154:37)

  â— RedisService â€º Hash Operations â€º should delete hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      160 |       mockRedisClient.incr.mockResolvedValue(1);
      161 |
    > 162 |       const result = await redisService.incr(key);
          |                                  ^
      163 |
      164 |       expect(result).toBe(1);
      165 |       expect(mockRedisClient.incr).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:162:34)

  â— RedisService â€º List Operations â€º should push to left of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      170 |       mockRedisClient.decr.mockResolvedValue(0);
      171 |
    > 172 |       const result = await redisService.decr(key);
          |                                   ^
      173 |
      174 |       expect(result).toBe(0);
      175 |       expect(mockRedisClient.decr).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:172:35)

  â— RedisService â€º List Operations â€º should push to right of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      178 |
      179 |   describe('Hash Operations', () => {
    > 180 |     test('should get hash field', async () => {
          |                                   ^
      181 |       const key = 'test-hash';
      182 |       const field = 'field1';
      183 |       const value = 'value1';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:180:35)

  â— RedisService â€º List Operations â€º should pop from left of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      186 |       const result = await redisService.hget(key, field);
      187 |
    > 188 |       expect(result).toBe(value);
          |                                  ^
      189 |       expect(mockRedisClient.hget).toHaveBeenCalledWith(key, field);
      190 |     });
      191 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:188:34)

  â— RedisService â€º List Operations â€º should get range from list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      196 |       mockRedisClient.hset.mockResolvedValue(1);
      197 |
    > 198 |       const result = await redisService.hset(key, field, value);
          |                                    ^
      199 |
      200 |       expect(result).toBe(1);
      201 |       expect(mockRedisClient.hset).toHaveBeenCalledWith(key, field, value);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:198:36)

  â— RedisService â€º Set Operations â€º should add to set

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      206 |       const hash = { field1: 'value1', field2: 'value2' };
      207 |       mockRedisClient.hgetall.mockResolvedValue(hash);
    > 208 |
          | ^
      209 |       const result = await redisService.hgetall(key);
      210 |
      211 |       expect(result).toEqual(hash);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:208:34)

  â— RedisService â€º Set Operations â€º should remove from set

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      214 |
      215 |     test('should delete hash field', async () => {
    > 216 |       const key = 'test-hash';
          |                               ^
      217 |       const field = 'field1';
      218 |       mockRedisClient.hdel.mockResolvedValue(1);
      219 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:216:34)

  â— RedisService â€º Set Operations â€º should get all set members

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      222 |       expect(result).toBe(1);
      223 |       expect(mockRedisClient.hdel).toHaveBeenCalledWith(key, field);
    > 224 |     });
          |        ^
      225 |   });
      226 |
      227 |   describe('List Operations', () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:224:38)

  â— RedisService â€º Utility Operations â€º should get keys matching pattern

    expect(received).toEqual(expected) // deep equality

    Expected: ["test:key1", "test:key2"]
    Received: undefined

      234 |
      235 |       expect(result).toBe(1);
    > 236 |       expect(mockRedisClient.lpush).toHaveBeenCalledWith(key, value);
          |                                           ^
      237 |     });
      238 |
      239 |     test('should push to right of list', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:236:43)

  â— RedisService â€º Utility Operations â€º should flush database

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      238 |
      239 |     test('should push to right of list', async () => {
    > 240 |       const key = 'test-list';
          |                               ^
      241 |       const value = 'value1';
      242 |       mockRedisClient.rpush.mockResolvedValue(1);
      243 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:240:37)

  â— RedisService â€º Utility Operations â€º should ping Redis

    expect(received).toBe(expected) // Object.is equality

    Expected: "PONG"
    Received: undefined

      246 |       expect(result).toBe(1);
      247 |       expect(mockRedisClient.rpush).toHaveBeenCalledWith(key, value);
    > 248 |     });
          |        ^
      249 |
      250 |     test('should pop from left of list', async () => {
      251 |       const key = 'test-list';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:248:43)

  â— RedisService â€º Health Check â€º should perform health check successfully

    TypeError: redis_1.default.healthCheck is not a function

      253 |       mockRedisClient.lpop.mockResolvedValue(value);
      254 |
    > 255 |       const result = await redisService.lpop(key);
          |                                                  ^
      256 |
      257 |       expect(result).toBe(value);
      258 |       expect(mockRedisClient.lpop).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:255:50)

  â— RedisService â€º Health Check â€º should detect unhealthy Redis

    TypeError: redis_1.default.healthCheck is not a function

      262 |       const key = 'test-list';
      263 |       const start = 0;
    > 264 |       const stop = -1;
          |                       ^
      265 |       const values = ['value1', 'value2', 'value3'];
      266 |       mockRedisClient.lrange.mockResolvedValue(values);
      267 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:264:50)

  â— RedisService â€º Error Handling â€º should handle Redis errors gracefully

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      271 |       expect(mockRedisClient.lrange).toHaveBeenCalledWith(key, start, stop);
      272 |     });
    > 273 |   });
          |      ^
      274 |
      275 |   describe('Set Operations', () => {
      276 |     test('should add to set', async () => {

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:273:82)

  â— RedisService â€º Error Handling â€º should handle connection timeout

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      276 |     test('should add to set', async () => {
      277 |       const key = 'test-set';
    > 278 |       const member = 'member1';
          |                                ^
      279 |       mockRedisClient.sadd.mockResolvedValue(1);
      280 |
      281 |       const result = await redisService.sadd(key, member);

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:278:76)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/controllers/AIController.test.ts
  AIController
    getRecommendations
      âœ• should generate personalized recommendations (8 ms)
      âœ• should use default limit if not provided (4 ms)
      âœ• should handle recommendation generation errors (4 ms)
    getOptimalTiming
      âœ• should predict optimal timing for activities (3 ms)
      âœ• should handle different activity types (4 ms)
    getAdaptiveSchedule
      âœ• should generate adaptive schedule for specified date (4 ms)
      âœ• should use current date if not specified (3 ms)
    processMessage
      âœ• should process conversational AI message (5 ms)
      âœ• should handle new conversation without conversationId (4 ms)
      âœ• should maintain conversation context (4 ms)
    generateSmartResponse
      âœ• should generate contextual smart response (4 ms)
      âœ• should support different response tones (5 ms)
    getPredictions
      âœ• should retrieve comprehensive user predictions (3 ms)
      âœ• should identify at-risk users (7 ms)
    predictGoalCompletion
      âœ• should predict goal completion probability (4 ms)
      âœ• should handle goals with low completion probability (3 ms)
    createLearningPath
      âœ• should create personalized learning path (4 ms)
      âœ• should adapt to user skill level (5 ms)
    analyzeVoice
      âœ• should analyze voice recording for insights (5 ms)
      âœ• should detect emotional patterns in voice (4 ms)
    getInsightReport
      âœ• should generate comprehensive insight report (5 ms)
      âœ• should support different reporting periods (5 ms)
    hybridGenerate
      âœ• should use hybrid AI generation strategy (7 ms)
      âœ• should route to optimal model based on task (4 ms)
    Error Handling
      âœ• should handle AI service errors gracefully (4 ms)
      âœ• should handle missing user ID (6 ms)
      âœ• should handle invalid date formats (4 ms)
    Performance Considerations
      âœ• should use parallel processing for predictions (4 ms)

  â— AIController â€º getRecommendations â€º should generate personalized recommendations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", ["goals", "coaches", "content"], 5

    Number of calls: 0

      76 |   });
      77 |
    > 78 |   describe('getRecommendations', () => {
         |                                         ^
      79 |     test('should generate personalized recommendations', async () => {
      80 |       mockRequest.query = {
      81 |         types: 'goals,coaches,content',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:78:104)

  â— AIController â€º getRecommendations â€º should use default limit if not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", undefined, 5

    Number of calls: 0

      87 |         { type: 'coach', title: 'Life Coach - John Doe', score: 0.85 },
      88 |         { type: 'content', title: 'Mindfulness Article', score: 0.8 },
    > 89 |       ];
         |         ^
      90 |
      91 |       (recommendationEngine.generateRecommendations as jest.Mock).mockResolvedValue(
      92 |         mockRecommendations

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:89:104)

  â— AIController â€º getRecommendations â€º should handle recommendation generation errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<Error>

    Number of calls: 0

      92 |         mockRecommendations
      93 |       );
    > 94 |
         | ^
      95 |       await controller.getRecommendations(
      96 |         mockRequest as Request,
      97 |         mockResponse as Response,

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:94:45)

  â— AIController â€º getOptimalTiming â€º should predict optimal timing for activities

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "workout"

    Number of calls: 0

      106 |       expect(mockJson).toHaveBeenCalledWith({
      107 |         success: true,
    > 108 |         recommendations: mockRecommendations,
          |                                              ^
      109 |         generatedAt: expect.any(Date),
      110 |       });
      111 |     });

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:108:97)

  â— AIController â€º getOptimalTiming â€º should handle different activity types

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "meditation"

    Number of calls: 0

      121 |         mockNext
      122 |       );
    > 123 |
          | ^
      124 |       expect(recommendationEngine.generateRecommendations).toHaveBeenCalledWith(
      125 |         'user-123',
      126 |         undefined,

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:123:101)

  â— AIController â€º getAdaptiveSchedule â€º should generate adaptive schedule for specified date

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", Any<Date>

    Number of calls: 0

      141 |
      142 |       expect(mockNext).toHaveBeenCalledWith(expect.any(Error));
    > 143 |     });
          |        ^
      144 |   });
      145 |
      146 |   describe('getOptimalTiming', () => {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:143:105)

  â— AIController â€º getAdaptiveSchedule â€º should use current date if not specified

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", Any<Date>

    Number of calls: 0

      153 |         reasoning: 'Based on your historical patterns and energy levels',
      154 |         nextBestTime: '2024-01-15T06:00:00Z',
    > 155 |       };
          |         ^
      156 |
      157 |       (recommendationEngine.getOptimalTiming as jest.Mock).mockResolvedValue(mockTiming);
      158 |

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:155:105)

  â— AIController â€º processMessage â€º should process conversational AI message

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "How can I improve my productivity?", "conv-123", {"previousTopic": "time management"}

    Number of calls: 0

      172 |       });
      173 |     });
    > 174 |
          | ^
      175 |     test('should handle different activity types', async () => {
      176 |       const activityTypes = ['meditation', 'study', 'work', 'sleep'];
      177 |

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:174:92)

  â— AIController â€º processMessage â€º should handle new conversation without conversationId

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "Hello!", undefined, undefined

    Number of calls: 0

      187 |           mockRequest as Request,
      188 |           mockResponse as Response,
    > 189 |           mockNext
          |                   ^
      190 |         );
      191 |
      192 |         expect(recommendationEngine.getOptimalTiming).toHaveBeenCalledWith(

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:189:92)

  â— AIController â€º processMessage â€º should maintain conversation context

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      203 |
      204 |       const mockSchedule = {
    > 205 |         date: '2024-01-15',
          |                            ^
      206 |         activities: [
      207 |           { time: '06:00', activity: 'Morning workout', priority: 'high' },
      208 |           { time: '09:00', activity: 'Deep work session', priority: 'high' },

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:205:92)

  â— AIController â€º generateSmartResponse â€º should generate contextual smart response

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "I'm feeling unmotivated", {"length": "medium", "tone": "encouraging"}

    Number of calls: 0

      222 |         mockResponse as Response,
      223 |         mockNext
    > 224 |       );
          |         ^
      225 |
      226 |       expect(recommendationEngine.generateAdaptiveSchedule).toHaveBeenCalledWith(
      227 |         'user-123',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:224:94)

  â— AIController â€º generateSmartResponse â€º should support different response tones

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 0

      241 |       });
      242 |
    > 243 |       await controller.getAdaptiveSchedule(
          |                                            ^
      244 |         mockRequest as Request,
      245 |         mockResponse as Response,
      246 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:243:94)

  â— AIController â€º getPredictions â€º should retrieve comprehensive user predictions

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123"

    Number of calls: 0

      259 |         message: 'How can I improve my productivity?',
      260 |         conversationId: 'conv-123',
    > 261 |         context: { previousTopic: 'time management' },
          |                                                       ^
      262 |       };
      263 |
      264 |       const mockResult = {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:261:97)

  â— AIController â€º getPredictions â€º should identify at-risk users

    TypeError: Cannot read properties of undefined (reading '0')

      280 |       expect(conversationalAI.processConversation).toHaveBeenCalledWith(
      281 |         'user-123',
    > 282 |         'How can I improve my productivity?',
          |                                              ^
      283 |         'conv-123',
      284 |         { previousTopic: 'time management' }
      285 |       );

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:282:50)

  â— AIController â€º predictGoalCompletion â€º should predict goal completion probability

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "goal-123"

    Number of calls: 0

      297 |       (conversationalAI.processConversation as jest.Mock).mockResolvedValue({
      298 |         response: 'Hello! How can I help you today?',
    > 299 |         conversationId: 'conv-new-123',
          |                                        ^
      300 |       });
      301 |
      302 |       await controller.processMessage(

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:299:100)

  â— AIController â€º predictGoalCompletion â€º should handle goals with low completion probability

    TypeError: Cannot read properties of undefined (reading '0')

      312 |         undefined
      313 |       );
    > 314 |     });
          |        ^
      315 |
      316 |     test('should maintain conversation context', async () => {
      317 |       const messages = [

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:314:50)

  â— AIController â€º createLearningPath â€º should create personalized learning path

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "goal-456", {"duration": "8 weeks", "level": "intermediate", "topic": "Leadership Skills"}

    Number of calls: 0

      340 |   });
      341 |
    > 342 |   describe('generateSmartResponse', () => {
          |                                            ^
      343 |     test('should generate contextual smart response', async () => {
      344 |       mockRequest.body = {
      345 |         message: 'I\'m feeling unmotivated',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:342:103)

  â— AIController â€º createLearningPath â€º should adapt to user skill level

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      366 |       expect(conversationalAI.generateSmartResponse).toHaveBeenCalledWith(
      367 |         'user-123',
    > 368 |         'I\'m feeling unmotivated',
          |                                    ^
      369 |         { tone: 'encouraging', length: 'medium' }
      370 |       );
      371 |       expect(mockJson).toHaveBeenCalledWith({

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:368:103)

  â— AIController â€º analyzeVoice â€º should analyze voice recording for insights

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", {"data": [98, 97, 115, 101, 54, 52, 95, 101, 110, 99, â€¦], "type": "Buffer"}, {"previousContext": {"mood": "positive"}, "sessionType": "journal"}

    Number of calls: 0

      391 |         await controller.generateSmartResponse(
      392 |           mockRequest as Request,
    > 393 |           mockResponse as Response,
          |                                    ^
      394 |           mockNext
      395 |         );
      396 |       }

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:393:67)

  â— AIController â€º analyzeVoice â€º should detect emotional patterns in voice

    TypeError: Cannot read properties of undefined (reading '0')

      411 |         },
      412 |       };
    > 413 |
          | ^
      414 |       (predictiveAnalytics.predictUserSuccess as jest.Mock).mockResolvedValue(
      415 |         mockPredictions.success
      416 |       );

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:413:50)

  â— AIController â€º getInsightReport â€º should generate comprehensive insight report

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "weekly"

    Number of calls: 0

      436 |         predictions: mockPredictions,
      437 |       });
    > 438 |     });
          |        ^
      439 |
      440 |     test('should identify at-risk users', async () => {
      441 |       (predictiveAnalytics.predictUserSuccess as jest.Mock).mockResolvedValue({

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:438:94)

  â— AIController â€º getInsightReport â€º should support different reporting periods

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "daily"

    Number of calls: 0

      451 |       });
      452 |
    > 453 |       await controller.getPredictions(
          |                                       ^
      454 |         mockRequest as Request,
      455 |         mockResponse as Response,
      456 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:453:98)

  â— AIController â€º hybridGenerate â€º should use hybrid AI generation strategy

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: [{"content": "Generate a personalized coaching message", "role": "user"}], ObjectContaining {"preferences": {"length": "short", "tone": "encouraging"}, "task": "content_generation"}

    Number of calls: 0

      487 |       expect(predictiveAnalytics.predictGoalCompletion).toHaveBeenCalledWith('goal-123');
      488 |       expect(mockJson).toHaveBeenCalledWith({
    > 489 |         success: true,
          |                       ^
      490 |         prediction: mockPrediction,
      491 |       });
      492 |     });

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:489:77)

  â— AIController â€º hybridGenerate â€º should route to optimal model based on task

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      524 |         },
      525 |       };
    > 526 |
          | ^
      527 |       const mockLearningPath = {
      528 |         id: 'path-123',
      529 |         topic: 'Leadership Skills',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:526:77)

  â— AIController â€º Error Handling â€º should handle AI service errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"message": "AI model timeout"}

    Number of calls: 0

      531 |           { id: 'mod-1', title: 'Communication Basics', duration: '2 weeks' },
      532 |           { id: 'mod-2', title: 'Team Management', duration: '3 weeks' },
    > 533 |           { id: 'mod-3', title: 'Decision Making', duration: '3 weeks' },
          |                                             ^
      534 |         ],
      535 |         totalDuration: '8 weeks',
      536 |         difficulty: 'intermediate',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:533:45)

  â— AIController â€º Error Handling â€º should handle missing user ID

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "", Anything, Anything

    Number of calls: 0

      539 |       (adaptiveLearning.createPersonalizedLearningPath as jest.Mock).mockResolvedValue(mockLearningPath);
      540 |
    > 541 |       await controller.createLearningPath(
          |                                           ^
      542 |         mockRequest as Request,
      543 |         mockResponse as Response,
      544 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:541:104)

  â— AIController â€º Error Handling â€º should handle invalid date formats

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<Error>

    Number of calls: 0

      545 |       );
      546 |
    > 547 |       expect(adaptiveLearning.createPersonalizedLearningPath).toHaveBeenCalledWith(
          |                                             ^
      548 |         'user-123',
      549 |         'goal-456',
      550 |         {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:547:45)

  â— AIController â€º Performance Considerations â€º should use parallel processing for predictions

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      557 |         success: true,
      558 |         learningPath: mockLearningPath,
    > 559 |       });
          |          ^
      560 |     });
      561 |
      562 |     test('should adapt to user skill level', async () => {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:559:97)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/middleware/sqlInjectionProtection.test.ts
  SQL Injection Protection
    containsSQLInjection
      âœ“ should detect SQL injection in SELECT statements (5 ms)
      âœ“ should detect UNION-based SQL injection (5 ms)
      âœ“ should detect boolean-based SQL injection (3 ms)
      âœ“ should detect time-based SQL injection (6 ms)
      âœ• should detect hex-encoded injection (5 ms)
      âœ“ should allow safe inputs (4 ms)
      âœ“ should handle non-string values (4 ms)
    sanitizeSQLInput
      âœ“ should escape single quotes (4 ms)
      âœ“ should remove SQL comments (4 ms)
      âœ“ should remove dangerous SQL keywords (4 ms)
      âœ“ should remove null bytes (4 ms)
    validateSQLInjection middleware
      âœ“ should allow safe URL parameters (5 ms)
      âœ“ should block SQL injection in URL parameters (6 ms)
      âœ“ should allow safe query string parameters (5 ms)
      âœ“ should block SQL injection in query string (7 ms)
      âœ• should allow safe request body (5 ms)
      âœ“ should block SQL injection in request body (5 ms)
      âœ“ should block SQL injection in nested objects (4 ms)
      âœ“ should block SQL injection in arrays (5 ms)
      âœ“ should apply strict validation to sensitive fields (6 ms)
    createSafeLikePattern
      âœ“ should escape special LIKE characters (4 ms)
      âœ“ should create pattern for start match (4 ms)
      âœ“ should create pattern for end match (4 ms)
      âœ“ should create pattern for contains match (5 ms)
    isValidUUID
      âœ“ should validate correct UUIDs (3 ms)
      âœ“ should reject invalid UUIDs (5 ms)
    isSafeInteger
      âœ“ should validate safe integers (5 ms)
      âœ“ should reject invalid integers (5 ms)
    enforceParameterizedQueries
      âœ“ should allow parameterized queries (7 ms)
      âœ“ should throw error for string concatenation (7 ms)
      âœ“ should warn about template literals without parameters (4 ms)
    Real-world SQL injection attempts
      âœ“ should block common authentication bypass attempts (5 ms)
      âœ• should block UNION-based data extraction (4 ms)
      âœ“ should block stored procedure execution (5 ms)
      âœ“ should block blind SQL injection attempts (4 ms)

  â— SQL Injection Protection â€º containsSQLInjection â€º should detect hex-encoded injection

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      26 |       expect(containsSQLInjection("' UNION SELECT * FROM users--")).toBe(true);
      27 |       expect(containsSQLInjection("1 UNION ALL SELECT password FROM users")).toBe(true);
    > 28 |     });
         |        ^
      29 |
      30 |     it('should detect boolean-based SQL injection', () => {
      31 |       expect(containsSQLInjection("1' OR '1'='1")).toBe(true);

      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:28:90)

  â— SQL Injection Protection â€º validateSQLInjection middleware â€º should allow safe request body

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      117 |     it('should block SQL injection in URL parameters', () => {
      118 |       mockRequest.params = { id: "1' OR '1'='1" };
    > 119 |
          | ^
      120 |       validateSQLInjection(
      121 |         mockRequest as Request,
      122 |         mockResponse as Response,

      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:119:30)

  â— SQL Injection Protection â€º Real-world SQL injection attempts â€º should block UNION-based data extraction

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      280 |
      281 |     it('should create pattern for start match', () => {
    > 282 |       expect(createSafeLikePattern('test', 'start')).toBe('test%');
          |                                                                    ^
      283 |     });
      284 |
      285 |     it('should create pattern for end match', () => {

      at src/middleware/sqlInjectionProtection.test.ts:282:84
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:281:21)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/SchedulerService.test.ts
  SchedulerService
    initialize
      âœ“ should initialize all scheduled jobs (6 ms)
      âœ“ should store all jobs in the jobs map (4 ms)
      âœ“ should replace existing jobs if initialized multiple times (5 ms)
    Daily Snapshot Job
      âœ“ should execute daily snapshot generation successfully (4 ms)
      âœ“ should handle errors in daily snapshot generation (4 ms)
    Hourly Reports Job
      âœ“ should execute scheduled reports generation successfully (5 ms)
      âœ“ should handle errors in scheduled reports generation (4 ms)
    Weekly Cost Analysis Job
      âœ“ should execute weekly cost analysis successfully (7 ms)
      âœ“ should handle errors in weekly cost analysis (4 ms)
    Monthly Health Check Job
      âœ“ should execute monthly health check successfully (6 ms)
      âœ“ should handle errors in monthly health check (3 ms)
    Quarterly Projections Job
      âœ“ should execute quarterly projections successfully (5 ms)
      âœ“ should handle errors in quarterly projections (5 ms)
    Real-Time Alert Monitoring Job
      âœ“ should execute alert monitoring successfully (5 ms)
      âœ“ should handle errors in alert monitoring (4 ms)
    Job Management
      âœ“ should stop a specific job (3 ms)
      âœ“ should stop all jobs (5 ms)
      âœ• should get job status (5 ms)
      âœ“ should list all jobs (4 ms)
    Cron Expression Validation
      âœ“ should use correct cron expressions (6 ms)
      âœ“ should use UTC timezone for all jobs (5 ms)
    Error Handling
      âœ“ should continue running other jobs if one fails (3 ms)
      âœ• should handle job initialization errors gracefully (7 ms)
    getInstance
      âœ“ should return singleton instance (5 ms)

  â— SchedulerService â€º Job Management â€º should get job status

    expect(received).toBe(expected) // Object.is equality

    Expected: "scheduled"
    Received: [{"name": "daily-snapshot", "running": true}, {"name": "hourly-reports", "running": true}, {"name": "weekly-cost-analysis", "running": true}, {"name": "monthly-health-check", "running": true}, {"name": "quarterly-projections", "running": true}, {"name": "alert-monitoring", "running": true}]

      281 |
      282 |   describe('Monthly Health Check Job', () => {
    > 283 |     test('should execute monthly health check successfully', async () => {
          |                                               ^
      284 |       const performMonthlyHealthCheckSpy = jest
      285 |         .spyOn(SchedulerService as any, 'performMonthlyHealthCheck')
      286 |         .mockResolvedValue(undefined);

      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:283:47)

  â— SchedulerService â€º Error Handling â€º should handle job initialization errors gracefully

    expect(received).not.toThrow()

    Error name:    "Error"
    Error message: "Invalid cron expression"

          349 |
          350 |     test('should handle errors in quarterly projections', async () => {
        > 351 |       const error = new Error('Projections failed');
              |                       ^
          352 |       const generateQuarterlyProjectionsSpy = jest
          353 |         .spyOn(SchedulerService as any, 'generateQuarterlyProjections')
          354 |         .mockRejectedValue(error);

      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:351:23)
      at Function.scheduleJob (src/services/SchedulerService.ts:3280:37)
      at Function.initialize (src/services/SchedulerService.ts:3122:10)
      at src/__tests__/services/SchedulerService.test.ts:354:77
      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:354:95)
      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:354:95)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/StripeWebhookService.test.ts
  StripeWebhookService
    handleWebhook
      âœ“ should prevent processing duplicate events (7 ms)
      âœ• should log new billing events (5 ms)
    Payment Intent Events
      âœ• should handle payment_intent.succeeded event (4 ms)
      âœ• should handle payment_intent.payment_failed event (4 ms)
    Subscription Events
      âœ• should handle customer.subscription.created event (5 ms)
      âœ• should handle customer.subscription.updated event (4 ms)
      âœ• should handle customer.subscription.deleted event (6 ms)
      âœ• should handle trial_will_end event (4 ms)
    Invoice Events
      âœ• should handle invoice.payment_succeeded event (4 ms)
      âœ• should handle invoice.payment_failed event (5 ms)
    Refund Events
      âœ• should handle charge.refunded event (4 ms)
    Dispute Events
      âœ• should handle charge.dispute.created event (5 ms)
    Error Handling
      âœ“ should handle user not found gracefully (3 ms)
      âœ• should handle database errors gracefully (7 ms)
      âœ• should handle missing metadata gracefully (4 ms)
    Amount Conversion
      âœ• should correctly convert cents to dollars (4 ms)
      âœ• should handle zero-decimal currencies correctly (4 ms)

  â— StripeWebhookService â€º handleWebhook â€º should log new billing events

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:86:13)

  â— StripeWebhookService â€º Payment Intent Events â€º should handle payment_intent.succeeded event

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:120:13)

  â— StripeWebhookService â€º Payment Intent Events â€º should handle payment_intent.payment_failed event

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentFailed (src/services/financial/StripeWebhookService.ts:3559:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3364:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:149:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.created event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"amount": 29.99, "currency": "usd", "plan": "Premium Plan", "status": "active", "userId": 123}

    Number of calls: 0

      190 |       );
      191 |     });
    > 192 |   });
          |      ^
      193 |
      194 |   describe('Subscription Events', () => {
      195 |     test('should handle customer.subscription.created event', async () => {

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:192:60)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.updated event

    TypeError: Cannot read properties of undefined (reading 'data')



      at StripeWebhookService.handleSubscriptionUpdated (src/services/financial/StripeWebhookService.ts:3722:85)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3380:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:221:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.deleted event

    TypeError: subscription.update is not a function



      at StripeWebhookService.handleSubscriptionDeleted (src/services/financial/StripeWebhookService.ts:3805:24)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3388:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:247:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle trial_will_end event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"stripeCustomerId": "cus_test123"}}

    Number of calls: 0

      268 |           status: SubscriptionStatus.PAST_DUE,
      269 |         }),
    > 270 |         expect.objectContaining({
          |                                  ^
      271 |           where: { stripeSubscriptionId: 'sub_123' },
      272 |         })
      273 |       );

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:270:53)

  â— StripeWebhookService â€º Invoice Events â€º should handle invoice.payment_succeeded event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"amount": 29.99, "status": "completed", "type": Any<String>, "userId": 123}

    Number of calls: 0

      294 |       mockSubscription.findOne.mockResolvedValue({ id: 1 } as unknown);
      295 |       mockSubscription.update.mockResolvedValue([1] as unknown);
    > 296 |
          | ^
      297 |       await webhookService.handleWebhook(subscriptionDeletedEvent);
      298 |
      299 |       expect(mockSubscription.update).toHaveBeenCalledWith(

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:296:59)

  â— StripeWebhookService â€º Invoice Events â€º should handle invoice.payment_failed event

    TypeError: subscription.update is not a function



      at StripeWebhookService.handleInvoicePaymentFailed (src/services/financial/StripeWebhookService.ts:3988:24)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3412:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:324:13)

  â— StripeWebhookService â€º Refund Events â€º should handle charge.refunded event

    TypeError: transaction.update is not a function



      at StripeWebhookService.handleChargeRefunded (src/services/financial/StripeWebhookService.ts:4054:23)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3420:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:358:13)

  â— StripeWebhookService â€º Dispute Events â€º should handle charge.dispute.created event

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      384 |         },
      385 |       } as unknown as Stripe.Event;
    > 386 |
          | ^
      387 |       mockBillingEvent.findOne.mockResolvedValue(null);
      388 |       mockBillingEvent.create.mockResolvedValue({} as unknown);
      389 |       mockUser.findOne.mockResolvedValue({ id: testUserId, email: testEmail } as unknown);

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:386:60)

  â— StripeWebhookService â€º Error Handling â€º should handle database errors gracefully

    expect(received).resolves.toBeUndefined()

    Received promise rejected instead of resolved
    Rejected to value: [Error: Database connection failed]

      413 |             refunds: {
      414 |               data: [{
    > 415 |                 id: 're_123',
          |                              ^
      416 |                 amount: 5000,
      417 |                 reason: 'requested_by_customer',
      418 |               }],

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:415:40)

  â— StripeWebhookService â€º Error Handling â€º should handle missing metadata gracefully

    expect(received).resolves.toBeUndefined()

    Received promise rejected instead of resolved
    Rejected to value: [TypeError: Cannot read properties of undefined (reading 'PAYMENT')]

      431 |       await webhookService.handleWebhook(refundEvent);
      432 |
    > 433 |       expect(mockTransaction.update).toHaveBeenCalledWith(
          |                                        ^
      434 |         expect.objectContaining({
      435 |           status: TransactionStatus.REFUNDED,
      436 |         }),

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:433:40)

  â— StripeWebhookService â€º Amount Conversion â€º should correctly convert cents to dollars

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:455:13)

  â— StripeWebhookService â€º Amount Conversion â€º should handle zero-decimal currencies correctly

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:478:13)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/utils/logger.minimal.test.ts
  Logger Utility - Minimal Coverage
    âœ• should import logger without errors (12 ms)
    âœ• should handle basic logging operations (4 ms)
    âœ“ should validate logger configuration (3 ms)

  â— Logger Utility - Minimal Coverage â€º should import logger without errors

    expect(received).not.toThrow()

    Error name:    "TypeError"
    Error message: "winston_1.default.format.printf is not a function"

      at Object.<anonymous> (src/utils/logger.ts:2521:63)
      at src/__tests__/utils/logger.minimal.test.ts:31:32
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:33:16)
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:33:16)

  â— Logger Utility - Minimal Coverage â€º should handle basic logging operations

    TypeError: winston_1.default.format.printf is not a function



      at Object.<anonymous> (src/utils/logger.ts:2521:63)
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:36:28)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

FAIL src/__tests__/services/RedisService.simple.test.ts
  RedisService
    âœ“ should import RedisService without errors (12 ms)
    âœ• should handle basic Redis operations (5 ms)
    âœ• should handle Redis connection (5 ms)
    âœ• should handle Redis ping (4 ms)

  â— RedisService â€º should handle basic Redis operations

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-value"
    Received: undefined



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:83:39)

  â— RedisService â€º should handle Redis connection

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:89:56)

  â— RedisService â€º should handle Redis ping

    expect(received).toBe(expected) // Object.is equality

    Expected: "PONG"
    Received: undefined



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:95:39)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/ReferralService.test.ts
  ReferralService Integration Tests
    generateReferralCode
      âœ“ should generate unique referral code from user name (8 ms)
      âœ“ should reject non-existent user (5 ms)
    createReferral
      âœ“ should create referral and send invitation email (4 ms)
      âœ“ should reject duplicate referral email (5 ms)
    completeReferral
      âœ“ should complete referral and award rewards to both users (6 ms)
      âœ“ should unlock milestone achievement at 5 referrals (4 ms)
      âœ“ should unlock milestone achievement at 10 referrals (6 ms)
      âœ“ should return null for organic signup (no referral) (4 ms)
    getReferralAnalytics
      âœ“ should calculate referral analytics correctly (4 ms)
    detectFraud
      âœ“ should flag suspicious rapid referrals (9 ms)
      âœ“ should flag suspicious email patterns (4 ms)
      âœ“ should pass clean referral activity (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    ===== DEBUG TEST STARTING =====

      10 |   it('should show the actual error response', async () => {
      11 |     console.error('===== DEBUG TEST STARTING =====');
    > 12 |
         | ^
      13 |     const testUser = {
      14 |       email: 'test@example.com',
      15 |       firstName: 'Test',

      at Object.<anonymous> (src/tests/debug-register.test.ts:12:17)

  console.error
    [AUTH ROUTE] Register endpoint called



      at src/routes/auth.ts:2571:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Data validated: { email: 'test@example.com' }



      at src/routes/auth.ts:2577:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] Password validation: { isValid: true, errors: [] }



      at src/routes/auth.ts:2586:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [AUTH ROUTE] About to create user: { fullName: 'Test User', email: 'test@example.com' }



      at src/routes/auth.ts:2607:11
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne called: { table: 'users', where: { email: 'test@example.com' } }

      20 |   },
      21 |
    > 22 |   findOne: async (table: string, where: Record<string, unknown>) => {
         |                 ^
      23 |     console.error('[DB MANUAL MOCK] findOne called:', { table, where });
      24 |
      25 |     // Look up in mock storage

      at Object.findOne (src/services/__mocks__/database.ts:22:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] findOne no match found

      36 |       if (match) {
      37 |         console.error('[DB MANUAL MOCK] findOne found match:', { id: match.id, email: match.email || 'N/A' });
    > 38 |         return match;
         |                 ^
      39 |       }
      40 |     }
      41 |

      at Object.findOne (src/services/__mocks__/database.ts:38:17)
      at Function.findByEmail (src/services/userService.ts:3473:34)
      at Function.create (src/services/userService.ts:3493:45)
      at src/routes/auth.ts:2613:61
      at src/middleware/errorHandler.ts:3172:21
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at ../../node_modules/express-rate-limit/dist/index.cjs:807:7
      at ../../node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [DB MANUAL MOCK] insert called: {
      table: 'users',
      dataKeys: [ 'email', 'password_hash', 'name', 'bio', 'role', 'preferences' ]
    }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-0gs5mv', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Function.create (src/services/userService.ts:3513:54)
      at src/routes/auth.ts:2613:29

  console.error
    [USER SERVICE] db.insert returned: object id: test-user-id-0gs5mv



      at Function.create (src/services/userService.ts:3531:15)
      at src/routes/auth.ts:2613:29

  console.error
    [AUTH ROUTE] User created: { id: 'test-user-id-0gs5mv' }



      at src/routes/auth.ts:2621:11

  console.error
    [DB MANUAL MOCK] update called: { table: 'users', where: { id: 'test-user-id-0gs5mv' } }

      91 |       createdAt: new Date(),
      92 |       updatedAt: new Date(),
    > 93 |     };
         |       ^
      94 |
      95 |     // Store in mock storage
      96 |     if (!mockStorage[table]) {

      at Object.update (src/services/__mocks__/database.ts:93:17)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    [DB MANUAL MOCK] Record updated in storage: { table: 'users', id: 'test-user-id-0gs5mv' }

      108 |     // Find and update record in mock storage
      109 |     if (mockStorage[table]) {
    > 110 |       const records = mockStorage[table];
          |                         ^
      111 |       const index = records.findIndex((record) => {
      112 |         return Object.entries(where).every(([key, value]) => {
      113 |           const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());

      at Object.update (src/services/__mocks__/database.ts:110:25)
      at Function.updateLastLogin (src/services/userService.ts:3706:27)
      at src/routes/auth.ts:2635:35

  console.error
    ===== RESPONSE RECEIVED =====

      22 |     const response = await request(app)
      23 |       .post('/api/v1/auth/register')
    > 24 |       .send(testUser);
         |                 ^
      25 |
      26 |     console.error('===== RESPONSE RECEIVED =====');
      27 |     console.error('Status:', response.status);

      at Object.<anonymous> (src/tests/debug-register.test.ts:24:17)

  console.error
    Status: 201

      23 |       .post('/api/v1/auth/register')
      24 |       .send(testUser);
    > 25 |
         | ^
      26 |     console.error('===== RESPONSE RECEIVED =====');
      27 |     console.error('Status:', response.status);
      28 |     console.error('Body:', JSON.stringify(response.body, null, 2));

      at Object.<anonymous> (src/tests/debug-register.test.ts:25:17)

  console.error
    Body: {
      "success": true,
      "message": "Registration successful",
      "user": {
        "id": "test-user-id-0gs5mv",
        "email": "test@example.com",
        "firstName": "Test",
        "lastName": "User",
        "isVerified": false
      },
      "token": "mock-jwt-token"
    }

      24 |       .send(testUser);
      25 |
    > 26 |     console.error('===== RESPONSE RECEIVED =====');
         |                 ^
      27 |     console.error('Status:', response.status);
      28 |     console.error('Body:', JSON.stringify(response.body, null, 2));
      29 |

      at Object.<anonymous> (src/tests/debug-register.test.ts:26:17)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/tests/debug-register.test.ts
  Debug Register Endpoint
    âœ“ should show the actual error response (32 ms)

ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/services/api/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/ABTestingService.test.ts
  ABTestingService Integration Tests
    createExperiment
      âœ“ should create experiment with variants (28 ms)
      âœ“ should reject variants with invalid weights (6 ms)
      âœ“ should create three-way split test (6 ms)
    assignUserToExperiment
      âœ“ should assign user to variant based on weight (6 ms)
      âœ“ should return existing assignment if user already assigned (4 ms)
      âœ“ should reject assignment to inactive experiment (5 ms)
    recordConversion
      âœ“ should record conversion for assigned user (5 ms)
      âœ“ should reject conversion for unassigned user (4 ms)
    getExperimentResults
      âœ“ should calculate conversion rates correctly (5 ms)
      âœ“ should determine statistical significance (5 ms)
    stopExperiment
      âœ“ should stop active experiment and declare winner (5 ms)
      âœ“ should reject stopping non-active experiment (3 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/CoachingSessionService.test.ts
  CoachingSessionService Integration
    Session Booking
      âœ“ should successfully book a session (7 ms)
      âœ“ should reject booking when coach not found (5 ms)
      âœ“ should reject booking when coach has conflicting session (6 ms)
      âœ“ should reject booking when client has conflicting session (6 ms)
      âœ“ should reject booking in the past (9 ms)
    Session Cancellation
      âœ“ should cancel session within policy window (5 ms)
      âœ“ should reject cancellation within 24 hours (5 ms)
      âœ“ should reject cancellation of already canceled session (5 ms)
    Session Rescheduling
      âœ“ should reschedule session to new time (5 ms)
      âœ“ should reject rescheduling to past date (5 ms)
    Session Completion
      âœ“ should complete session with feedback and update stats (6 ms)
      âœ“ should unlock achievement at milestone (5 ms)
      âœ“ should reject invalid rating (4 ms)
    Coach Discovery
      âœ“ should find available coaches by criteria (6 ms)
    Coach Analytics
      âœ“ should get comprehensive coach analytics (8 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/PaymentManagementService.test.ts
  PaymentManagementService Integration
    Subscription Creation
      âœ“ should create new subscription for user without Stripe customer (7 ms)
      âœ“ should create subscription with existing Stripe customer (4 ms)
      âœ“ should create subscription with trial period (no points awarded) (10 ms)
      âœ“ should reject subscription creation when user not found (5 ms)
      âœ“ should reject subscription creation when user already has active subscription (5 ms)
    Subscription Tier Changes
      âœ“ should upgrade subscription tier successfully (5 ms)
      âœ“ should reject tier change when no active subscription exists (5 ms)
    One-Time Payments
      âœ“ should process successful one-time payment (5 ms)
      âœ“ should handle pending payment without awarding points (5 ms)
    Subscription Cancellation
      âœ“ should cancel subscription immediately (6 ms)
      âœ“ should cancel subscription at period end (5 ms)
    Failed Payment Handling
      âœ“ should handle failed payment and update subscription status (6 ms)
    Subscription Reactivation
      âœ“ should reactivate canceled subscription (11 ms)
      âœ“ should reject reactivation when no canceled subscription exists (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/basic.test.ts
  Basic Test Suite
    âœ“ should verify Jest is working correctly (4 ms)
    âœ“ should verify TypeScript compilation (5 ms)
    âœ“ should verify async operations (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/services/GamificationService.test.ts
  GamificationService
    initializeUser
      âœ“ should initialize user gamification data with levels and streaks (6 ms)
      âœ“ should handle initialization errors gracefully (4 ms)
      âœ“ should support transactions (3 ms)
      âœ“ should use ON CONFLICT to prevent duplicate entries (9 ms)
    awardPoints
      âœ“ should award points and update user level data (4 ms)
      âœ“ should increment total_points, current_points, and level_progress (5 ms)
      âœ“ should throw error on database failure (4 ms)
      âœ“ should check for level up after awarding points (5 ms)
      âœ“ should support zero and negative points (3 ms)
    Level Up System
      âœ“ should execute level up CTE query correctly (4 ms)
    Point Calculation Edge Cases
      âœ“ should handle very large point values (3 ms)
      âœ“ should handle decimal point values (5 ms)
      âœ“ should track different reward reasons (4 ms)
    Transaction Support
      âœ“ should pass transaction to all database operations (4 ms)
    Performance Optimizations
      âœ“ should use bulk insert for streaks initialization (5 ms)
      âœ“ should minimize database round trips (7 ms)
    Error Recovery
      âœ“ should handle initialization errors gracefully (3 ms)
      âœ“ should propagate errors in awardPoints for transaction rollback (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/performance/memory-leaks.test.ts
  Performance Tests: Memory Leak Detection
    Service Instantiation
      âœ“ should not leak memory when creating services repeatedly (8 ms)
    Event Handlers
      âœ“ should not leak memory with event listeners (5 ms)
    Cache Implementations
      âœ“ should not leak memory with LRU cache (11 ms)
      âœ“ should not leak memory with timed cache eviction (15 ms)
    Data Processing
      âœ“ should not leak memory processing large datasets (85 ms)
    Connection Pooling
      âœ“ should not leak memory with connection pool (7 ms)
    Async Operations
      âœ“ should not leak memory with promise chains (10 ms)
      âœ“ should not leak memory with concurrent promises (7 ms)
    Buffer and Stream Operations
      âœ“ should not leak memory with buffer operations (7 ms)
    Circular References
      âœ“ should not leak memory with circular references (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/routes/health.test.ts
  Health Check API
    âœ“ should create valid health check response (6 ms)
    âœ“ should validate health response correctly (4 ms)
    âœ“ should detect invalid health responses (3 ms)
    âœ“ should handle missing fields (5 ms)
    âœ“ should create health response with proper timestamp format (4 ms)
    âœ“ should report positive uptime (3 ms)
    âœ“ should include environment information (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/models/User.test.ts
  User Model
    Model Creation
      âœ“ should create a user with valid data (7 ms)
      âœ“ should hash password before saving (4 ms)
      âœ“ should set default values correctly (5 ms)
      âœ“ should generate UUID for id (5 ms)
    Model Validation
      âœ“ should require email (5 ms)
      âœ“ should require password (8 ms)
      âœ“ should require name (4 ms)
      âœ“ should validate email format (5 ms)
      âœ“ should enforce unique email constraint (4 ms)
      âœ“ should enforce unique googleId constraint (4 ms)
      âœ“ should validate role enum (5 ms)
      âœ“ should accept valid roles (4 ms)
    Instance Methods
      âœ“ should compare password correctly (5 ms)
      âœ“ should handle empty password comparison (4 ms)
    Model Updates
      âœ“ should hash password on update (4 ms)
      âœ“ should not rehash password if unchanged (4 ms)
      âœ“ should update lastLoginAt (4 ms)
      âœ“ should update onboarding status (7 ms)
    Model Queries
      âœ“ should find user by email (5 ms)
      âœ“ should find users by role (5 ms)
      âœ“ should find active users (5 ms)
      âœ“ should count users by role (4 ms)
    Bcrypt Rounds Configuration
      âœ“ should use default bcrypt rounds when not configured (4 ms)
      âœ“ should use configured bcrypt rounds (6 ms)
    Edge Cases
      âœ“ should handle very long names (3 ms)
      âœ“ should handle optional fields as null (4 ms)
      âœ“ should handle unicode characters in name and bio (6 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/tests/i18n.middleware.test.ts
  i18n middleware
    âœ“ sets Content-Language from Accept-Language header (22 ms)
    âœ“ defaults to en when invalid (7 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/services/UserService.test.ts
  UserService
    create
      âœ“ should create user with valid data (5 ms)
      âœ“ should throw error for invalid email (5 ms)
      âœ“ should throw error for missing required fields (4 ms)
    findByEmail
      âœ“ should find existing user by email (4 ms)
      âœ“ should return null for non-existent email (6 ms)
    verifyPassword
      âœ“ should verify correct password (3 ms)
      âœ“ should return null for incorrect password (4 ms)
      âœ“ should return null for non-existent user (5 ms)
    validatePasswordStrength
      âœ“ should accept strong password (4 ms)
      âœ“ should reject short password (4 ms)
      âœ“ should reject password without uppercase (3 ms)
      âœ“ should reject password without lowercase (4 ms)
      âœ“ should reject password without numbers (3 ms)
      âœ“ should reject password without special characters (5 ms)
      âœ“ should return multiple errors for weak password (5 ms)
    updatePassword
      âœ“ should update password with valid data (5 ms)
      âœ“ should throw error for incorrect current password (6 ms)
      âœ“ should throw error for weak new password (4 ms)
      âœ“ should throw error for non-existent user (3 ms)
    toResponseDto
      âœ“ should return safe user data without password (5 ms)
    Google OAuth
      âœ“ should verify valid Google token (3 ms)
      âœ“ should throw error for invalid Google token (4 ms)
      âœ“ should create user from Google data (5 ms)
    Password Reset
      âœ“ should generate password reset token (4 ms)
      âœ“ should reset password with valid token (4 ms)
      âœ“ should throw error for invalid reset token (4 ms)
      âœ“ should throw error for weak password in reset (4 ms)
    User Profile
      âœ“ should get user profile (5 ms)
      âœ“ should return null for non-existent user profile (4 ms)
    Edge Cases
      âœ“ should handle undefined and null inputs gracefully (4 ms)
      âœ“ should handle concurrent password updates (6 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/security/auth-authorization.test.ts
  Security Tests: Authentication & Authorization
    JWT Token Security
      âœ“ should require valid JWT token for protected endpoints (8 ms)
      âœ“ should validate JWT signature (6 ms)
      âœ“ should validate JWT expiration (4 ms)
      âœ“ should use strong JWT secret (5 ms)
    Password Security
      âœ“ should enforce strong password requirements (4 ms)
      âœ“ should accept strong passwords (7 ms)
      âœ“ should hash passwords before storage (6 ms)
      âœ“ should use sufficient bcrypt rounds (4 ms)
    Rate Limiting
      âœ“ should limit login attempts (4 ms)
      âœ“ should have different limits for authenticated vs unauthenticated (6 ms)
      âœ“ should reset rate limit after time window (4 ms)
    Role-Based Access Control (RBAC)
      âœ“ should enforce role-based permissions (4 ms)
      âœ“ should validate resource ownership (4 ms)
    Session Management
      âœ“ should invalidate session on logout (4 ms)
      âœ“ should expire old sessions (5 ms)
    Sensitive Data Protection
      âœ“ should not expose passwords in API responses (4 ms)
      âœ“ should not expose sensitive fields in error messages (7 ms)
      âœ“ should mask sensitive data in logs (4 ms)
    CSRF Protection
      âœ“ should validate CSRF token for state-changing operations (3 ms)
      âœ“ should include CSRF token in forms (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/contracts/referral-api.contract.test.ts
  Referral API Contracts
    POST /api/referral/code
      âœ“ should have correct referral code creation request schema (4 ms)
      âœ“ should return 201 with referral code and share URL (4 ms)
      âœ“ should require authentication (4 ms)
    POST /api/referral/validate
      âœ“ should have correct validation request schema (5 ms)
      âœ“ should return 200 with validity and discount info (4 ms)
      âœ“ should return 404 for invalid code (3 ms)
      âœ“ should not require authentication (public endpoint) (3 ms)
    POST /api/referral/apply
      âœ“ should have correct apply request schema (4 ms)
      âœ“ should return 200 with discount confirmation (4 ms)
      âœ“ should return 400 for invalid or expired code (3 ms)
      âœ“ should require authentication (3 ms)
    GET /api/referral/stats
      âœ“ should return 200 with user referral statistics (4 ms)
      âœ“ should require authentication (3 ms)
    GET /api/referral/leaderboard
      âœ“ should support period query parameter (3 ms)
      âœ“ should return 200 with leaderboard data (5 ms)
      âœ“ should not require authentication (public leaderboard) (4 ms)
    GET /api/referral/history
      âœ“ should return 200 with referral history (8 ms)
    POST /api/referral/click
      âœ“ should have correct click tracking request schema (6 ms)
      âœ“ should return 200 confirming tracking (5 ms)
      âœ“ should not require authentication (public tracking) (4 ms)
    POST /api/referral/share
      âœ“ should have correct share request schema (4 ms)
      âœ“ should validate email addresses (4 ms)
      âœ“ should return 200 with send confirmation (4 ms)
      âœ“ should return 400 if no active referral code (3 ms)
    POST /api/referral/process-reward
      âœ“ should have correct reward processing request schema (3 ms)
      âœ“ should return 200 with processing confirmation (4 ms)
      âœ“ should return 403 for non-admin users (4 ms)
      âœ“ should require authentication (6 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/utils/security.test.ts
  Security Utilities
    Password Hashing
      âœ“ should hash passwords securely (6 ms)
      âœ“ should verify correct passwords (4 ms)
      âœ“ should reject incorrect passwords (3 ms)
      âœ“ should use different salts for same password (3 ms)
      âœ“ should handle different bcrypt rounds (5 ms)
    Input Sanitization
      âœ“ should remove potentially dangerous characters (4 ms)
      âœ“ should remove javascript protocols (4 ms)
      âœ“ should remove event handlers (5 ms)
      âœ“ should preserve safe content (6 ms)
      âœ“ should trim whitespace (7 ms)
    JWT Token Structure
      âœ“ should parse valid JWT payload (4 ms)
      âœ“ should throw error for invalid JWT format (5 ms)
      âœ“ should throw error for malformed payload (4 ms)
      âœ“ should validate token expiration (4 ms)
    Rate Limiting Logic
      âœ“ should allow requests under limit (3 ms)
      âœ“ should block requests over limit (5 ms)
      âœ“ should handle different keys independently (4 ms)
      âœ“ should reset limits correctly (3 ms)
    User Input Validation
      âœ“ should validate user roles correctly (4 ms)
      âœ“ should validate UUID format (5 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/models/User.unit.test.ts
  User Model Logic
    Password Hashing
      âœ“ should hash password with bcrypt (3 ms)
      âœ“ should use environment variable for bcrypt rounds (4 ms)
      âœ“ should default to 14 rounds when not configured (3 ms)
    Password Comparison
      âœ“ should compare password correctly (3 ms)
      âœ“ should handle empty password (4 ms)
      âœ“ should handle null password gracefully (4 ms)
    User Validation Logic
      âœ“ should validate required fields (6 ms)
      âœ“ should validate email format (6 ms)
      âœ“ should accept valid email formats (4 ms)
      âœ“ should validate role enum (5 ms)
      âœ“ should accept valid roles (4 ms)
      âœ“ should handle valid user data (5 ms)
    User Defaults
      âœ“ should set default values (4 ms)
      âœ“ should allow overriding defaults (4 ms)
    UUID Generation
      âœ“ should generate valid UUID v4 (3 ms)
      âœ“ should generate unique UUIDs (2 ms)
    Edge Cases
      âœ“ should handle unicode characters in name (3 ms)
      âœ“ should handle very long strings (6 ms)
      âœ“ should handle null and undefined values (5 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/contracts/goals-api.contract.test.ts
  Goals API Contracts
    POST /api/goals
      âœ“ should have correct request schema validation (5 ms)
      âœ“ should return 201 with created goal on success (4 ms)
      âœ“ should return 400 for invalid category (3 ms)
      âœ“ should return 401 without authentication (3 ms)
    GET /api/goals
      âœ“ should support pagination query parameters (5 ms)
      âœ“ should support filtering query parameters (5 ms)
      âœ“ should return 200 with paginated results (4 ms)
      âœ“ should return empty array when no goals found (4 ms)
    GET /api/goals/:id
      âœ“ should return 200 with goal details (4 ms)
      âœ“ should return 404 when goal not found (3 ms)
      âœ“ should return 403 when accessing another user's goal (4 ms)
      âœ“ should return 400 for invalid UUID format (4 ms)
    PATCH /api/goals/:id
      âœ“ should have correct update request schema (4 ms)
      âœ“ should return 200 with updated goal (3 ms)
      âœ“ should return 422 for invalid progress value (4 ms)
    DELETE /api/goals/:id
      âœ“ should return 204 on successful deletion (3 ms)
      âœ“ should return 404 when goal not found (6 ms)
      âœ“ should return 403 when deleting another user's goal (6 ms)
    POST /api/goals/:id/milestones
      âœ“ should have correct milestone creation schema (4 ms)
      âœ“ should return 201 with created milestone (3 ms)
    GET /api/goals/:id/progress
      âœ“ should return 200 with progress analytics (4 ms)
    Authentication & Authorization Contract
      âœ“ should enforce authentication on all endpoints (4 ms)
      âœ“ should enforce resource ownership (3 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/security/input-validation.test.ts
  Security Tests: Input Validation
    SQL Injection Prevention
      âœ“ should use parameterized queries for user input (6 ms)
      âœ“ should reject SQL injection attempts in all payloads (8 ms)
      âœ“ should not allow string concatenation in queries (5 ms)
    XSS Prevention
      âœ“ should sanitize HTML in user input (5 ms)
      âœ“ should escape special characters in output (4 ms)
      âœ“ should set Content-Security-Policy headers (6 ms)
    Path Traversal Prevention
      âœ“ should reject path traversal attempts (7 ms)
      âœ“ should only allow whitelisted file paths (4 ms)
    Command Injection Prevention
      âœ“ should reject command injection attempts (6 ms)
      âœ“ should use safe parameter passing (6 ms)
    NoSQL Injection Prevention
      âœ“ should sanitize MongoDB queries (4 ms)
      âœ“ should validate ObjectId format (8 ms)
    Input Length Validation
      âœ“ should reject excessively long inputs (5 ms)
      âœ“ should enforce maximum file upload size (4 ms)
    Email Validation
      âœ“ should validate email format (5 ms)
      âœ“ should reject disposable email domains (5 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/validation/auth.validation.test.ts
  Auth Validation Logic
    Email Validation
      âœ“ should validate correct email formats (5 ms)
      âœ“ should reject invalid email formats (7 ms)
    Password Strength Validation
      âœ“ should accept strong passwords (5 ms)
      âœ“ should reject short passwords (5 ms)
      âœ“ should reject passwords without uppercase (3 ms)
      âœ“ should reject passwords without lowercase (3 ms)
      âœ“ should reject passwords without numbers (3 ms)
      âœ“ should reject passwords without special characters (6 ms)
      âœ“ should return all missing requirements (3 ms)
    Registration Data Validation
      âœ“ should validate complete valid registration data (4 ms)
      âœ“ should require all mandatory fields (3 ms)
      âœ“ should validate email format in registration (4 ms)
      âœ“ should validate password strength in registration (4 ms)
      âœ“ should validate name length (6 ms)
      âœ“ should validate role if provided (4 ms)
      âœ“ should accept valid roles (5 ms)
    Edge Cases
      âœ“ should handle unicode characters in names (3 ms)
      âœ“ should handle very long names (4 ms)
      âœ“ should handle null and undefined values gracefully (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/contracts/auth-api.contract.test.ts
  Authentication API Contracts
    POST /api/auth/register
      âœ“ should have correct request schema validation (5 ms)
      âœ“ should return 201 with user and token on success (6 ms)
      âœ“ should return 400 for validation errors (4 ms)
      âœ“ should return 409 when email already exists (4 ms)
    POST /api/auth/login
      âœ“ should have correct request schema (3 ms)
      âœ“ should return 200 with user and token on success (5 ms)
      âœ“ should return 401 for invalid credentials (5 ms)
      âœ“ should return 429 after rate limit exceeded (4 ms)
    POST /api/auth/logout
      âœ“ should require authentication (4 ms)
      âœ“ should return 200 on successful logout (5 ms)
      âœ“ should return 401 without valid token (4 ms)
    POST /api/auth/refresh-token
      âœ“ should have correct request schema (4 ms)
      âœ“ should return 200 with new tokens (6 ms)
      âœ“ should return 401 for invalid refresh token (5 ms)
    GET /api/auth/me
      âœ“ should require authentication (4 ms)
      âœ“ should return 200 with current user (3 ms)
      âœ“ should return 401 without authentication (4 ms)
    Error Response Format Contract
      âœ“ should have consistent error response schema (4 ms)
      âœ“ should include validation details for 400 errors (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/contracts/financial-api.contract.test.ts
  Financial API Contracts
    POST /api/financial/webhook/stripe
      âœ“ should require stripe-signature header (6 ms)
      âœ“ should return 400 for missing signature (6 ms)
      âœ“ should return 400 for invalid signature (5 ms)
      âœ“ should return 200 with event details on success (4 ms)
    GET /api/financial/revenue/mrr
      âœ“ should return 200 with MRR metrics (3 ms)
    GET /api/financial/revenue/arr
      âœ“ should return 200 with ARR metrics (4 ms)
    GET /api/financial/subscriptions/churn
      âœ“ should support date range parameters (5 ms)
      âœ“ should return 200 with churn metrics (5 ms)
    GET /api/financial/subscriptions/ltv
      âœ“ should return 200 with LTV analytics (4 ms)
    POST /api/financial/costs
      âœ“ should have correct cost creation request schema (4 ms)
      âœ“ should return 201 with created cost (3 ms)
      âœ“ should return 403 without modify permission (4 ms)
    POST /api/financial/reports/send
      âœ“ should have correct report send request schema (5 ms)
      âœ“ should validate email addresses (7 ms)
      âœ“ should return 200 with send confirmation (5 ms)
    POST /api/financial/reports/schedule
      âœ“ should have correct schedule request schema (5 ms)
      âœ“ should return 200 with schedule confirmation (4 ms)
    GET /api/financial/unit-economics/ltv-cac
      âœ“ should return 200 with LTV:CAC ratio (3 ms)
    GET /api/financial/cohorts
      âœ“ should return 200 with cohort analysis (4 ms)
    GET /api/financial/analytics/forecast
      âœ“ should return 200 with revenue forecast (4 ms)
    GET /api/financial/analytics/alerts
      âœ“ should return 200 with financial alerts (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/GoalManagementService.test.ts
  GoalManagementService Integration
    createGoal
      âœ“ should create goal successfully (6 ms)
      âœ“ should award points for creating goal (4 ms)
      âœ“ should unlock "First Goal" achievement for first goal (3 ms)
      âœ“ should not unlock achievement for subsequent goals (4 ms)
    updateProgress
      âœ“ should update goal progress (4 ms)
      âœ“ should auto-complete goal when progress reaches 100% (4 ms)
    completeGoal
      âœ“ should complete goal and award points (4 ms)
      âœ“ should unlock "Goal Achiever" achievement for first completion (4 ms)
      âœ“ should throw error if goal not found (4 ms)
    getAIRecommendations
      âœ“ should get AI recommendations for goal (5 ms)
      âœ“ should throw error if goal not found (5 ms)
    Milestone Management
      âœ“ should add milestone to goal (8 ms)
      âœ“ should complete milestone and update goal progress (4 ms)
    Full Goal Lifecycle Integration
      âœ“ should complete full goal workflow with milestones (6 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/service-integration/UserRegistrationService.test.ts
  UserRegistrationService Integration
    register
      âœ“ should successfully register a new user (5 ms)
      âœ“ should throw error if email already registered (4 ms)
      âœ“ should initialize gamification for new user (7 ms)
      âœ“ should send verification email after registration (3 ms)
      âœ“ should handle service errors gracefully (6 ms)
    verifyEmail
      âœ“ should verify user email successfully (4 ms)
      âœ“ should throw error if user not found (3 ms)
      âœ“ should award points for email verification (4 ms)
    completeOnboarding
      âœ“ should complete onboarding successfully (5 ms)
      âœ“ should unlock welcome achievement (3 ms)
      âœ“ should track interests and goals count (4 ms)
    Full Registration Flow Integration
      âœ“ should complete entire registration workflow (5 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/services/UserService.minimal.test.ts
  UserService - Minimal Coverage
    âœ“ should import UserService without errors (24 ms)
    âœ“ should handle basic service operations (3 ms)
    âœ“ should validate service structure (5 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/performance/critical-endpoints.test.ts
  Performance Tests: Critical Endpoints
    Authentication Performance
      âœ“ should validate JWT token under 50ms (12 ms)
      âœ“ should handle 100 concurrent JWT verifications (8 ms)
    Goal Retrieval Performance
      âœ“ should fetch user goals under 200ms (5 ms)
      âœ“ should fetch single goal under 100ms (5 ms)
    Coaching Session Query Performance
      âœ“ should fetch upcoming sessions under 200ms (5 ms)
      âœ“ should search available coaches under 500ms (4 ms)
    Dashboard Metrics Performance
      âœ“ should calculate dashboard metrics under 1s (4 ms)
    Cache Performance
      âœ“ should retrieve cached data under 10ms (6 ms)
      âœ“ should set cached data under 20ms (5 ms)
    Concurrent Load Testing
      âœ“ should handle 50 concurrent goal updates (4 ms)
      âœ“ should handle 100 concurrent authentication requests (6 ms)
    Database Query Performance
      âœ“ should execute simple SELECT under 10ms (7 ms)
      âœ“ should execute complex JOIN under 100ms (6 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    ===== TESTING DB MOCK =====

       7 |   it('should use mocked db.insert', async () => {
       8 |     console.error('===== TESTING DB MOCK =====');
    >  9 |
         | ^
      10 |     console.error('db object:', typeof db);
      11 |     console.error('db.insert:', typeof db.insert);
      12 |

      at Object.<anonymous> (src/tests/db-mock-test.test.ts:9:17)

  console.error
    db object: object

       8 |     console.error('===== TESTING DB MOCK =====');
       9 |
    > 10 |     console.error('db object:', typeof db);
         |                 ^
      11 |     console.error('db.insert:', typeof db.insert);
      12 |
      13 |     const result = await db.insert('users', {

      at Object.<anonymous> (src/tests/db-mock-test.test.ts:10:17)

  console.error
    db.insert: function

       9 |
      10 |     console.error('db object:', typeof db);
    > 11 |     console.error('db.insert:', typeof db.insert);
         |                 ^
      12 |
      13 |     const result = await db.insert('users', {
      14 |       email: 'test@example.com',

      at Object.<anonymous> (src/tests/db-mock-test.test.ts:11:17)

  console.error
    [DB MANUAL MOCK] insert called: { table: 'users', dataKeys: [ 'email', 'password_hash', 'name' ] }

      44 |   },
      45 |
    > 46 |   findAll: async (table: string = 'unknown') => {
         |                 ^
      47 |     console.error('[DB MANUAL MOCK] findAll called:', { table });
      48 |     return mockStorage[table] || [];
      49 |   },

      at Object.insert (src/services/__mocks__/database.ts:46:17)
      at Object.<anonymous> (src/tests/db-mock-test.test.ts:12:44)

  console.error
    [DB MANUAL MOCK] Stored and returning user: { id: 'test-user-id-k91o18', email: 'test@example.com', totalUsers: 1 }

      72 |         lastLoginAt: null,
      73 |         createdAt: new Date(),
    > 74 |         updatedAt: new Date(),
         |                     ^
      75 |       };
      76 |
      77 |       // Store in mock storage for retrieval

      at Object.insert (src/services/__mocks__/database.ts:74:21)
      at Object.<anonymous> (src/tests/db-mock-test.test.ts:12:44)

  console.error
    Result: {
      "id": "test-user-id-k91o18",
      "email": "test@example.com",
      "passwordHash": "hashed_password",
      "name": "Test User",
      "bio": null,
      "role": "user",
      "isActive": true,
      "isEmailVerified": false,
      "avatar": null,
      "avatarUrl": null,
      "googleId": null,
      "onboardingCompleted": false,
      "onboardingCompletedAt": null,
      "onboardingSkipped": false,
      "preferences": {},
      "lastLoginAt": null,
      "createdAt": "2025-11-15T06:46:10.557Z",
      "updatedAt": "2025-11-15T06:46:10.557Z"
    }

      15 |       password_hash: 'hashed_password',
      16 |       name: 'Test User',
    > 17 |     });
         |        ^
      18 |
      19 |     console.error('Result:', JSON.stringify(result, null, 2));
      20 |     console.error('Result ID:', result?.id);

      at Object.<anonymous> (src/tests/db-mock-test.test.ts:17:17)

  console.error
    Result ID: test-user-id-k91o18

      16 |       name: 'Test User',
      17 |     });
    > 18 |
         | ^
      19 |     console.error('Result:', JSON.stringify(result, null, 2));
      20 |     console.error('Result ID:', result?.id);
      21 |

      at Object.<anonymous> (src/tests/db-mock-test.test.ts:18:17)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/tests/db-mock-test.test.ts
  Database Mock Test
    âœ“ should use mocked db.insert (15 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/contracts/coaching-api.contract.test.ts
  Coaching API Contracts
    POST /api/coaching/sessions
      âœ“ should have correct session booking request schema (5 ms)
      âœ“ should return 201 with session details on success (6 ms)
      âœ“ should return 409 for double-booking conflicts (4 ms)
    GET /api/coaches/search
      âœ“ should support search and filter parameters (4 ms)
      âœ“ should return 200 with coach list and pagination (4 ms)
    PATCH /api/coaching/sessions/:id/complete
      âœ“ should have correct completion request schema (5 ms)
      âœ“ should return 200 with completed session (3 ms)
      âœ“ should return 403 if not the coach (3 ms)
    POST /api/coaching/sessions/:id/rate
      âœ“ should have correct rating request schema (4 ms)
      âœ“ should return 200 with updated coach rating (8 ms)
      âœ“ should return 400 for invalid rating value (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/minimal.test.ts
  Minimal Test Suite - Infrastructure Validation
    âœ“ should pass basic assertion (6 ms)
    âœ“ should perform basic arithmetic (5 ms)
    âœ“ should handle string operations (4 ms)
    âœ“ should handle array operations (3 ms)
    âœ“ should handle object operations (5 ms)
    âœ“ should handle async operations (3 ms)
    âœ“ should handle basic type checks (5 ms)
  Environment Validation
    âœ“ should have Node.js environment (3 ms)
    âœ“ should have access to globals (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] injectPool called

      152 |   },
      153 |
    > 154 |   transaction: async (callback: (client: unknown) => Promise<unknown>) => {
          |                 ^
      155 |     console.error('[DB MANUAL MOCK] transaction called');
      156 |     return await callback({
      157 |       query: async () => ({ rows: [], rowCount: 0 }),

      at Function.injectPool (src/services/__mocks__/database.ts:154:17)
      at Object.<anonymous> (src/tests/setup.ts:231:32)

  console.error
    [TEST SETUP] Injected mocked Pool into DatabaseService

      230 | export const mockAdminUser = {
      231 |   id: 'admin-user-123',
    > 232 |   email: 'admin@example.com',
          |             ^
      233 |   name: 'Admin User',
      234 |   role: 'admin',
      235 |   createdAt: new Date(),

      at Object.<anonymous> (src/tests/setup.ts:232:13)

  console.error
    [DB MANUAL MOCK] reset called

      158 |       commit: async () => {},
      159 |       rollback: async () => {},
    > 160 |     });
          |        ^
      161 |   },
      162 | };
      163 |

      at Function.reset (src/services/__mocks__/database.ts:160:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.error
    [DB MANUAL MOCK] Mock storage cleared

      168 |
      169 |   static getInstance() {
    > 170 |     if (!DatabaseService.instance) {
          |                 ^
      171 |       DatabaseService.instance = new DatabaseService();
      172 |     }
      173 |     return DatabaseService.instance;

      at Function.reset (src/services/__mocks__/database.ts:170:17)
      at Object.<anonymous> (src/tests/setup.ts:240:32)

  console.log
    ðŸ§¹ Test cleanup completed

      at Object.<anonymous> (src/tests/setup.ts:260:13)

PASS src/__tests__/controllers/health.minimal.test.ts
  Health Controller - Minimal Coverage
    âœ“ should handle health check endpoint (6 ms)
    âœ“ should validate basic controller structure (4 ms)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

FAIL src/__tests__/services/EmailService.test.ts
  â— Test suite failed to run

    TypeError: nodemailer_1.default.createTransporter is not a function



      at EmailService.initializeTransporter (src/services/EmailService.ts:1396:47)
      at new EmailService (src/services/EmailService.ts:1344:10)
      at Object.<anonymous> (src/services/EmailService.ts:1824:24)
      at Object.<anonymous> (src/__tests__/services/EmailService.test.ts:8:24)

  console.error
    [JEST SETUP] jest.setup.ts is loading...

      339 |     close: jest.fn(),
      340 |     define: jest.fn(),
    > 341 |     literal: jest.fn((val) => ({ val })),
          |         ^
      342 |   },
      343 | }));
      344 |

      at Object.<anonymous> (src/tests/jest.setup.ts:341:9)

  console.error
    [JEST SETUP] Setting up model mocks...

      362 | }));
      363 |
    > 364 | // Mock database models - this is for when code imports from '../models' index file
          |         ^
      365 | jest.mock('../models', () => {
      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;

      at Object.<anonymous> (src/tests/jest.setup.ts:364:9)

  console.error
    [JEST SETUP] Setting up database mock (using manual mock)...

      366 |   // Re-use the User mock defined above by requiring it after jest.mock has been set up
      367 |   let UserMock;
    > 368 |   try {
          |        ^
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
      370 |     UserMock = jest.requireMock('../models/User').User;
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);

      at Object.<anonymous> (src/tests/jest.setup.ts:368:9)

  console.error
    [JEST SETUP] Setting up redis mock (using manual mock)...

      368 |   try {
      369 |     console.error('[JEST SETUP] Attempting to load User mock from requireMock...');
    > 370 |     UserMock = jest.requireMock('../models/User').User;
          |         ^
      371 |     console.error('[JEST SETUP] User mock loaded successfully, type:', typeof UserMock);
      372 |     console.error('[JEST SETUP] UserMock.create type:', typeof UserMock?.create);
      373 |   } catch (e) {

      at Object.<anonymous> (src/tests/jest.setup.ts:370:9)

  console.error
    [MANUAL MOCK] database.ts manual mock is loading...

       6 | console.error('[MANUAL MOCK] database.ts manual mock is loading...');
       7 |
    >  8 | // In-memory storage for mock data (cleared on reset)
         |         ^
       9 | const mockStorage: Record<string, any[]> = {
      10 |   users: [],
      11 |   goals: [],

      at Object.<anonymous> (src/services/__mocks__/database.ts:8:9)
      at Object.<anonymous> (src/tests/setup.ts:178:20)

FAIL src/__tests__/controllers/CoachController.test.ts
  â— Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'isString')



      at CoachController.<instance_members_initializer> (src/controllers/CoachController.ts:3989:89)
      at new CoachController (src/controllers/CoachController.ts:3985:1)
      at Object.<anonymous> (src/controllers/CoachController.ts:5227:27)
      at Object.<anonymous> (src/__tests__/controllers/CoachController.test.ts:21:27)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/services/api/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
------------------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                            | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
------------------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                                       |    4.93 |     3.48 |    4.15 |    5.01 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
 src                                            |   28.05 |       13 |   13.63 |   29.82 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  app.ts                                        |   57.27 |    26.53 |   28.57 |   58.33 | 39-74,84,112,158,163-167,184-186,200-211,220-243,252                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  index.ts                                      |      88 |      100 |   66.66 |      88 | 32-33,48                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  server.ts                                     |       0 |        0 |       0 |       0 | 2-282                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/config                                     |    3.79 |     6.49 |    2.32 |    3.76 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  database.ts                                   |       0 |        0 |       0 |       0 | 2-234                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  environment.ts                                |   48.38 |    23.88 |      25 |      50 | 122-132,183-196                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  i18n.ts                                       |   85.71 |        0 |      50 |   91.66 | 40                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  redis.ts                                      |       0 |        0 |       0 |       0 | 2-57                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  secrets-manager.ts                            |       0 |        0 |       0 |       0 | 2-270                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  secrets.ts                                    |       0 |        0 |       0 |       0 | 2-300                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  sequelize-optimized.ts                        |       0 |        0 |       0 |       0 | 2-277                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  sequelize.ts                                  |       0 |        0 |     100 |       0 | 2-20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  session.ts                                    |       0 |        0 |       0 |       0 | 2-367                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/controllers                                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AIAnalyticsController.ts                      |       0 |        0 |       0 |       0 | 2-213                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AdminMetricsController.ts                     |       0 |        0 |       0 |       0 | 2-27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  AdvancedAnalyticsController.ts                |       0 |        0 |       0 |       0 | 2-383                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AnalyticsDashboardController.ts               |       0 |        0 |       0 |       0 | 7-503                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachController.ts                            |       0 |        0 |       0 |       0 | 2-610                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachIntelligenceController.ts                |       0 |        0 |       0 |       0 | 2-1015                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  CoachIntelligenceMLController.ts              |       0 |        0 |       0 |       0 | 7-553                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  EnterpriseController.ts                       |       0 |        0 |       0 |       0 | 2-355                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  GamificationController.ts                     |       0 |        0 |       0 |       0 | 2-418                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  MarketplaceController.ts                      |       0 |        0 |       0 |       0 | 2-37                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  OnboardingController.ts                       |       0 |        0 |       0 |       0 | 2-604                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ReferralAnalyticsController.ts                |       0 |        0 |       0 |       0 | 2-163                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  TwoFactorAuthController.ts                    |       0 |        0 |       0 |       0 | 6-496                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  VoiceJournalController.ts                     |       0 |        0 |       0 |       0 | 2-602                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/controllers/ai                             |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AIController.ts                               |       0 |        0 |       0 |       0 | 2-562                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  LocalLLMController.ts                         |       0 |        0 |       0 |       0 | 6-281                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UserProfilingController.ts                    |       0 |        0 |       0 |       0 | 2-162                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  index.ts                                      |       0 |        0 |       0 |       0 | 8-93                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/controllers/cms                            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ArticleController.ts                          |       0 |        0 |       0 |       0 | 2-525                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CMSController.ts                              |       0 |        0 |       0 |       0 | 2-846                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachContentController.ts                     |       0 |        0 |       0 |       0 | 2-493                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentCategoryController.ts                  |       0 |        0 |       0 |       0 | 2-227                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentController.ts                          |       0 |        0 |       0 |       0 | 2-641                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentTagController.ts                       |       0 |        0 |       0 |       0 | 2-246                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  MediaController.ts                            |       0 |        0 |       0 |       0 | 2-354                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  TemplateController.ts                         |       0 |        0 |       0 |       0 | 2-559                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/controllers/community                      |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ForumController.ts                            |       0 |        0 |       0 |       0 | 2-233                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/controllers/experiments                    |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ExperimentsController.ts                      |       0 |        0 |       0 |       0 | 2-366                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/controllers/financial                      |    3.37 |      1.6 |    1.88 |    3.58 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  FinancialDashboardController.ts               |     4.9 |     2.29 |    2.89 |     5.2 | 26-27,40-664,676-677,690,700-1604,1616-1617,1629-1636,1640,1653-2271,2296                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  FinancialDashboardControllerEnhanced.ts       |       0 |        0 |       0 |       0 | 8-1061                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/database                                   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  connection.ts                                 |       0 |        0 |       0 |       0 | 2-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/interfaces                                 |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  IEmailService.ts                              |       0 |        0 |       0 |       0 | 5-33                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/lib                                        |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  circuit-breaker.ts                            |       0 |        0 |       0 |       0 | 6-197                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  retry.ts                                      |       0 |        0 |       0 |       0 | 6-93                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/middleware                                 |   12.15 |    10.17 |   10.25 |   12.31 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  advancedRateLimit.ts                          |       0 |        0 |       0 |       0 | 6-383                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  aiInputValidation.ts                          |       0 |        0 |       0 |       0 | 2-264                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  auditTrail.ts                                 |       0 |        0 |       0 |       0 | 2-240                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  auth.ts                                       |   44.02 |    19.29 |   46.15 |   44.02 | 39-43,63-105,116-123,130-156,163-178,185-215,225-249,284,297-305,313-325                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  authorization.ts                              |       0 |        0 |       0 |       0 | 2-222                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  authorize-secure.ts                           |       0 |        0 |       0 |       0 | 2-431                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  authorize.ts                                  |       0 |        0 |       0 |       0 | 2-147                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  caching-middleware.ts                         |       0 |        0 |       0 |       0 | 2-373                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  cdn.ts                                        |       0 |        0 |       0 |       0 | 2-162                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  csrf.ts                                       |       0 |        0 |       0 |       0 | 2-214                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  error.ts                                      |   48.71 |    47.36 |      20 |   48.71 | 9-12,20-21,24-25,28-29,32-33,36-37,40-41,45,71,79-80                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  errorHandler.ts                               |   56.48 |    45.83 |   54.54 |      57 | 40-43,51-54,59-60,63-64,67-68,71-79,162-163,180-229                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  i18n.ts                                       |   56.66 |    55.55 |   16.66 |   56.66 | 25,28,42-63                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  notFoundHandler.ts                            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  performance.ts                                |       0 |        0 |       0 |       0 | 2-176                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  rateLimiter-secure.ts                         |       0 |        0 |       0 |       0 | 2-418                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  rateLimiter.ts                                |   27.27 |    19.04 |      20 |   27.58 | 21-26,126-181,190-222,236-256,264-299                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  resourceAccess.ts                             |       0 |        0 |       0 |       0 | 2-421                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  role.ts                                       |       0 |        0 |       0 |       0 | 6-30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  roleAuth.ts                                   |       0 |        0 |       0 |       0 | 2-24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  secureUpload.ts                               |       0 |        0 |       0 |       0 | 2-348                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  security-hardening.ts                         |       0 |        0 |       0 |       0 | 2-318                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  security.ts                                   |       0 |        0 |       0 |       0 | 2-487                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  securityHeaders.ts                            |   63.63 |    50.84 |    62.5 |   63.63 | 72,92,129,153,156,172-173,194-233,241-243,255-323                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  securityNonce.ts                              |       0 |        0 |       0 |       0 | 2-71                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  sqlInjectionProtection.ts                     |   82.17 |    78.26 |   70.58 |   83.67 | 142-144,175-176,207,235,258-270,285-292                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  upload.ts                                     |       0 |        0 |       0 |       0 | 2-185                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  validation.ts                                 |       0 |        0 |       0 |       0 | 2-285                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  webhookSecurity.ts                            |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  zodValidation.ts                              |       0 |        0 |       0 |       0 | 2-439                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/middleware/auth                            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  supabaseAuth.ts                               |       0 |        0 |       0 |       0 | 2-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/migrations                                 |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  20240100000000-create-base-schema.ts          |       0 |      100 |       0 |       0 | 2-322                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  20240101000000-create-financial-models.ts     |       0 |      100 |       0 |       0 | 2-1035                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  20240101000002-create-organizations.ts        |       0 |      100 |       0 |       0 | 2-125                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  20240101000003-create-organization-members.ts |       0 |      100 |       0 |       0 | 2-97                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  20240102000000-create-cms-models.ts           |       0 |      100 |       0 |       0 | 2-557                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  20240108000000-add-google-auth-fields.ts      |       0 |      100 |       0 |       0 | 2-81                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models                                     |    4.66 |        0 |       0 |     5.1 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AIFeedback.ts                                 |       0 |        0 |       0 |       0 | 2-121                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AIInteraction.ts                              |       0 |        0 |       0 |       0 | 2-152                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Chat.ts                                       |      75 |      100 |       0 |      75 | 18-19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ChatMessage.ts                                |   66.66 |      100 |       0 |   66.66 | 17-22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachPackage.ts                               |       0 |        0 |       0 |       0 | 2-329                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachProfile.ts                               |       0 |        0 |       0 |       0 | 2-307                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachReview.ts                                |       0 |        0 |       0 |       0 | 2-318                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachSession.ts                               |       0 |        0 |       0 |       0 | 2-347                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Goal.ts                                       |      75 |      100 |       0 |      75 | 22-23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ModelCompatibility.ts                         |       0 |      100 |       0 |       0 | 5-24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  Mood.ts                                       |   85.71 |      100 |       0 |   85.71 | 22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  Organization.ts                               |       0 |        0 |       0 |       0 | 2-127                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  OrganizationMember.ts                         |       0 |        0 |       0 |       0 | 2-274                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Referral.ts                                   |       0 |        0 |       0 |       0 | 2-213                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Task.ts                                       |      75 |      100 |       0 |      75 | 24-25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Team.ts                                       |       0 |      100 |       0 |       0 | 2-77                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  User.ts                                       |       0 |        0 |       0 |       0 | 2-142                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UserActivity.ts                               |       0 |      100 |       0 |       0 | 2-23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  UserProfile.ts                                |   66.66 |        0 |       0 |   66.66 | 33-36                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  VoiceJournalEntry.ts                          |       0 |      100 |       0 |       0 | 2-155                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  index.ts                                      |       0 |        0 |       0 |       0 | 2-206                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  interfaces.ts                                 |       0 |      100 |     100 |       0 | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  modelInitializer.ts                           |       0 |        0 |       0 |       0 | 2-48                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models/analytics                           |   16.66 |        0 |       0 |   18.18 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  KpiTracker.ts                                 |   15.21 |        0 |       0 |   16.66 | 36-111                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  UserAnalytics.ts                              |   18.42 |        0 |       0 |      20 | 25-74,193-195                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 src/models/cms                                 |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  Article.ts                                    |       0 |        0 |       0 |       0 | 2-369                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Category.ts                                   |       0 |        0 |       0 |       0 | 2-401                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Comment.ts                                    |       0 |        0 |       0 |       0 | 2-400                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Content.ts                                    |       0 |      100 |       0 |       0 | 2-190                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentAnalytics.ts                           |       0 |        0 |       0 |       0 | 2-320                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentArticle.ts                             |       0 |        0 |       0 |       0 | 2-331                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentCategory.ts                            |       0 |      100 |       0 |       0 | 2-99                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentComment.ts                             |       0 |      100 |     100 |       0 | 2-74                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentInteraction.ts                         |       0 |      100 |     100 |       0 | 2-57                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentMedia.ts                               |       0 |      100 |       0 |       0 | 2-130                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ContentModelRegistry.ts                       |       0 |      100 |       0 |       0 | 2-34                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentSchedule.ts                            |       0 |      100 |     100 |       0 | 2-77                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentTag.ts                                 |       0 |      100 |       0 |       0 | 2-73                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentTemplate.ts                            |       0 |      100 |     100 |       0 | 2-70                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ContentVersion.ts                             |       0 |      100 |     100 |       0 | 2-80                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  Course.ts                                     |       0 |        0 |       0 |       0 | 2-461                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Media.ts                                      |       0 |        0 |       0 |       0 | 2-344                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Template.ts                                   |       0 |        0 |       0 |       0 | 2-271                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedCategory.ts                            |       0 |      100 |       0 |       0 | 6-110                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedContent.ts                             |       0 |        0 |       0 |       0 | 7-525                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedInteraction.ts                         |       0 |      100 |       0 |       0 | 6-84                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  UnifiedMedia.ts                               |       0 |      100 |       0 |       0 | 6-148                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedTag.ts                                 |       0 |      100 |       0 |       0 | 6-83                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  index.ts                                      |       0 |      100 |       0 |       0 | 6-99                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models/coaching                            |   21.87 |        0 |       0 |   24.13 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CoachMemory.ts                                |   21.87 |        0 |       0 |   24.13 | 32-77                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/models/community                           |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CommunityGroup.ts                             |       0 |      100 |       0 |       0 | 2-132                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ForumCategory.ts                              |       0 |      100 |       0 |       0 | 2-77                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ForumPost.ts                                  |       0 |      100 |       0 |       0 | 2-137                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ForumThread.ts                                |       0 |      100 |       0 |       0 | 2-124                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ForumVote.ts                                  |       0 |      100 |       0 |       0 | 2-75                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models/compliance                          |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  PHIAccessLog.ts                               |       0 |      100 |     100 |       0 | 2-25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SOC2Assessment.ts                             |       0 |      100 |     100 |       0 | 2-26                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SOC2Audit.ts                                  |       0 |      100 |     100 |       0 | 2-24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SOC2Control.ts                                |       0 |      100 |     100 |       0 | 2-27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SOC2Incident.ts                               |       0 |      100 |     100 |       0 | 2-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SystemMetrics.ts                              |       0 |      100 |     100 |       0 | 2-23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  index.ts                                      |       0 |      100 |       0 |       0 | 2-21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models/experiments                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  Experiment.ts                                 |       0 |        0 |       0 |       0 | 2-125                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ExperimentAssignment.ts                       |       0 |      100 |       0 |       0 | 2-64                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ExperimentEvent.ts                            |       0 |        0 |       0 |       0 | 2-122                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/models/financial                           |    7.74 |     3.92 |    5.35 |    7.74 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  BillingEvent.ts                               |       0 |        0 |       0 |       0 | 2-103                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Budget.ts                                     |       0 |        0 |       0 |       0 | 5-211                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CostTracking.ts                               |       0 |        0 |       0 |       0 | 2-198                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  FinancialReport.ts                            |   74.19 |    46.15 |      50 |   74.19 | 48-74                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  FinancialSnapshot.ts                          |       0 |        0 |       0 |       0 | 2-305                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  RevenueAnalytics.ts                           |       0 |        0 |       0 |       0 | 2-222                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Subscription.ts                               |       0 |        0 |       0 |       0 | 2-291                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  Transaction.ts                                |       0 |        0 |       0 |       0 | 2-79                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/models/personality                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  Avatar.ts                                     |       0 |        0 |       0 |       0 | 2-398                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  PersonalityProfile.ts                         |       0 |        0 |       0 |       0 | 2-311                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UserAvatarPreference.ts                       |       0 |        0 |       0 |       0 | 2-237                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/routes                                     |    4.28 |     2.54 |    4.34 |    4.32 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  advancedAnalytics.ts                          |       0 |      100 |     100 |       0 | 2-24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ai.ts                                         |       0 |      100 |     100 |       0 | 2-100                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  aiAnalytics.ts                                |       0 |      100 |     100 |       0 | 2-28                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  analytics.routes.ts                           |       0 |      100 |     100 |       0 | 7-117                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  auth.ts                                       |   53.38 |    34.21 |   46.15 |   53.38 | 98,121-141,151-161,168-182,189-193,203-208,217-223,248-261,275-299                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  chat.ts                                       |       0 |        0 |       0 |       0 | 2-455                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  cms.ts                                        |       0 |      100 |     100 |       0 | 2-46                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  coach.ts                                      |       0 |      100 |     100 |       0 | 2-33                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  coachContent.ts                               |       0 |        0 |       0 |       0 | 2-56                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  coachIntelligence.ts                          |       0 |      100 |     100 |       0 | 2-128                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  coachIntelligenceSecure.ts                    |       0 |      100 |     100 |       0 | 2-153                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  csrf.ts                                       |       0 |        0 |       0 |       0 | 2-29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  enterprise.ts                                 |       0 |      100 |     100 |       0 | 2-85                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  experiments.ts                                |       0 |        0 |       0 |       0 | 2-94                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  financial.ts                                  |       0 |        0 |       0 |       0 | 2-284                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  forum.ts                                      |       0 |      100 |     100 |       0 | 2-40                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  gamification.ts                               |       0 |      100 |     100 |       0 | 2-27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  goals.ts                                      |       0 |        0 |       0 |       0 | 2-412                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  googleAuth.ts                                 |       0 |        0 |       0 |       0 | 2-393                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  health.ts                                     |       0 |        0 |       0 |       0 | 2-324                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  index.ts                                      |       0 |      100 |       0 |       0 | 2-179                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  localLLM.ts                                   |       0 |      100 |     100 |       0 | 6-21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  marketplace.ts                                |       0 |      100 |     100 |       0 | 2-8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  metrics.ts                                    |       0 |      100 |     100 |       0 | 2-8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  ml.routes.ts                                  |       0 |        0 |       0 |       0 | 7-362                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  mobile.ts                                     |       0 |      100 |       0 |       0 | 6-30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  mood.ts                                       |       0 |        0 |       0 |       0 | 2-354                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  onboarding.ts                                 |       0 |      100 |       0 |       0 | 2-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  referral.ts                                   |       0 |        0 |       0 |       0 | 2-267                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  referralAnalytics.ts                          |       0 |      100 |     100 |       0 | 2-21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  security.ts                                   |       0 |        0 |       0 |       0 | 6-230                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  tasks.ts                                      |       0 |        0 |       0 |       0 | 2-271                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  twoFactorAuth.ts                              |       0 |      100 |     100 |       0 | 5-51                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  users.ts                                      |   36.73 |        0 |       0 |   36.73 | 20-25,34-41,51-53,62-65,74,90-95,104-111                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  voiceJournal.ts                               |       0 |      100 |     100 |       0 | 2-56                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/routes/analytics                           |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  performance.ts                                |       0 |        0 |       0 |       0 | 6-291                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/routes/auth                                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  google.ts                                     |       0 |        0 |       0 |       0 | 2-240                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/routes/dashboard                           |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  realtime.ts                                   |       0 |        0 |       0 |       0 | 2-438                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/routes/v2                                  |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  branding.ts                                   |       0 |        0 |       0 |       0 | 2-19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  devices.ts                                    |       0 |        0 |       0 |       0 | 2-41                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  index.ts                                      |       0 |      100 |       0 |       0 | 2-55                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  reports.ts                                    |       0 |        0 |       0 |       0 | 2-36                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  shared-goals.ts                               |       0 |        0 |       0 |       0 | 2-61                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  sync.ts                                       |       0 |        0 |       0 |       0 | 2-65                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  users.ts                                      |       0 |        0 |       0 |       0 | 2-30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/routes/v2/auth                             |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  google.ts                                     |       0 |        0 |       0 |       0 | 2-342                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  index.ts                                      |       0 |      100 |       0 |       0 | 2-28                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/routes/webhooks                            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  revenuecat.ts                                 |       0 |        0 |       0 |       0 | 2-161                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/scripts                                    |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  consolidate-cms-models.ts                     |       0 |        0 |       0 |       0 | 7-304                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/security                                   |   29.96 |    23.42 |   29.78 |   30.14 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  PromptInjectionProtector.ts                   |    6.92 |        0 |    4.54 |    7.14 | 101-447                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  SecureCredentialManager.ts                    |   49.04 |    44.06 |      52 |   48.71 | 37,68-80,90-98,102-113,130-144,177-186,196-210,257,264,287,309,319-370,378,382,386-471                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/services                                   |    17.7 |    14.59 |   18.13 |   17.43 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DatabaseService.ts                            |   63.63 |       50 |   33.33 |   63.63 | 19-30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  EmailService.ts                               |       0 |        0 |       0 |       0 | 6-348                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  EnhancedAuthService.ts                        |       0 |        0 |       0 |       0 | 2-394                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  NotificationService.ts                        |   14.65 |     3.57 |   14.28 |   14.78 | 28-304,313-332                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
  RedisService.ts                               |   53.33 |       50 |      30 |   53.33 | 19-42                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SchedulerService.ts                           |   44.89 |    11.76 |   38.23 |   44.52 | 108,134-335,341                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  TwoFactorAuthService.ts                       |   22.46 |    24.04 |   27.77 |   21.72 | 55-57,72-909,931-935,943,966,1017,1048,1079                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  VoiceJournalLocalStorageService.ts            |       0 |        0 |       0 |       0 | 7-506                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  VoiceJournalService.ts                        |       0 |        0 |       0 |       0 | 2-382                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  WebAuthnService.ts                            |   67.09 |    72.91 |   65.38 |   66.88 | 69-70,153-154,170-171,180-212,244,249-250,280-295,314-333,378-395                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  claude.ts                                     |       0 |        0 |       0 |       0 | 2-88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  database.ts                                   |       0 |        0 |       0 |       0 | 2-210                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  performanceMonitor.ts                         |       0 |        0 |       0 |       0 | 2-352                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  redis.ts                                      |   10.24 |     6.66 |     5.4 |   10.24 | 21,24-25,28-29,32-33,36-328,336-337                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  userService.ts                                |   32.73 |    33.87 |   47.36 |   32.33 | 13-18,26-27,56-106,114,122,131-223,243,249,252,273-307,314,329-386                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 src/services/ab-testing                        |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ABTestingService.ts                           |       0 |        0 |       0 |       0 | 2-346                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/ai                                |    3.17 |     0.95 |    2.35 |    3.38 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AIService.ts                                  |   26.66 |    19.78 |   20.68 |   27.51 | 73-76,87-154,167-384,414-418,425,429-446,457-544                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  AIServiceEnhanced.ts                          |       0 |        0 |       0 |       0 | 8-743                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AdaptiveLearning.ts                           |       0 |        0 |       0 |       0 | 2-783                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AnalyticsEngine.ts                            |       0 |        0 |       0 |       0 | 6-285                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CacheService.ts                               |       0 |        0 |       0 |       0 | 2-293                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CircuitBreaker.ts                             |   33.33 |    11.76 |   33.33 |   33.33 | 31-79,85                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  ContextManager.ts                             |    7.32 |        0 |    1.85 |    8.09 | 19-411                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  ConversationalAI.ts                           |       0 |        0 |       0 |       0 | 2-500                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  EnhancedAIService.ts                          |       0 |      100 |       0 |       0 | 6-12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  HybridDecisionEngine.ts                       |       0 |        0 |       0 |       0 | 6-276                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  InsightGenerator.ts                           |       0 |        0 |       0 |       0 | 2-1254                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  PersonalityEngine.ts                          |   18.18 |        0 |   21.42 |   18.18 | 338-477                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  PersonalizationEngine.ts                      |       0 |        0 |       0 |       0 | 6-195                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  PredictiveAnalytics.ts                        |       0 |        0 |       0 |       0 | 3-1262                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  PromptEngineering.ts                          |   10.08 |        0 |   10.71 |   10.43 | 71-274                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  RecommendationEngine.ts                       |       0 |        0 |       0 |       0 | 2-573                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  RetryMechanism.ts                             |   13.51 |        0 |       0 |    14.7 | 16-74                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UserProfilingService.ts                       |       0 |        0 |       0 |       0 | 2-597                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  VoiceAI.ts                                    |       0 |        0 |       0 |       0 | 2-984                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/analytics                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  APIUsageTracker.ts                            |       0 |        0 |       0 |       0 | 6-381                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AdvancedAnalyticsService.ts                   |       0 |        0 |       0 |       0 | 2-545                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AnalyticsPipelineService.ts                   |       0 |        0 |       0 |       0 | 7-849                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  AnalyticsService.ts                           |       0 |        0 |       0 |       0 | 2-483                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UserBehaviorAnalyticsService.ts               |       0 |        0 |       0 |       0 | 7-661                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/analytics/advertising             |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ABTestingFramework.ts                         |       0 |        0 |       0 |       0 | 12-762                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  AdPlatformIntegrationService.ts               |       0 |        0 |       0 |       0 | 15-420                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  DataNormalizer.ts                             |       0 |        0 |       0 |       0 | 13-501                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  PerformanceMonitor.ts                         |       0 |        0 |       0 |       0 | 13-699                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  PredictiveAnalyticsService.ts                 |       0 |        0 |       0 |       0 | 12-892                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  RealTimeDashboardService.ts                   |       0 |        0 |       0 |       0 | 13-875                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/services/analytics/advertising/platforms   |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  GoogleAdsClient.ts                            |       0 |        0 |       0 |       0 | 13-378                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  LinkedInAdsClient.ts                          |       0 |        0 |       0 |       0 | 13-441                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  MetaAdsClient.ts                              |       0 |        0 |       0 |       0 | 13-451                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/services/auth                              |    3.03 |     3.42 |    2.23 |    3.09 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AppleAuthService.ts                           |       0 |        0 |       0 |       0 | 2-681                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  FacebookAuthService.ts                        |       0 |        0 |       0 |       0 | 2-581                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  GoogleAuthService.ts                          |    13.2 |    14.93 |    8.82 |   13.92 | 3-11,14-16,20-25,28-32,56,78-81,91,94,101-107,121,126-635                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  MultiProviderAuthService.ts                   |       0 |        0 |       0 |       0 | 2-565                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SecureGoogleAuthService.ts                    |       0 |        0 |       0 |       0 | 2-613                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/cache                             |    5.55 |     5.28 |     3.8 |    5.61 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CacheService.ts                               |       0 |        0 |       0 |       0 | 2-546                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  PerformanceCacheService.ts                    |       0 |        0 |       0 |       0 | 2-458                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedCacheService.ts                        |   17.56 |    13.08 |    12.5 |   17.64 | 53-63,76-81,85,88,92-159,164-403                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
 src/services/cdn                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AssetOptimizationService.ts                   |       0 |        0 |       0 |       0 | 2-520                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/cms                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  PublishingService.ts                          |       0 |        0 |       0 |       0 | 2-390                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  UnifiedContentService.ts                      |       0 |        0 |       0 |       0 | 6-699                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/coach                             |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CoachService.ts                               |       0 |        0 |       0 |       0 | 2-807                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/coaching                          |    6.36 |     6.43 |    8.48 |    6.51 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CoachIntelligenceMLService.ts                 |       0 |        0 |       0 |       0 | 7-551                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  CoachIntelligenceMLServiceComplete.ts         |       0 |        0 |       0 |       0 | 7-1462                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  CoachIntelligenceService.ts                   |   11.21 |     9.77 |   15.44 |   11.61 | 17-51,70,74-75,111-146,164-182,201,217-218,283-293,320,336,366,390-646,653-691,699-714,719-763,768-857,862-864,870-910,916-957,962-1014,1019-1067,1073-1113,1118-1160,1165-1220,1225-1283,1288-1358,1377-1425,1438-1557,1562-1615,1623,1626-1629,1635,1643-1644,1649-1651,1710-1715,1720-1721,1727-1733,1738-1740,1747,1750,1754,1765-1820,1828-1910,1918-2022,2028-2134,2156-2282,2295,2301-2305,2309-2315,2321,2332-2343,2361-2362,2369-2440,2457-2484,2491-2516,2522-2536,2545-2554,2559-2585,2606-2631,2637-2659,2664-2686,2691-2692,2695,2703-2712,2722-2768,2788-2983,2992-3002,3011-3026,3032-3038,3044-3059,3065-3067,3072-3074,3082,3096,3124-3156,3165-3187,3196-3219,3227-3237,3246-3301,3315-3348,3359-3434,3453-4273,4289-4583 
  CoachIntelligenceServiceEnhanced.ts           |       0 |        0 |       0 |       0 | 8-1364                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  MissedSessionsCalculator.ts                   |       0 |        0 |       0 |       0 | 7-561                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/community                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ForumService.ts                               |       0 |        0 |       0 |       0 | 2-493                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/compliance                        |    4.97 |     1.91 |    2.32 |    5.05 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  GDPRService.ts                                |   13.13 |     4.34 |    8.33 |   13.13 | 48-681                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  HIPAAService.ts                               |       0 |        0 |       0 |       0 | 6-577                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SOC2Service.ts                                |       0 |        0 |       0 |       0 | 6-644                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/database                          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  QueryOptimizer.ts                             |       0 |        0 |       0 |       0 | 2-319                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/email                             |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  UnifiedEmailService.ts                        |       0 |        0 |       0 |       0 | 6-532                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/enterprise                        |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  OrganizationService.ts                        |       0 |        0 |       0 |       0 | 2-390                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SSOService.ts                                 |       0 |        0 |       0 |       0 | 2-487                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SessionStore.ts                               |       0 |        0 |       0 |       0 | 2-59                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  TeamService.ts                                |       0 |        0 |       0 |       0 | 2-615                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/financial                         |    12.4 |     5.43 |    9.23 |   12.77 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CostAnalyticsService.ts                       |       0 |        0 |       0 |       0 | 2-403                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  FinancialService.ts                           |    9.72 |        0 |       0 |   10.14 | 12-354                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  ReportDeliveryService.ts                      |       0 |        0 |       0 |       0 | 7-677                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  ReportingService.ts                           |    6.42 |        0 |       0 |    6.56 | 15-476                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  StripeWebhookService.ts                       |   49.62 |     31.5 |   66.66 |   49.62 | 9-109,134,140,143,152,155,160,193-205,226,240-252,277-306,329,332-358,380,386-397,420-431,455-470,492,498-511,533,540-565,589-617,640-661                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 src/services/gamification                      |   12.18 |     1.09 |   13.63 |   12.24 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  GamificationService.ts                        |   12.18 |     1.09 |   13.63 |   12.24 | 83-720                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/services/google                            |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DocsService.ts                                |       0 |      100 |       0 |       0 | 2-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  SheetsService.ts                              |       0 |      100 |       0 |       0 | 2-29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/services/marketing                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  MarketingAutomation.ts                        |       0 |        0 |       0 |       0 | 2-399                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/ml                                |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  MLDataPipeline.ts                             |       0 |        0 |       0 |       0 | 7-723                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  MLModelMonitoringService.ts                   |       0 |        0 |       0 |       0 | 7-562                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  PredictiveCoachingEngine.ts                   |       0 |        0 |       0 |       0 | 7-642                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  RealTimeInsightsGenerator.ts                  |       0 |        0 |       0 |       0 | 7-745                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/monitoring                        |    2.27 |     0.36 |    1.72 |    2.33 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DataDogService.ts                             |       0 |        0 |       0 |       0 | 6-436                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  PerformanceProfiler.ts                        |       0 |        0 |       0 |       0 | 2-586                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SentryService.ts                              |    9.23 |     1.17 |    6.45 |     9.3 | 26-334                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 src/services/payment                           |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  StripeService.ts                              |       0 |        0 |       0 |       0 | 2-391                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/performance                       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  PerformanceOptimizationService.ts             |       0 |        0 |       0 |       0 | 2-603                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/personality                       |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  PersonalityService.ts                         |       0 |        0 |       0 |       0 | 2-375                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/realtime                          |       0 |      100 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  RealtimeService.ts                            |       0 |      100 |       0 |       0 | 2-12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/services/referral                          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  ReferralService.ts                            |       0 |        0 |       0 |       0 | 2-488                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/security                          |    7.33 |        2 |    4.82 |    7.38 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DataExportService.ts                          |       0 |        0 |       0 |       0 | 2-522                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  JwtSecurityService-fixed.ts                   |       0 |        0 |       0 |       0 | 2-549                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  JwtSecurityService.ts                         |       0 |        0 |       0 |       0 | 2-498                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  SecurityMonitoringService.ts                  |   40.71 |    12.67 |   20.58 |   41.71 | 76-162,210-431                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
  SessionSecurityService.ts                     |       0 |        0 |       0 |       0 | 2-438                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/sms                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  SMSService.ts                                 |       0 |        0 |       0 |       0 | 6-393                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/sse                               |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DashboardSSEService.ts                        |       0 |        0 |       0 |       0 | 2-613                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/storage                           |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  AvatarStorageService.ts                       |       0 |        0 |       0 |       0 | 2-25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  StorageTracker.ts                             |       0 |        0 |       0 |       0 | 6-505                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/supabase                          |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  SupabaseClient.ts                             |       0 |        0 |       0 |       0 | 2-22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/services/upload                            |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  UploadService.ts                              |       0 |        0 |       0 |       0 | 2-153                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/services/websocket                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  DashboardWebSocketService.ts                  |       0 |        0 |       0 |       0 | 2-678                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  OptimizedWebSocketService.ts                  |       0 |        0 |       0 |       0 | 2-605                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 src/types                                      |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  api-responses.ts                              |       0 |        0 |       0 |       0 | 5-75                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  auth.ts                                       |       0 |      100 |     100 |       0 | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  common.ts                                     |       0 |        0 |       0 |       0 | 5-17                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  database.ts                                   |       0 |      100 |     100 |       0 | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  index.ts                                      |       0 |      100 |     100 |       0 | 6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 src/utils                                      |     9.7 |     5.73 |    6.88 |    9.68 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  CircuitBreaker.ts                             |       0 |        0 |       0 |       0 | 6-113                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  MetricsCollector.ts                           |       0 |        0 |       0 |       0 | 6-188                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  RateLimiter.ts                                |       0 |        0 |       0 |       0 | 6-87                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  RetryPolicy.ts                                |       0 |        0 |       0 |       0 | 6-177                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  apiError.ts                                   |   47.36 |     9.09 |   16.66 |   47.36 | 17-44                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  asyncHandler.ts                               |       0 |      100 |       0 |       0 | 2-10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  catchAsync.ts                                 |       0 |      100 |       0 |       0 | 2-9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  cryptoSecurity.ts                             |   13.97 |     6.97 |   18.18 |   14.07 | 19,27,36-46,57-258                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  dbSecurity.ts                                 |       0 |        0 |       0 |       0 | 2-251                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  errorHandler.ts                               |       0 |        0 |       0 |       0 | 2-137                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  errors.ts                                     |       0 |        0 |       0 |       0 | 2-51                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  express-helpers.ts                            |       0 |        0 |       0 |       0 | 5-97                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  generators.ts                                 |       0 |        0 |       0 |       0 | 2-67                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  jwt.ts                                        |       0 |        0 |       0 |       0 | 2-79                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  logger.ts                                     |   60.71 |    49.12 |   53.33 |   59.75 | 21,38-41,63,75-99,105-109,125-129,138,152-153,158,171-177                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  model-helpers.ts                              |       0 |      100 |       0 |       0 | 6-71                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  sanitization.ts                               |       0 |        0 |       0 |       0 | 6-258                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  secrets.ts                                    |   20.63 |        0 |       0 |   20.63 | 21-156                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  shutdown.ts                                   |   37.31 |        0 |      25 |   38.09 | 37-42,48,51,54-57,66-67,70-73,82-115,130                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  slug.ts                                       |       0 |        0 |       0 |       0 | 2-23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  sqlSecurity.ts                                |       0 |        0 |       0 |       0 | 2-275                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  typeGuards.ts                                 |       0 |        0 |       0 |       0 | 5-73                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 src/validation/schemas                         |       0 |        0 |       0 |       0 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  auth.schema.ts                                |       0 |        0 |       0 |       0 | 2-205                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  coach.schema.ts                               |       0 |        0 |       0 |       0 | 2-252                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  common.schema.ts                              |       0 |      100 |       0 |       0 | 2-183                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
------------------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

=============================== Coverage summary ===============================
Statements   : 4.93% ( 1909/38667 )
Branches     : 3.48% ( 643/18433 )
Functions    : 4.15% ( 268/6448 )
Lines        : 5.01% ( 1878/37421 )
================================================================================
Summary of all failing tests
FAIL src/__tests__/e2e-critical/coach-revenue-journey.test.ts
  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should successfully register as a coach

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should create complete coach profile

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 1: Coach Registration & Profile Creation â€º should appear in coach search results

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 2: Set Availability & Pricing â€º should set weekly availability schedule

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 2: Set Availability & Pricing â€º should verify available time slots are bookable

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º should register a client user

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º should successfully book session with coach

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 3: Client Books Session â€º coach should see booked session in their schedule

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 4: Coach Delivers Session â€º should mark session as complete with notes

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 4: Coach Delivers Session â€º client should be able to rate the session

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 5: Coach Receives Payment â€º should release payment to coach after session completion

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 5: Coach Receives Payment â€º should see payment in earnings history

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 6: Coach Views Analytics â€º should view comprehensive coach analytics dashboard

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Step 6: Coach Views Analytics â€º should view earnings breakdown by period

    AggregateError:



  â— E2E Critical Journey: Coach Revenue Flow â€º Journey Completion â€º should have completed full coach revenue journey

    AggregateError:



FAIL src/__tests__/integration/user-registration-flow.test.ts
  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should register new user with valid credentials

    expected 201 "Created", got 404 "Not Found"

      52 |
      53 |     jest.clearAllMocks();
    > 54 |   });
         |      ^
      55 |
      56 |   describe('Step 1: User Registration', () => {
      57 |     test('should register new user with valid credentials', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:54:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should send verification email after registration

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      66 |
      67 |       expect(response.body).toMatchObject({
    > 68 |         success: true,
         |                       ^
      69 |         message: expect.stringContaining('registered'),
      70 |         userId: expect.any(String),
      71 |       });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:68:48)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should prevent duplicate email registration

    expected 201 "Created", got 404 "Not Found"

      79 |     });
      80 |
    > 81 |     test('should send verification email after registration', async () => {
         |                  ^
      82 |       (emailService.send as jest.Mock).mockResolvedValue({ success: true });
      83 |
      84 |       await request(app)

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:81:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should validate email format

    expected 400 "Bad Request", got 404 "Not Found"

       98 |     test('should prevent duplicate email registration', async () => {
       99 |       // First registration
    > 100 |       await request(app)
          |                  ^
      101 |         .post('/api/auth/register')
      102 |         .send(testUser)
      103 |         .expect(201);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:100:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should enforce strong password policy

    expected 400 "Bad Request", got 404 "Not Found"

      117 |     test('should validate email format', async () => {
      118 |       const response = await request(app)
    > 119 |         .post('/api/auth/register')
          |                      ^
      120 |         .send({
      121 |           email: 'invalid-email',
      122 |           password: testUser.password,

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:119:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 1: User Registration â€º should initialize user gamification on registration

    expected 201 "Created", got 404 "Not Found"

      125 |         .expect(400);
      126 |
    > 127 |       expect(response.body.error).toMatch(/valid email/i);
          |                  ^
      128 |     });
      129 |
      130 |     test('should enforce strong password policy', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:127:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should verify email with valid token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should reject invalid verification token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should reject expired verification token

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 2: Email Verification â€º should allow resending verification email

    TypeError: Cannot read properties of undefined (reading 'mock')

      144 |             password: weakPassword,
      145 |             name: testUser.name,
    > 146 |           })
          |             ^
      147 |           .expect(400);
      148 |
      149 |         expect(response.body.error).toMatch(/password/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:146:66)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should login with verified credentials

    expected 200 "OK", got 404 "Not Found"

      206 |     test('should reject invalid verification token', async () => {
      207 |       const response = await request(app)
    > 208 |         .get('/api/auth/verify-email?token=invalid-token')
          |                  ^
      209 |         .expect(400);
      210 |
      211 |       expect(response.body.error).toMatch(/invalid.*token/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:208:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should reject login before email verification

    expected 403 "Forbidden", got 404 "Not Found"

      230 |
      231 |       const response = await request(app)
    > 232 |         .post('/api/auth/resend-verification')
          |                  ^
      233 |         .send({ email: testUser.email })
      234 |         .expect(200);
      235 |

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:232:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should reject invalid password

    expected 401 "Unauthorized", got 404 "Not Found"

      240 |
      241 |       expect(emailService.send).toHaveBeenCalled();
    > 242 |     });
          |        ^
      243 |   });
      244 |
      245 |   describe('Step 3: User Login', () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:242:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 3: User Login â€º should track login attempts and lock account after 5 failures

    expected 401 "Unauthorized", got 404 "Not Found"

      252 |     });
      253 |
    > 254 |     test('should login with verified credentials', async () => {
          |                      ^
      255 |       const response = await request(app)
      256 |         .post('/api/auth/login')
      257 |         .send({

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:254:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should complete profile with additional information

    expected 200 "OK", got 404 "Not Found"

      299 |           email: testUser.email,
      300 |           password: 'WrongPassword123!',
    > 301 |         })
          |           ^
      302 |         .expect(401);
      303 |
      304 |       expect(response.body.error).toMatch(/invalid.*credentials/i);

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:301:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should upload profile picture

    expected 200 "OK", got 404 "Not Found"

      316 |           })
      317 |           .expect(401);
    > 318 |       }
          |        ^
      319 |
      320 |       // Next attempt should be locked
      321 |       const response = await request(app)

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:318:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 4: Profile Setup â€º should require authentication for profile updates

    expected 401 "Unauthorized", got 404 "Not Found"

      326 |         })
      327 |         .expect(423);
    > 328 |
          | ^
      329 |       expect(response.body.error).toMatch(/locked/i);
      330 |     });
      331 |   });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:328:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should complete onboarding with goals and interests

    expected 200 "OK", got 404 "Not Found"

      355 |           language: 'en',
      356 |           notifications: {
    > 357 |             email: true,
          |                  ^
      358 |             push: true,
      359 |             sms: false,
      360 |           },

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:357:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should award onboarding completion points

    expected 200 "OK", got 404 "Not Found"

      372 |         .expect(200);
      373 |
    > 374 |       expect(response.body).toMatchObject({
          |                  ^
      375 |         success: true,
      376 |         profile: expect.objectContaining({
      377 |           bio: profileData.bio,

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:374:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º Step 5: Onboarding Completion â€º should send welcome email after onboarding

    TypeError: Cannot read properties of undefined (reading 'mockClear')

      382 |       // Verify in database
      383 |       const user = await User.findOne({ where: { email: testUser.email } });
    > 384 |       expect(user?.profile).toMatchObject(profileData);
          |                                                ^
      385 |     });
      386 |
      387 |     test('should upload profile picture', async () => {

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:384:48)

  â— Integration: User Registration Flow â€º End-to-End: Complete Registration Flow â€º should complete entire registration flow successfully

    expected 201 "Created", got 404 "Not Found"

      400 |     test('should require authentication for profile updates', async () => {
      401 |       const response = await request(app)
    > 402 |         .put('/api/user/profile')
          |                  ^
      403 |         .send({ bio: 'Test' })
      404 |         .expect(401);
      405 |

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:402:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Integration: User Registration Flow â€º End-to-End: Complete Registration Flow â€º should track registration flow metrics

    TypeError: Cannot read properties of undefined (reading 'SELECT')

      464 |       const gamificationData = await sequelize.query(
      465 |         'SELECT * FROM user_levels WHERE user_id = ?',
    > 466 |         {
          |          ^
      467 |           replacements: [user?.id],
      468 |           type: sequelize.QueryTypes.SELECT,
      469 |         }

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:466:53)

  â— Integration: User Registration Flow â€º Error Recovery and Edge Cases â€º should handle concurrent registration attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      477 |
      478 |       await request(app)
    > 479 |         .post('/api/onboarding/complete')
          |                                          ^
      480 |         .set('Authorization', `Bearer ${authToken}`)
      481 |         .send({
      482 |           interests: ['fitness'],

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:479:49)

  â— Integration: User Registration Flow â€º Error Recovery and Edge Cases â€º should rollback on registration failure

    Property `query` does not exist in the provided object

      496 |   describe('End-to-End: Complete Registration Flow', () => {
      497 |     test('should complete entire registration flow successfully', async () => {
    > 498 |       // Step 1: Register
          |                          ^
      499 |       const registerResponse = await request(app)
      500 |         .post('/api/auth/register')
      501 |         .send(testUser)

      at ModuleMocker.spyOn (../../node_modules/jest-environment-node/node_modules/jest-mock/build/index.js:731:13)
      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:498:28)


  â— Test suite failed to run

    TypeError: models_1.sequelize.close is not a function

      31 |   let authToken: string;
      32 |
    > 33 |   beforeAll(async () => {
         |                          ^
      34 |     // Connect to test database
      35 |     await sequelize.sync({ force: true });
      36 |   });

      at Object.<anonymous> (src/__tests__/integration/user-registration-flow.test.ts:33:34)

FAIL src/__tests__/e2e-critical/subscription-monetization-journey.test.ts
  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 1: User Registration (Free Tier) â€º should successfully register with free tier access

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 1: User Registration (Free Tier) â€º should be blocked from accessing premium features

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should fetch available subscription plans

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should successfully create premium subscription

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 2: Subscription Purchase (Premium Tier) â€º should have updated user profile with premium tier

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should now have access to premium analytics

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should have access to premium content library

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 3: Premium Feature Access â€º should have increased resource limits

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 4: Successful Payment Processing â€º should process first subscription payment successfully

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 4: Successful Payment Processing â€º should generate invoice for payment

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 5: Subscription Tier Upgrade â€º should successfully upgrade to enterprise tier

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Step 5: Subscription Tier Upgrade â€º should have enterprise features enabled

    AggregateError:



  â— E2E Critical Journey: Subscription & Monetization Flow â€º Journey Completion â€º should have completed full monetization journey

    AggregateError:



FAIL src/__tests__/auth/auth-routes.test.ts
  â— Authentication Routes â€º POST /auth/register â€º should register a new user successfully

    expected 201 "Created", got 500 "Internal Server Error"

      37 |       bio: 'Test user bio'
      38 |     };
    > 39 |
         | ^
      40 |     test('should register a new user successfully', async () => {
      41 |       const response = await request(app)
      42 |         .post('/auth/register')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:39:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for invalid email format

    expected 400 "Bad Request", got 500 "Internal Server Error"

      66 |       expect(user?.email).toBe(validRegistrationData.email);
      67 |     });
    > 68 |
         | ^
      69 |     test('should return 400 for invalid email format', async () => {
      70 |       const response = await request(app)
      71 |         .post('/auth/register')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:68:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for weak password

    expected 400 "Bad Request", got 500 "Internal Server Error"

      77 |
      78 |       expect(response.body.success).toBe(false);
    > 79 |       expect(response.body.message).toContain('Invalid email format');
         |                  ^
      80 |     });
      81 |
      82 |     test('should return 400 for weak password', async () => {

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:79:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/register â€º should return 400 for duplicate email

    expected 201 "Created", got 500 "Internal Server Error"

      86 |           ...validRegistrationData,
      87 |           password: '123'
    > 88 |         })
         |           ^
      89 |         .expect(400);
      90 |
      91 |       expect(response.body.success).toBe(false);

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:88:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should login successfully with valid credentials

    expected 200 "OK", got 429 "Too Many Requests"

      124 |       // At least one should be rate limited
      125 |       const rateLimitedResponse = responses.find(r => r.status === 429);
    > 126 |       expect(rateLimitedResponse).toBeTruthy();
          |                  ^
      127 |     });
      128 |   });
      129 |

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:126:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for invalid email

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      151 |         message: 'Login successful',
      152 |         data: {
    > 153 |           user: {
          |                  ^
      154 |             email: 'testuser@example.com',
      155 |             name: 'Test User'
      156 |           },

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:153:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for invalid password

    expected 401 "Unauthorized", got 429 "Too Many Requests"

      162 |       });
      163 |
    > 164 |       // Verify refresh token was stored in Redis
          |                  ^
      165 |       const user = await UserService.findByEmail('testuser@example.com');
      166 |       const storedToken = await mockRedis.get(`refresh_token:${user?.id}`);
      167 |       expect(storedToken).toBe(response.body.data.tokens.refreshToken);

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:164:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— Authentication Routes â€º POST /auth/login â€º should return 401 for inactive user

    TypeError: userService_1.UserService.updateActiveStatus is not a function

      170 |     test('should return 401 for invalid email', async () => {
      171 |       const response = await request(app)
    > 172 |         .post('/auth/login')
          |                             ^
      173 |         .send({
      174 |           email: 'nonexistent@example.com',
      175 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:172:49)

  â— Authentication Routes â€º POST /auth/refresh â€º should refresh tokens successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/refresh â€º should return 401 for invalid refresh token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/refresh â€º should return 401 for revoked refresh token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      200 |         await UserService.updateActiveStatus(user.id, false);
      201 |       }
    > 202 |
          | ^
      203 |       const response = await request(app)
      204 |         .post('/auth/login')
      205 |         .send({

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:202:52)

  â— Authentication Routes â€º POST /auth/logout â€º should logout successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      257 |       expect(response.body.data.tokens.refreshToken).not.toBe(refreshToken);
      258 |     });
    > 259 |
          | ^
      260 |     test('should return 401 for invalid refresh token', async () => {
      261 |       const response = await request(app)
      262 |         .post('/auth/refresh')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:259:51)

  â— Authentication Routes â€º POST /auth/logout â€º should return 401 without access token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      257 |       expect(response.body.data.tokens.refreshToken).not.toBe(refreshToken);
      258 |     });
    > 259 |
          | ^
      260 |     test('should return 401 for invalid refresh token', async () => {
      261 |       const response = await request(app)
      262 |         .post('/auth/refresh')

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:259:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should change password successfully

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should return 400 for invalid current password

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º POST /auth/change-password â€º should return 400 for weak new password

    TypeError: Cannot read properties of undefined (reading 'tokens')

      297 |
      298 |       const loginResponse = await request(app)
    > 299 |         .post('/auth/login')
          |                             ^
      300 |         .send({
      301 |           email: 'logoutuser@example.com',
      302 |           password: 'SecurePass123!'

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:299:51)

  â— Authentication Routes â€º GET /auth/verify â€º should verify valid token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

  â— Authentication Routes â€º GET /auth/verify â€º should return 401 for invalid token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

  â— Authentication Routes â€º GET /auth/verify â€º should return 401 without token

    TypeError: Cannot read properties of undefined (reading 'tokens')

      363 |           newPassword: 'NewPass123!'
      364 |         })
    > 365 |         .expect(200);
          |                      ^
      366 |
      367 |       expect(response.body).toMatchObject({
      368 |         success: true,

      at Object.<anonymous> (src/__tests__/auth/auth-routes.test.ts:365:51)

FAIL src/__tests__/controllers/FinancialDashboardController.test.ts
  â— FinancialDashboardController â€º getDashboardMetrics â€º should deny access for non-admin users

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      83 |       const mockMetrics = {
      84 |         revenue: 50000,
    > 85 |         expenses: 20000,
         |                         ^
      86 |         profit: 30000,
      87 |         mrr: 5000,
      88 |         arr: 60000,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:85:47)

  â— FinancialDashboardController â€º getDashboardMetrics â€º should handle service errors gracefully

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.getDashboardMetrics (src/controllers/financial/FinancialDashboardController.ts:20394:36)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:92:13)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should calculate revenue metrics for specified date range

    TypeError: Cannot read properties of undefined (reading 'sum')

      103 |     });
      104 |
    > 105 |     test('should deny access for non-admin users', async () => {
          |                                  ^
      106 |       mockRequest.user = { ...mockUser, role: 'user' };
      107 |
      108 |       await controller.getDashboardMetrics(

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:105:34)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should use current month if no date range specified

    TypeError: Cannot read properties of undefined (reading 'sum')

      120 |       (financialService.getDashboardMetrics as jest.Mock).mockRejectedValue(
      121 |         new Error('Database connection failed')
    > 122 |       );
          |         ^
      123 |
      124 |       await controller.getDashboardMetrics(
      125 |         mockRequest as Request,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:122:34)

  â— FinancialDashboardController â€º getRevenueMetrics â€º should handle null revenue values

    TypeError: Cannot read properties of undefined (reading 'sum')

      132 |       });
      133 |     });
    > 134 |   });
          |      ^
      135 |
      136 |   describe('getRevenueMetrics', () => {
      137 |     test('should calculate revenue metrics for specified date range', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:134:34)

  â— FinancialDashboardController â€º getSubscriptionMetrics â€º should return subscription analytics

    TypeError: Cannot read properties of undefined (reading 'count')

      147 |       (financialService.calculateMRR as jest.Mock).mockResolvedValue(8000);
      148 |       (financialService.calculateARR as jest.Mock).mockResolvedValue(96000);
    > 149 |
          | ^
      150 |       await controller.getRevenueMetrics(
      151 |         mockRequest as Request,
      152 |         mockResponse as Response

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:149:35)

  â— FinancialDashboardController â€º getSubscriptionMetrics â€º should handle zero subscriptions

    TypeError: Cannot read properties of undefined (reading 'count')

      162 |       });
      163 |     });
    > 164 |
          | ^
      165 |     test('should use current month if no date range specified', async () => {
      166 |       mockRequest.query = {};
      167 |

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:164:35)

  â— FinancialDashboardController â€º getCostMetrics â€º should retrieve and categorize costs

    TypeError: Cannot read properties of undefined (reading 'findAll')

      181 |         }),
      182 |       });
    > 183 |     });
          |        ^
      184 |
      185 |     test('should handle null revenue values', async () => {
      186 |       (Transaction.sum as jest.Mock).mockResolvedValue(null);

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:183:35)

  â— FinancialDashboardController â€º getCostMetrics â€º should handle missing month parameter

    TypeError: Cannot read properties of undefined (reading 'findAll')

      193 |       );
      194 |
    > 195 |       expect(mockJson).toHaveBeenCalledWith({
          |                                   ^
      196 |         gross: 0,
      197 |         refunds: 0,
      198 |         net: 0,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:195:35)

  â— FinancialDashboardController â€º getProfitLossStatement â€º should generate P&L statement for specified period

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      207 |       (Subscription.count as jest.Mock)
      208 |         .mockResolvedValueOnce(150) // active
    > 209 |         .mockResolvedValueOnce(20) // new
          |                                          ^
      210 |         .mockResolvedValueOnce(5); // churned
      211 |
      212 |       (financialService.calculateChurnRate as jest.Mock).mockResolvedValue(3.33);

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:209:77)

  â— FinancialDashboardController â€º createReport â€º should create a new financial report

    TypeError: Cannot read properties of undefined (reading 'create')

      239 |         new: 0,
      240 |         churned: 0,
    > 241 |         churnRate: 0,
          |                      ^
      242 |       });
      243 |     });
      244 |   });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:241:38)

  â— FinancialDashboardController â€º createReport â€º should validate required fields

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.createReport (src/controllers/financial/FinancialDashboardController.ts:22040:37)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:256:30)

  â— FinancialDashboardController â€º createReport â€º should handle report generation errors

    TypeError: Cannot read properties of undefined (reading 'create')

      267 |       );
      268 |       expect(mockJson).toHaveBeenCalledWith(expect.objectContaining({
    > 269 |         total: 23000,
          |                      ^
      270 |         byCategory: expect.any(Object),
      271 |       }));
      272 |     });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:269:38)

  â— FinancialDashboardController â€º downloadReport â€º should export report in Excel format

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      287 |       }));
      288 |     });
    > 289 |   });
          |      ^
      290 |
      291 |   describe('getProfitLossStatement', () => {
      292 |     test('should generate P&L statement for specified period', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:289:38)

  â— FinancialDashboardController â€º downloadReport â€º should export report in PDF format

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      300 |         costs: 150000,
      301 |         grossProfit: 150000,
    > 302 |         operatingExpenses: 50000,
          |                                  ^
      303 |         netProfit: 100000,
      304 |         margin: 33.33,
      305 |       });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:302:38)

  â— FinancialDashboardController â€º downloadReport â€º should handle report not found

    TypeError: Cannot read properties of undefined (reading 'findByPk')

      306 |
      307 |       await controller.getProfitLossStatement(
    > 308 |         mockRequest as Request,
          |                                ^
      309 |         mockResponse as Response
      310 |       );
      311 |

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:308:38)

  â— FinancialDashboardController â€º getRevenueForecast â€º should generate revenue forecast

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      317 |         revenue: 300000,
      318 |         netProfit: 100000,
    > 319 |         margin: 33.33,
          |                       ^
      320 |       }));
      321 |     });
      322 |   });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:319:73)

  â— FinancialDashboardController â€º getRevenueForecast â€º should use default forecast period

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      340 |
      341 |       (FinancialReport.create as jest.Mock).mockResolvedValue(mockReport);
    > 342 |
          | ^
      343 |       await controller.createReport(
      344 |         mockRequest as Request,
      345 |         mockResponse as Response

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:342:73)

  â— FinancialDashboardController â€º getCohortAnalysis â€º should perform cohort analysis

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      373 |       });
      374 |     });
    > 375 |
          | ^
      376 |     test('should handle report generation errors', async () => {
      377 |       mockRequest.body = {
      378 |         type: 'monthly',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:375:72)

  â— FinancialDashboardController â€º getUnitEconomics â€º should calculate unit economics metrics

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      390 |         mockResponse as Response
      391 |       );
    > 392 |
          | ^
      393 |       expect(mockStatus).toHaveBeenCalledWith(500);
      394 |       expect(mockJson).toHaveBeenCalledWith({
      395 |         error: 'Report generation failed',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:392:72)

  â— FinancialDashboardController â€º getUnitEconomics â€º should handle calculation errors

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      396 |       });
      397 |     });
    > 398 |   });
          |      ^
      399 |
      400 |   describe('downloadReport', () => {
      401 |     test('should export report in Excel format', async () => {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:398:72)

  â— FinancialDashboardController â€º getBillingEvents â€º should retrieve billing events with pagination

    TypeError: Cannot read properties of undefined (reading 'findAndCountAll')

      427 |
      428 |     test('should export report in PDF format', async () => {
    > 429 |       mockRequest.params = { id: 'report-123' };
          |                                   ^
      430 |       mockRequest.query = { format: 'pdf' };
      431 |
      432 |       const mockReport = {

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:429:35)

  â— FinancialDashboardController â€º getBillingEvents â€º should filter by date range

    TypeError: Cannot read properties of undefined (reading 'findAndCountAll')

      452 |       mockRequest.params = { id: 'non-existent' };
      453 |
    > 454 |       (FinancialReport.findByPk as jest.Mock).mockResolvedValue(null);
          |                                   ^
      455 |
      456 |       await controller.downloadReport(
      457 |         mockRequest as Request,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:454:35)

  â— FinancialDashboardController â€º triggerAutomation â€º should trigger financial automation task

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      469 |     test('should generate revenue forecast', async () => {
      470 |       mockRequest.query = { months: '6' };
    > 471 |
          | ^
      472 |       (financialService.generateRevenueForecast as jest.Mock).mockResolvedValue({
      473 |         predictions: [
      474 |           { month: '2024-01', revenue: 10000 },

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:471:60)

  â— FinancialDashboardController â€º triggerAutomation â€º should validate automation task

    ReferenceError: getErrorStatusCode is not defined



      at FinancialDashboardController.triggerAutomation (src/controllers/financial/FinancialDashboardController.ts:24371:38)
      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:488:30)

  â— FinancialDashboardController â€º sendTestEmail â€º should send test email to admin

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      499 |     test('should use default forecast period', async () => {
      500 |       mockRequest.query = {};
    > 501 |
          | ^
      502 |       (financialService.generateRevenueForecast as jest.Mock).mockResolvedValue({
      503 |         predictions: [],
      504 |         confidence: 0,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:501:48)

  â— FinancialDashboardController â€º sendTestEmail â€º should handle email sending failure

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      515 |   });
      516 |
    > 517 |   describe('getCohortAnalysis', () => {
          |                                        ^
      518 |     test('should perform cohort analysis', async () => {
      519 |       mockRequest.query = {
      520 |         startMonth: '2024-01',

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:517:48)

  â— FinancialDashboardController â€º Role-based Access Control â€º should allow finance role access to financial data

    TypeError: Cannot read properties of undefined (reading 'sum')

      533 |             month: '2024-02',
      534 |             users: 120,
    > 535 |             retention: [120, 108, 102],
          |                                  ^
      536 |             revenue: [12000, 10800, 10200],
      537 |           },
      538 |         ],

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:535:34)

  â— FinancialDashboardController â€º Role-based Access Control â€º should deny regular user access to financial data

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      543 |       (financialService.generateCohortAnalysis as jest.Mock).mockResolvedValue(mockCohortData);
      544 |
    > 545 |       await controller.getCohortAnalysis(
          |                                          ^
      546 |         mockRequest as Request,
      547 |         mockResponse as Response
      548 |       );

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:545:47)

  â— FinancialDashboardController â€º Error Handling â€º should handle ApiError with custom status code

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      550 |       expect(financialService.generateCohortAnalysis).toHaveBeenCalledWith(
      551 |         '2024-01',
    > 552 |         '2024-03'
          |                  ^
      553 |       );
      554 |       expect(mockJson).toHaveBeenCalledWith(mockCohortData);
      555 |     });

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:552:73)

  â— FinancialDashboardController â€º Error Handling â€º should handle database connection errors

    TypeError: Cannot read properties of undefined (reading 'sum')

      558 |   describe('getUnitEconomics', () => {
      559 |     test('should calculate unit economics metrics', async () => {
    > 560 |       const mockUnitEconomics = {
          |                                  ^
      561 |         cac: 150, // Customer Acquisition Cost
      562 |         ltv: 1200, // Lifetime Value
      563 |         ltvCacRatio: 8,

      at Object.<anonymous> (src/__tests__/controllers/FinancialDashboardController.test.ts:560:34)

FAIL src/__tests__/integration/payment-flow.test.ts
  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:21:41)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should complete entire payment and subscription flow successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should handle payment failure gracefully

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º End-to-End: Complete Payment Flow â€º should handle payment failure gracefully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process subscription.updated webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process subscription.updated webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.succeeded webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.succeeded webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.payment_failed webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process payment_intent.payment_failed webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process customer.subscription.deleted webhook

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should process customer.subscription.deleted webhook

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Webhook Processing â€º should handle duplicate webhook events (idempotency)

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Webhook Processing â€º should handle duplicate webhook events (idempotency)

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should upgrade subscription to premium tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should upgrade subscription to premium tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should downgrade subscription to free tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should downgrade subscription to free tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription immediately

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription immediately

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription at period end

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should cancel subscription at period end

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Subscription Management â€º should reactivate canceled subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Subscription Management â€º should reactivate canceled subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should add new payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should add new payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should set payment method as default

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should set payment method as default

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should remove payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should remove payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Payment Method Management â€º should not allow removing default payment method with active subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Payment Method Management â€º should not allow removing default payment method with active subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve billing history

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve billing history

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve specific invoice

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should retrieve specific invoice

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should download invoice PDF

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Invoice and Billing History â€º should download invoice PDF

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Refund Processing â€º should process full refund

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Refund Processing â€º should process full refund

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Refund Processing â€º should process partial refund

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Refund Processing â€º should process partial refund

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should create subscription with trial period

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should create subscription with trial period

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should convert trial to paid subscription after trial ends

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Trial Period Handling â€º should convert trial to paid subscription after trial ends

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should deny premium features for free tier

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should deny premium features for free tier

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should allow premium features for active subscription

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should allow premium features for active subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Access Control Validation â€º should revoke access after subscription cancellation

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Access Control Validation â€º should revoke access after subscription cancellation

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should handle past_due subscription status

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should handle past_due subscription status

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should retry failed payment with new payment method

    TypeError: Cannot read properties of undefined (reading 'email')

      60 |         password: 'hashedPassword123',
      61 |       });
    > 62 |
         | ^
      63 |     authToken = loginResponse.body.token;
      64 |     stripeCustomerId = 'cus_test_123';
      65 |

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:62:29)

  â— Integration: Payment Flow â€º Failed Payment Recovery â€º should retry failed payment with new payment method

    TypeError: Cannot read properties of undefined (reading 'destroy')

      65 |
      66 |     // Mock Stripe customer creation
    > 67 |     (mockStripe.customers.create as jest.Mock) = jest.fn().mockResolvedValue({
         |                                    ^
      68 |       id: stripeCustomerId,
      69 |       email: testUser.email,
      70 |     });

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:67:36)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      35 |     // Setup Stripe mock
      36 |     mockStripe = new Stripe('sk_test_mock') as jest.Mocked<Stripe>;
    > 37 |   });
         |      ^
      38 |
      39 |   afterAll(async () => {
      40 |     await sequelize.close();

      at Object.<anonymous> (src/__tests__/integration/payment-flow.test.ts:37:34)

FAIL src/__tests__/e2e-critical/user-onboarding-journey.test.ts
  â— E2E Critical Journey: User Onboarding Flow â€º Step 1: User Registration â€º should successfully register a new user account

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 1: User Registration â€º should be able to retrieve current user profile

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should successfully create first goal and unlock achievement

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should be able to retrieve the created goal

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 2: Create First Goal â€º should see goal in goals list

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should find available coaches

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should successfully book first coaching session

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Step 3: Book First Coaching Session â€º should see booked session in upcoming sessions

    AggregateError:



  â— E2E Critical Journey: User Onboarding Flow â€º Journey Completion â€º should have completed full onboarding journey

    AggregateError:



FAIL src/tests/integration/api.test.ts
  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/login â€º should implement rate limiting

    TypeError: Cannot read properties of undefined (reading 'id')

      160 |           .expect(400);
      161 |
    > 162 |         expect(response.body.success).toBe(false);
          |                                                   ^
      163 |         expect(response.body.details.errors).toBeDefined();
      164 |         expect(response.body.error).toBe('Validation Error');
      165 |       });

      at Object.<anonymous> (src/tests/integration/api.test.ts:162:53)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/logout â€º should logout user successfully

    expected 200 "OK", got 401 "Unauthorized"

      239 |           email: 'unverified@upcoach.ai',
      240 |         };
    > 241 |
          | ^
      242 |         await request(app)
      243 |           .post(`${API_BASE_URL}/auth/register`)
      244 |           .send(unverifiedUser);

      at Object.<anonymous> (src/tests/integration/api.test.ts:241:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/refresh-token â€º should refresh valid token

    expected 200 "OK", got 404 "Not Found"

      257 |       it('should implement rate limiting', async () => {
      258 |         const maxAttempts = 5;
    > 259 |         const promises: Promise<unknown>[] = [];
          |                      ^
      260 |
      261 |         // Make multiple rapid login attempts
      262 |         for (let i = 0; i < maxAttempts + 2; i++) {

      at Object.<anonymous> (src/tests/integration/api.test.ts:259:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/forgot-password â€º should initiate password reset

    TypeError: Cannot read properties of undefined (reading 'id')

      267 |                 email: testUser.email,
      268 |                 password: 'WrongPassword123!',
    > 269 |               })
          |                 ^
      270 |           );
      271 |         }
      272 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:269:53)

  â— API Integration Tests â€º Authentication Endpoints â€º POST /auth/forgot-password â€º should handle non-existent email gracefully

    TypeError: Cannot read properties of undefined (reading 'id')

      267 |                 email: testUser.email,
      268 |                 password: 'WrongPassword123!',
    > 269 |               })
          |                 ^
      270 |           );
      271 |         }
      272 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:269:53)

  â— API Integration Tests â€º User Management Endpoints â€º GET /user/profile â€º should get user profile

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º GET /user/profile â€º should require authentication

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º PUT /user/profile â€º should update user profile

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º PUT /user/profile â€º should validate update data

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º POST /user/change-password â€º should change password with valid credentials

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º User Management Endpoints â€º POST /user/change-password â€º should reject incorrect current password

    TypeError: authHelper.getUserId is not a function

      293 |         expect(response.body).toMatchObject({
      294 |           success: true,
    > 295 |           message: 'Logout successful',
          |                                       ^
      296 |         });
      297 |
      298 |         // Verify token is invalidated

      at Object.<anonymous> (src/tests/integration/api.test.ts:295:39)

  â— API Integration Tests â€º Goals Management Endpoints â€º POST /goals â€º should create a new goal

    expected 201 "Created", got 404 "Not Found"

      398 |       });
      399 |
    > 400 |       it('should validate update data', async () => {
          |                      ^
      401 |         const invalidData = {
      402 |           email: 'invalid-email-format',
      403 |         };

      at Object.<anonymous> (src/tests/integration/api.test.ts:400:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Goals Management Endpoints â€º POST /goals â€º should validate goal data

    expected 400 "Bad Request", got 404 "Not Found"

      417 |         const passwordData = {
      418 |           currentPassword: testUser.password,
    > 419 |           newPassword: 'NewSecurePassword123!',
          |                      ^
      420 |           confirmPassword: 'NewSecurePassword123!',
      421 |         };
      422 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:419:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should get all user goals

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should support pagination

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals â€º should support filtering

    TypeError: Cannot read properties of undefined (reading 'id')

      429 |         expect(response.body).toMatchObject({
      430 |           success: true,
    > 431 |           message: 'Password changed successfully',
          |                                                  ^
      432 |         });
      433 |
      434 |         // Verify old password no longer works

      at Object.<anonymous> (src/tests/integration/api.test.ts:431:50)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals/:id â€º should get specific goal

    TypeError: Cannot read properties of undefined (reading 'id')

      471 |   describe('Goals Management Endpoints', () => {
      472 |     beforeEach(async () => {
    > 473 |       authToken = await authHelper.getAuthToken(testUser);
          |                                             ^
      474 |     });
      475 |
      476 |     describe('POST /goals', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:473:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º GET /goals/:id â€º should return 404 for non-existent goal

    TypeError: Cannot read properties of undefined (reading 'id')

      471 |   describe('Goals Management Endpoints', () => {
      472 |     beforeEach(async () => {
    > 473 |       authToken = await authHelper.getAuthToken(testUser);
          |                                             ^
      474 |     });
      475 |
      476 |     describe('POST /goals', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:473:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º PUT /goals/:id â€º should update goal

    TypeError: Cannot read properties of undefined (reading 'id')

      497 |           title: '', // Empty title
      498 |           category: 'invalid-category',
    > 499 |         };
          |           ^
      500 |
      501 |         const response = await request(app)
      502 |           .post(`${API_BASE_URL}/goals`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:499:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º PUT /goals/:id â€º should validate progress range

    TypeError: Cannot read properties of undefined (reading 'id')

      497 |           title: '', // Empty title
      498 |           category: 'invalid-category',
    > 499 |         };
          |           ^
      500 |
      501 |         const response = await request(app)
      502 |           .post(`${API_BASE_URL}/goals`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:499:45)

  â— API Integration Tests â€º Goals Management Endpoints â€º DELETE /goals/:id â€º should delete goal

    TypeError: Cannot read properties of undefined (reading 'id')

      528 |       it('should get all user goals', async () => {
      529 |         const response = await request(app)
    > 530 |           .get(`${API_BASE_URL}/goals`)
          |                                        ^
      531 |           .set('Authorization', `Bearer ${authToken}`)
      532 |           .expect(200);
      533 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:530:45)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits â€º should create a new habit

    expected 201 "Created", got 404 "Not Found"

      553 |       it('should support filtering', async () => {
      554 |         const response = await request(app)
    > 555 |           .get(`${API_BASE_URL}/goals?category=development`)
          |                      ^
      556 |           .set('Authorization', `Bearer ${authToken}`)
      557 |           .expect(200);
      558 |

      at Object.<anonymous> (src/tests/integration/api.test.ts:555:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits/:id/check-in â€º should record habit completion

    TypeError: Cannot read properties of undefined (reading 'id')

      569 |           .send(testGoal);
      570 |
    > 571 |         goalId = response.body.goal.id;
          |                                        ^
      572 |       });
      573 |
      574 |       it('should get specific goal', async () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:571:47)

  â— API Integration Tests â€º Habits Management Endpoints â€º POST /habits/:id/check-in â€º should update streak correctly

    TypeError: Cannot read properties of undefined (reading 'id')

      569 |           .send(testGoal);
      570 |
    > 571 |         goalId = response.body.goal.id;
          |                                        ^
      572 |       });
      573 |
      574 |       it('should get specific goal', async () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:571:47)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should upload user avatar

    expected 200 "OK", got 404 "Not Found"

      611 |         };
      612 |
    > 613 |         const response = await request(app)
          |                      ^
      614 |           .put(`${API_BASE_URL}/goals/${goalId}`)
      615 |           .set('Authorization', `Bearer ${authToken}`)
      616 |           .send(updateData)

      at Object.<anonymous> (src/tests/integration/api.test.ts:613:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should validate file type

    expected 400 "Bad Request", got 404 "Not Found"

      621 |
      622 |       it('should validate progress range', async () => {
    > 623 |         const invalidUpdate = { progress: 150 }; // Over 100%
          |                      ^
      624 |
      625 |         const response = await request(app)
      626 |           .put(`${API_BASE_URL}/goals/${goalId}`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:623:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º File Upload Endpoints â€º POST /upload/avatar â€º should validate file size

    write ECONNRESET



  â— API Integration Tests â€º Real-time WebSocket Connections â€º should establish WebSocket connection with authentication

    Unexpected server response: 404

      at ClientRequest.<anonymous> (../../node_modules/ws/lib/websocket.js:913:7)

  â— API Integration Tests â€º Real-time WebSocket Connections â€º should reject unauthenticated WebSocket connections

    expect(received).toBe(expected) // Object.is equality

    Expected: 1008
    Received: 1006

      653 |           .get(`${API_BASE_URL}/goals/${goalId}`)
      654 |           .set('Authorization', `Bearer ${authToken}`)
    > 655 |           .expect(404);
          |                        ^
      656 |       });
      657 |     });
      658 |   });

      at WebSocket.<anonymous> (src/tests/integration/api.test.ts:655:45)
      at WebSocket.emitClose (../../node_modules/ws/lib/websocket.js:262:12)
      at emitErrorAndClose (../../node_modules/ws/lib/websocket.js:1042:13)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle malformed JSON

    expected 400 "Bad Request", got 500 "Internal Server Error"

      672 |
      673 |         expect(response.body.habit).toMatchObject({
    > 674 |           name: testHabit.name,
          |                  ^
      675 |           description: testHabit.description,
      676 |           category: testHabit.category,
      677 |           frequency: testHabit.frequency,

      at Object.<anonymous> (src/tests/integration/api.test.ts:674:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle missing required headers

    expected 401 "Unauthorized", got 404 "Not Found"

      679 |
      680 |         habitId = response.body.habit.id;
    > 681 |       });
          |          ^
      682 |     });
      683 |
      684 |     describe('POST /habits/:id/check-in', () => {

      at Object.<anonymous> (src/tests/integration/api.test.ts:681:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle database connection errors gracefully

    TypeError: DatabaseService_1.DatabaseService.disconnect is not a function

      684 |     describe('POST /habits/:id/check-in', () => {
      685 |       beforeEach(async () => {
    > 686 |         const response = await request(app)
          |                                            ^
      687 |           .post(`${API_BASE_URL}/habits`)
      688 |           .set('Authorization', `Bearer ${authToken}`)
      689 |           .send(testHabit);

      at Object.<anonymous> (src/tests/integration/api.test.ts:686:53)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should return appropriate CORS headers

    expected 200 "OK", got 204 "No Content"

      696 |           completed: true,
      697 |           notes: 'Completed morning code review',
    > 698 |           quality: 8,
          |                  ^
      699 |         };
      700 |
      701 |         const response = await request(app)

      at Object.<anonymous> (src/tests/integration/api.test.ts:698:18)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

  â— API Integration Tests â€º Error Handling and Edge Cases â€º should handle concurrent requests safely

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 0

      710 |
      711 |       it('should update streak correctly', async () => {
    > 712 |         // Complete habit for today
          |                                    ^
      713 |         await request(app)
      714 |           .post(`${API_BASE_URL}/habits/${habitId}/check-in`)
      715 |           .set('Authorization', `Bearer ${authToken}`)

      at Object.<anonymous> (src/tests/integration/api.test.ts:712:47)

  â— API Integration Tests â€º Performance and Load Testing â€º should handle multiple simultaneous requests

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      727 |   });
      728 |
    > 729 |   describe('File Upload Endpoints', () => {
          |                                            ^
      730 |     beforeEach(async () => {
      731 |       authToken = await authHelper.getAuthToken(testUser);
      732 |     });

      at Object.<anonymous> (src/tests/integration/api.test.ts:729:73)

  â— API Integration Tests â€º Performance and Load Testing â€º should maintain response times under load

    expected 200 "OK", got 404 "Not Found"

      739 |           .post(`${API_BASE_URL}/upload/avatar`)
      740 |           .set('Authorization', `Bearer ${authToken}`)
    > 741 |           .attach('avatar', testImage, 'test-avatar.png')
          |                      ^
      742 |           .expect(200);
      743 |
      744 |         expect(response.body.success).toBe(true);

      at Object.<anonymous> (src/tests/integration/api.test.ts:741:22)
      ----
      at Test._assertStatus (../../node_modules/supertest/lib/test.js:309:14)
      at ../../node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (../../node_modules/supertest/lib/test.js:342:13)
      at Test.assert (../../node_modules/supertest/lib/test.js:195:23)
      at localAssert (../../node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (../../node_modules/supertest/lib/test.js:152:11)

FAIL src/__tests__/integration/goal-management-flow.test.ts
  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:20:41)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should complete entire goal lifecycle with gamification

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should handle recurring goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should handle recurring goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should archive completed goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º End-to-End: Complete Goal Management Flow â€º should archive completed goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should create goal with all optional fields

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should create goal with all optional fields

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate required fields

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate required fields

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate target date is in future

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate target date is in future

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate category from allowed list

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Creation and Validation â€º should validate category from allowed list

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should add progress update

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should add progress update

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should retrieve progress history

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should retrieve progress history

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should calculate progress trend

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Progress Tracking â€º should calculate progress trend

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should create milestone with correct order

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should create milestone with correct order

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should update milestone status

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should update milestone status

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should auto-update goal progress when milestones complete

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should auto-update goal progress when milestones complete

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should reorder milestones

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Milestone Management â€º should reorder milestones

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI recommendations for goal

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI recommendations for goal

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI-suggested milestones

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get AI-suggested milestones

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get personalized goal insights

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º AI Coaching Integration â€º should get personalized goal insights

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award points for goal creation

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award points for goal creation

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award achievement for completing multiple goals

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should award achievement for completing multiple goals

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should track goal completion streak

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Gamification Integration â€º should track goal completion streak

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should share goal with coach

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should share goal with coach

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should allow coach to provide feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should allow coach to provide feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should make goal public and visible to community

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Sharing and Collaboration â€º should make goal public and visible to community

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should calculate comprehensive goal analytics

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should calculate comprehensive goal analytics

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should provide monthly progress report

    TypeError: Cannot read properties of undefined (reading 'create')

      70 |       .post('/api/auth/login')
      71 |       .send({
    > 72 |         email: 'goaluser@example.com',
         |                                  ^
      73 |         password: 'hashedPassword123',
      74 |       });
      75 |

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:72:34)

  â— Integration: Goal Management Flow â€º Goal Analytics â€º should provide monthly progress report

    TypeError: Cannot read properties of undefined (reading 'destroy')

       96 |     // Create achievements
       97 |     await Achievement.create({
    >  98 |       id: 1,
          |             ^
       99 |       name: 'First Goal',
      100 |       description: 'Created your first goal',
      101 |       category: 'goals',

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:98:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      31 |   let testUser: any;
      32 |   let authToken: string;
    > 33 |   let coachUser: any;
         |                      ^
      34 |   let coachToken: string;
      35 |
      36 |   beforeAll(async () => {

      at Object.<anonymous> (src/__tests__/integration/goal-management-flow.test.ts:33:34)

FAIL src/__tests__/e2e/complete-user-journeys.test.ts
  â— E2E: Complete User Journeys â€º Journey 1: New User Complete Onboarding to Premium Subscription â€º should complete full user journey from registration to premium subscription

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 1: New User Complete Onboarding to Premium Subscription â€º should complete full user journey from registration to premium subscription

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 2: Coach Onboarding and Session Management â€º should complete full coach journey from registration to receiving payments

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 2: Coach Onboarding and Session Management â€º should complete full coach journey from registration to receiving payments

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 3: Cross-Service Integration - Goal â†’ AI â†’ Coaching â†’ Gamification â€º should validate integration between all major services

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 3: Cross-Service Integration - Goal â†’ AI â†’ Coaching â†’ Gamification â€º should validate integration between all major services

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle payment failure and retry successfully

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle payment failure and retry successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle session cancellation and rescheduling

    TypeError: Cannot read properties of undefined (reading 'bulkCreate')

      31 |
      32 | // Mock external services
    > 33 | jest.mock('stripe');
         |                     ^
      34 | jest.mock('../../services/email/UnifiedEmailService');
      35 | jest.mock('../../services/coaching/CoachIntelligenceService');
      36 |

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:33:36)

  â— E2E: Complete User Journeys â€º Journey 4: Error Recovery and Edge Cases â€º should handle session cancellation and rescheduling

    TypeError: Cannot read properties of undefined (reading 'destroy')

      79 |         icon: 'crown',
      80 |       },
    > 81 |       {
         |        ^
      82 |         id: 5,
      83 |         name: 'First Session',
      84 |         description: 'Completed your first coaching session',

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:81:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      75 |         name: 'Premium Member',
      76 |         description: 'Subscribed to premium',
    > 77 |         category: 'subscription',
         |                                  ^
      78 |         points: 200,
      79 |         icon: 'crown',
      80 |       },

      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:77:34)

  â— Test suite failed to run

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/e2e/complete-user-journeys.test.ts:21:41)

FAIL src/__tests__/integration/coaching-session-flow.test.ts
  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should complete entire coaching session lifecycle successfully

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should complete entire coaching session lifecycle successfully

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session cancellation by client

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session cancellation by client

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session rescheduling

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º End-to-End: Complete Coaching Session Flow â€º should handle session rescheduling

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should search coaches by specialization

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should search coaches by specialization

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by minimum rating

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by minimum rating

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by price range

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by price range

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by language

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should filter coaches by language

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should sort coaches by rating

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Discovery and Search â€º should sort coaches by rating

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent double-booking the same time slot

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent double-booking the same time slot

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking outside coach availability

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking outside coach availability

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking in the past

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should prevent booking in the past

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should require minimum advance booking time

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Booking Validation â€º should require minimum advance booking time

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should submit valid feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should submit valid feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent duplicate feedback

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent duplicate feedback

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should validate rating range (1-5)

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should validate rating range (1-5)

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent feedback before session completion

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Feedback and Ratings â€º should prevent feedback before session completion

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should calculate coach analytics correctly

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should calculate coach analytics correctly

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should retrieve session statistics by date range

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should retrieve session statistics by date range

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should track top-performing coaches

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Coach Analytics and Metrics â€º should track top-performing coaches

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)

  â— Integration: Coaching Session Flow â€º Session Notifications â€º should send reminder before session starts

    TypeError: Cannot read properties of undefined (reading 'create')

      55 |       role: 'coach',
      56 |       emailVerified: true,
    > 57 |       isActive: true,
         |                      ^
      58 |     });
      59 |
      60 |     // Create coach profile

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:57:52)

  â— Integration: Coaching Session Flow â€º Session Notifications â€º should send reminder before session starts

    TypeError: Cannot read properties of undefined (reading 'destroy')

      100 |
      101 |     await CoachAvailability.create({
    > 102 |       coachId: coachUser.id,
          |                             ^
      103 |       dayOfWeek: 3, // Wednesday
      104 |       startTime: '09:00',
      105 |       endTime: '17:00',

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:102:40)


  â— Test suite failed to run

    TypeError: models_2.sequelize.close is not a function

      31 |   });
      32 |
    > 33 |   afterAll(async () => {
         |                         ^
      34 |     await sequelize.close();
      35 |   });
      36 |

      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:33:34)

  â— Test suite failed to run

    listen EADDRINUSE: address already in use :::1080



      at Function.listen (../../node_modules/express/lib/application.js:635:24)
      at Object.<anonymous> (src/index.ts:460:41)
      at Object.<anonymous> (src/__tests__/integration/coaching-session-flow.test.ts:19:41)

FAIL src/__tests__/services/GDPRService.test.ts
  â— GDPRService â€º Singleton Pattern â€º should return the same instance

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should record user consent successfully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should hash IP address for privacy

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should set expiration date for granted consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should not set expiration for revoked consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º recordConsent â€º should handle database errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should retrieve all consent statuses for a user

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should handle expired consent

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should default necessary consent to true

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getConsentStatus â€º should handle Redis errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should create data portability request

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should process data export in background

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should support different export formats

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDataPortability â€º should set expiration for download links

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should create deletion request with grace period

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should prevent deletion if user not found

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º requestDeletion â€º should allow specifying data to retain

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should cancel pending deletion request

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel if request not found

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel if user does not match

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º cancelDeletion â€º should not cancel already completed deletions

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should record data breach incident

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should handle critical breaches with urgency

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º reportDataBreach â€º should track containment actions

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getDataRetentionPolicy â€º should return data retention policy

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º getDataRetentionPolicy â€º should include legal basis for retention

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should clean up expired data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should handle cleanup errors gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º runDataRetentionCleanup â€º should respect retention periods

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should generate comprehensive privacy policy data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should include all user rights

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º generatePrivacyPolicyData â€º should include security measures

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should handle concurrent consent updates

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should handle invalid consent purposes gracefully

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Edge Cases and Error Handling â€º should validate user input in deletion requests

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Performance Considerations â€º should batch operations where possible

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

  â— GDPRService â€º Performance Considerations â€º should use caching for frequently accessed data

    TypeError: Cannot read properties of undefined (reading 'getInstance')

      65 |
      66 |   const testUserId = 'user-123';
    > 67 |   const testIpAddress = '192.168.1.1';
         |                                       ^
      68 |   const testUserAgent = 'Mozilla/5.0 Test Browser';
      69 |
      70 |   beforeEach(() => {

      at Object.<anonymous> (src/__tests__/services/GDPRService.test.ts:67:49)

FAIL src/__tests__/services/CoachIntelligenceService.test.ts
  â— CoachIntelligenceService â€º processCoachingSession â€º should process a coaching session and store memory

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      52 |     };
      53 |
    > 54 |     test('should process a coaching session and store memory', async () => {
         |                                       ^
      55 |       const mockAIResponse = {
      56 |         content: 'Great progress on your goals! Key insights: improved focus and consistency.',
      57 |       };

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:54:39)

  â— CoachIntelligenceService â€º processCoachingSession â€º should handle AI service errors gracefully

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      75 |             role: 'system',
      76 |             content: expect.stringContaining('extract insights'),
    > 77 |           }),
         |              ^
      78 |         ])
      79 |       );
      80 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:77:39)

  â— CoachIntelligenceService â€º processCoachingSession â€º should extract and store user feedback

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      86 |           avatarId: testAvatarId,
      87 |           contentType: 'conversation',
    > 88 |         })
         |           ^
      89 |       );
      90 |     });
      91 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:88:39)

  â— CoachIntelligenceService â€º getRelevantMemories â€º should retrieve relevant memories for a user

    TypeError: memory.updateRelevanceScore is not a function



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60346:14)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:108:28)

  â— CoachIntelligenceService â€º getRelevantMemories â€º should apply topic filtering when provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": ObjectContaining {Symbol(or): ArrayContaining [{"content": ObjectContaining {Symbol(iLike): "%specific topic%"}}, {"keyTopics": ObjectContaining {Symbol(contains): ["specific topic"]}}]}}
    Received: {"order": [["conversationDate", "DESC"]], "where": {"conversationDate": {Symbol(gte): 2025-08-17T06:45:59.504Z}, "userId": "user-123"}}

    Number of calls: 1

      126 |           sentiment: expect.any(Number),
      127 |         })
    > 128 |       );
          |         ^
      129 |     });
      130 |   });
      131 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:128:60)

  â— CoachIntelligenceService â€º generateCoachingRecommendations â€º should generate recommendations based on user history

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      156 |       expect(result[0]).toHaveProperty('relevance');
      157 |     });
    > 158 |
          | ^
      159 |     test('should handle empty memory results', async () => {
      160 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue([]);
      161 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:158:39)

  â— CoachIntelligenceService â€º generateCoachingRecommendations â€º should provide fallback recommendations on AI failure

    TypeError: Cannot read properties of undefined (reading 'mockRejectedValue')

      182 |               { content: expect.objectContaining({ [Op.iLike]: '%specific topic%' }) },
      183 |               { keyTopics: expect.objectContaining({ [Op.contains]: ['specific topic'] }) },
    > 184 |             ]),
          |                ^
      185 |           }),
      186 |         })
      187 |       );

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:184:39)

  â— CoachIntelligenceService â€º generateWeeklyReport â€º should generate a comprehensive weekly report

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      224 |               implementation: ['Block calendar', 'Set timers'],
      225 |             },
    > 226 |           ],
          |             ^
      227 |         }),
      228 |       });
      229 |

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:226:39)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should calculate comprehensive user analytics

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:290:28)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should handle missing analytics record

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))



      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60842:5)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:311:28)

  â— CoachIntelligenceService â€º calculateUserAnalytics â€º should calculate correct engagement metrics

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:331:28)

  â— CoachIntelligenceService â€º Error Handling â€º should handle database errors gracefully

    Database connection failed

      358 |       const mockGoals = [
      359 |         { id: '1', progress: 80, status: 'in_progress' },
    > 360 |         { id: '2', progress: 100, status: 'completed' },
          |                                                         ^
      361 |       ];
      362 |
      363 |       const mockAnalytics = {

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:360:77)

  â— CoachIntelligenceService â€º Error Handling â€º should handle invalid JSON from AI service

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      365 |         save: jest.fn(),
      366 |       };
    > 367 |
          | ^
      368 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue(mockMemories);
      369 |       mockKpiTracker.findAll = jest.fn().mockResolvedValue(mockGoals);
      370 |       mockUserAnalytics.findOne = jest.fn().mockResolvedValue(mockAnalytics);

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:367:39)

  â— CoachIntelligenceService â€º Error Handling â€º should handle null or undefined inputs

    TypeError: allMemories is not iterable



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60343:26)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:375:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should calculate mood trends accurately

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:390:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should identify achievement patterns

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:411:28)

  â— CoachIntelligenceService â€º Analytics Calculations â€º should identify challenge areas

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:67280:90
          at Array.map (<anonymous>)
      at CoachIntelligenceService.calculateMoodTrend (src/services/coaching/CoachIntelligenceService.ts:67276:49)
      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60626:23)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:433:28)

  â— CoachIntelligenceService â€º Recommendation Generation â€º should prioritize recommendations based on user needs

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      446 |       ];
      447 |
    > 448 |       // Test via public method that uses private calculateStreakCount
          |                                       ^
      449 |       mockCoachMemory.findAll = jest.fn().mockResolvedValue(memories);
      450 |       mockKpiTracker.findAll = jest.fn().mockResolvedValue([]);
      451 |       mockUserAnalytics.findOne = jest.fn().mockResolvedValue({

      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:448:39)

  â— CoachIntelligenceService â€º Recommendation Generation â€º should generate schedule recommendations based on patterns

    TypeError: Cannot read properties of undefined (reading 'sentiment')



      at src/services/coaching/CoachIntelligenceService.ts:66483:59
          at Array.map (<anonymous>)
      at CoachIntelligenceService.analyzeEmotionalPatterns (src/services/coaching/CoachIntelligenceService.ts:66475:49)
      at CoachIntelligenceService.generateCoachingRecommendations (src/services/coaching/CoachIntelligenceService.ts:60529:37)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:475:37)

  â— CoachIntelligenceService â€º Performance Optimizations â€º should batch database queries efficiently

    TypeError: Cannot read properties of undefined (reading 'length')



      at CoachIntelligenceService.generateWeeklyReport (src/services/coaching/CoachIntelligenceService.ts:60614:37)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:482:13)

  â— CoachIntelligenceService â€º Performance Optimizations â€º should cache frequently accessed data

    TypeError: allMemories is not iterable



      at CoachIntelligenceService.getRelevantMemories (src/services/coaching/CoachIntelligenceService.ts:60343:26)
      at Object.<anonymous> (src/__tests__/services/CoachIntelligenceService.test.ts:489:13)


  â— Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'importance')



      at src/services/coaching/CoachIntelligenceService.ts:60741:40
          at Array.reduce (<anonymous>)
      at CoachIntelligenceService.calculateUserAnalytics (src/services/coaching/CoachIntelligenceService.ts:60737:31)

FAIL src/__tests__/services/WebAuthnService.test.ts
  â— WebAuthnService â€º generateRegistrationOptions â€º should generate registration options for new credential

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:101:28)

  â— WebAuthnService â€º generateRegistrationOptions â€º should exclude existing credentials

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:128:13)

  â— WebAuthnService â€º generateRegistrationOptions â€º should store challenge in Redis

    Failed to generate registration options



      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:149:13)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should verify valid registration response

    Failed to store credential



      at WebAuthnService.storeCredential (src/services/WebAuthnService.ts:3797:13)
      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3442:9)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:188:28)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should reject invalid challenge

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid or expired challenge"
    Received message:   "Registration challenge not found or expired"

      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3380:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:206:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:206:148)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should reject expired challenge

    expect(received).rejects.toThrow(expected)

    Expected substring: "Invalid or expired challenge"
    Received message:   "Registration challenge not found or expired"

      at WebAuthnService.verifyRegistrationResponse (src/services/WebAuthnService.ts:3380:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:225:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:225:142)

  â— WebAuthnService â€º verifyRegistrationResponse â€º should store credential after successful verification

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "webauthn:credentials:user123", StringContaining "test-credential-id-123"
    Received
           1: "webauthn:credentials:user123", "[{\"credentialID\":\"dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==\",\"credentialPublicKey\":\"cHVibGljLWtleQ==\",\"counter\":0,\"userId\":\"user123\",\"name\":\"test-challenge-abc123\",\"createdAt\":\"2025-11-15T06:46:00.024Z\",\"backedUp\":false,\"deviceType\":\"unknown\"}]"
           2: "webauthn:credential:dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==", "{\"credentialID\":\"dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==\",\"credentialPublicKey\":\"cHVibGljLWtleQ==\",\"counter\":0,\"userId\":\"user123\",\"name\":\"test-challenge-abc123\",\"createdAt\":\"2025-11-15T06:46:00.024Z\",\"backedUp\":false,\"deviceType\":\"unknown\"}"

    Number of calls: 2

      254 |       mockRedis.get.mockResolvedValue(
      255 |         JSON.stringify({
    > 256 |           challenge: testChallenge,
          |                                    ^
      257 |           userId: testUserId,
      258 |           type: 'registration',
      259 |         })

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:256:50)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should generate authentication options

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:308:28)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should work without user ID (discoverable credentials)

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:328:28)

  â— WebAuthnService â€º generateAuthenticationOptions â€º should store authentication challenge

    Failed to generate authentication options



      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:338:13)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should verify valid authentication response

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |     test('should delete challenge after verification', async () => {
    > 375 |       const registrationResponse: RegistrationResponseJSON = {
          |                                                    ^
      376 |         id: testCredentialId,
      377 |         rawId: testCredentialId,
      378 |         response: {

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:375:52)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should update counter after successful authentication

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "webauthn:credentials:user123", StringContaining "\"counter\":10"

    Number of calls: 0

      410 |     });
      411 |   });
    > 412 |
          | ^
      413 |   describe('generateAuthenticationOptions', () => {
      414 |     test('should generate authentication options', async () => {
      415 |       const existingCredentials = [

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:412:50)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should reject if credential not found

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"verified": false}

      428 |         timeout: 60000,
      429 |         userVerification: 'preferred',
    > 430 |         rpId: 'test.upcoach.ai',
          |                                 ^
      431 |         allowCredentials: [{
      432 |           id: Buffer.from(testCredentialId).toString('base64'),
      433 |           type: 'public-key',

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:430:40)

  â— WebAuthnService â€º verifyAuthenticationResponse â€º should update lastUsedAt timestamp

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, StringContaining "\"lastUsedAt\""

    Number of calls: 0

      461 |         rpId: 'test.upcoach.ai',
      462 |       };
    > 463 |
          | ^
      464 |       mockGenerateAuthenticationOptions.mockResolvedValue(mockOptions);
      465 |
      466 |       const result = await webAuthnService.generateAuthenticationOptions();

      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:463:50)

  â— WebAuthnService â€º deleteCredential â€º should handle credential not found

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: undefined

      514 |           challenge: testChallenge,
      515 |           type: 'authentication',
    > 516 |         })
          |           ^
      517 |       );
      518 |       mockRedis.get.mockResolvedValueOnce(JSON.stringify([storedCredential]));
      519 |

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:516:40)

  â— WebAuthnService â€º Rate Limiting â€º should rate limit registration attempts

    expect(received).rejects.toThrow(expected)

    Expected substring: "Too many registration attempts"
    Received message:   "Failed to generate registration options"

      at WebAuthnService.generateRegistrationOptions (src/services/WebAuthnService.ts:3359:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:524:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:524:141)

  â— WebAuthnService â€º Rate Limiting â€º should rate limit authentication attempts

    expect(received).rejects.toThrow(expected)

    Expected substring: "Too many authentication attempts"
    Received message:   "Failed to generate authentication options"

      at WebAuthnService.generateAuthenticationOptions (src/services/WebAuthnService.ts:3552:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:530:13)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:530:108)

  â— WebAuthnService â€º Rate Limiting â€º should allow requests within rate limit

    expect(received).resolves.toBeDefined()

    Received promise rejected instead of resolved
    Rejected to value: [Error: Failed to generate registration options]

      534 |       );
      535 |
    > 536 |       expect(result.verified).toBe(true);
          |                                        ^
      537 |       expect(result.credential).toEqual(
      538 |         expect.objectContaining({
      539 |           credentialID: testCredentialId,

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:536:40)

  â— WebAuthnService â€º Security Features â€º should prevent credential ID reuse

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"credentialId": "dGVzdC1jcmVkZW50aWFsLWlkLTEyMw==", "verified": true}

      599 |           authenticatorData: 'authenticator-data',
      600 |           signature: 'signature',
    > 601 |         },
          |           ^
      602 |         type: 'public-key',
      603 |       };
      604 |

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/WebAuthnService.test.ts:601:40)

FAIL src/__tests__/services/AIService.test.ts
  â— AIService â€º generateResponse â€º should generate response using OpenAI by default

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:78:28)

  â— AIService â€º generateResponse â€º should generate response using Claude when specified

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:126:28)

  â— AIService â€º generateResponse â€º should use cache when useCache option is enabled

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:166:28)

  â— AIService â€º generateResponse â€º should handle prompt injection detection

    expect(received).rejects.toThrow(expected)

    Expected substring: "Input validation failed: Potential prompt injection detected"
    Received message:   "Cannot read properties of undefined (reading 'message')"

      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:180:13)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:180:87)

  â— AIService â€º generateResponse â€º should handle API errors gracefully

    expect(received).rejects.toThrow(expected)

    Expected substring: "AI service error: API Error"
    Received message:   "Cannot read properties of undefined (reading 'message')"

      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:188:13)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:188:87)

  â— AIService â€º generateResponse â€º should apply custom temperature and maxTokens

    TypeError: Cannot read properties of undefined (reading 'message')



      at AIService.generateResponse (src/services/ai/AIService.ts:4925:28)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:215:13)

  â— AIService â€º generateStreamResponse â€º should generate streaming response

    TypeError: aiService.generateStreamResponse is not a function

      249 |       ];
      250 |
    > 251 |       const options: AIOptions = {
          |                                   ^
      252 |         temperature: 0.9,
      253 |         maxTokens: 1000,
      254 |       };

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:251:44)

  â— AIService â€º validateApiKeys â€º should validate API keys successfully

    TypeError: aiService.validateApiKeys is not a function

      265 |   });
      266 |
    > 267 |   describe('generateStreamResponse', () => {
          |                                            ^
      268 |     test('should generate streaming response', async () => {
      269 |       const mockStream = {
      270 |         [Symbol.asyncIterator]: async function* () {

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:267:44)

  â— AIService â€º validateApiKeys â€º should handle invalid API keys

    TypeError: aiService.validateApiKeys is not a function

      273 |               delta: {
      274 |                 content: 'Hello',
    > 275 |               },
          |                 ^
      276 |             }],
      277 |           };
      278 |           yield {

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:275:44)

  â— AIService â€º getUsageStats â€º should return usage statistics

    TypeError: aiService.getUsageStats is not a function

      282 |               },
      283 |             }],
    > 284 |           };
          |             ^
      285 |         },
      286 |       };
      287 |

      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:284:43)

  â— AIService â€º clearCache â€º should clear AI service cache

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).invalidate is not a function



      at AIService.clearCache (src/services/ai/AIService.ts:5484:56)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:293:29)

  â— AIService â€º healthCheck â€º should perform health check

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).getStats is not a function



      at AIService.healthCheck (src/services/ai/AIService.ts:5543:78)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:302:44)

  â— AIService â€º healthCheck â€º should detect unhealthy services

    TypeError: (0 , UnifiedCacheService_1.getCacheService)(...).getStats is not a function



      at AIService.healthCheck (src/services/ai/AIService.ts:5543:78)
      at Object.<anonymous> (src/__tests__/services/AIService.test.ts:315:44)

FAIL src/__tests__/middleware/auth.test.ts
  â— Auth Middleware â€º generateTokens â€º should generate valid access and refresh tokens

    expect(received).toBe(expected) // Object.is equality

    Expected: "test@example.com"
    Received: undefined

      40 |       });
      41 |
    > 42 |       const tokens = generateTokens(userId, email, role, req);
         |                                                        ^
      43 |
      44 |       expect(tokens).toHaveProperty('accessToken');
      45 |       expect(tokens).toHaveProperty('refreshToken');

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:42:56)

  â— Auth Middleware â€º generateTokens â€º should include IP and user agent in token metadata

    expect(received).toBe(expected) // Object.is equality

    Expected: "192.168.1.1"
    Received: undefined

      55 |
      56 |       // Verify refresh token payload
    > 57 |       const refreshPayload = jwt.verify(tokens.refreshToken, 'test-refresh-secret') as unknown;
         |                                                     ^
      58 |       expect(refreshPayload.userId).toBe(userId);
      59 |       expect(refreshPayload.type).toBe('refresh');
      60 |     });

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:57:53)

  â— Auth Middleware â€º verifyRefreshToken â€º should verify valid refresh token

    Invalid refresh token



      at verifyRefreshToken (src/middleware/auth.ts:3439:11)
      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:66:58)

  â— Auth Middleware â€º blacklistToken â€º should blacklist token in Redis

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      86 |
      87 |     test('should throw error for invalid refresh token', () => {
    > 88 |       expect(() => {
         |                     ^
      89 |         verifyRefreshToken('invalid-token');
      90 |       }).toThrow();
      91 |     });

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:88:48)

  â— Auth Middleware â€º blacklistToken â€º should set appropriate TTL for blacklisted token

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   -2

      93 |     test('should throw error for access token used as refresh token', () => {
      94 |       const req = createMockRequest();
    > 95 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', req);
         |                                        ^
      96 |
      97 |       expect(() => {
      98 |         verifyRefreshToken(tokens.accessToken);

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:95:40)

  â— Auth Middleware â€º authMiddleware â€º should authenticate valid token

    expect(received).toEqual(expected) // deep equality

    Expected: {"email": "test@example.com", "id": "test-user-id", "role": "user"}
    Received: null

      115 |       const req = createMockRequest();
      116 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', req);
    > 117 |
          | ^
      118 |       await blacklistToken(tokens.accessToken);
      119 |
      120 |       const ttl = await mockRedis.ttl(`blacklist:${tokens.accessToken}`);

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:117:45)

  â— Auth Middleware â€º authMiddleware â€º should reject missing authorization header

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Access token required",
    +   "error": "Authentication required",
        "success": false,
      },

    Number of calls: 1

      125 |   describe('authMiddleware', () => {
      126 |     let req: AuthenticatedRequest;
    > 127 |     let res: Response;
          |                       ^
      128 |     let next: NextFunction;
      129 |
      130 |     beforeEach(() => {

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:127:45)

  â— Auth Middleware â€º authMiddleware â€º should reject malformed authorization header

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid token format",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      137 |       const userId = 'test-user-id';
      138 |       const email = 'test@example.com';
    > 139 |       const role = 'user';
          |                           ^
      140 |       const mockReq = createMockRequest();
      141 |       const tokens = generateTokens(userId, email, role, mockReq);
      142 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:139:45)

  â— Auth Middleware â€º authMiddleware â€º should reject invalid token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      149 |       expect(req.user).toEqual({
      150 |         id: userId,
    > 151 |         email: email,
          |                      ^
      152 |         role: role
      153 |       });
      154 |       expect(next).toHaveBeenCalledWith();

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:151:45)

  â— Auth Middleware â€º authMiddleware â€º should reject blacklisted token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Token has been revoked",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      166 |     });
      167 |
    > 168 |     test('should reject malformed authorization header', async () => {
          |                                             ^
      169 |       req.headers = {
      170 |         authorization: 'Invalid format'
      171 |       };

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:168:45)

  â— Auth Middleware â€º authMiddleware â€º should reject refresh token used as access token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid token type",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      180 |       expect(next).not.toHaveBeenCalled();
      181 |     });
    > 182 |
          | ^
      183 |     test('should reject invalid token', async () => {
      184 |       req.headers = {
      185 |         authorization: 'Bearer invalid-token'

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:182:45)

  â— Auth Middleware â€º authMiddleware â€º should handle expired token gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Invalid or expired token",
    +   "error": "Invalid token structure",
        "success": false,
      },

    Number of calls: 1

      200 |       const mockReq = createMockRequest();
      201 |       const tokens = generateTokens(userId, 'test@example.com', 'user', mockReq);
    > 202 |
          | ^
      203 |       // Blacklist the token
      204 |       await blacklistToken(tokens.accessToken);
      205 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:202:45)

  â— Auth Middleware â€º authMiddleware â€º should handle Redis connection errors gracefully

    expect(received).toEqual(expected) // deep equality

    Expected: {"email": "test@example.com", "id": "test-user-id", "role": "user"}
    Received: null

      218 |     });
      219 |
    > 220 |     test('should reject refresh token used as access token', async () => {
          |                                             ^
      221 |       const mockReq = createMockRequest();
      222 |       const tokens = generateTokens('user-id', 'user@example.com', 'user', mockReq);
      223 |

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:220:45)

  â— Auth Middleware â€º Token Security â€º should use different secrets for access and refresh tokens

    expect(received).toThrow()

    Received function did not throw

      235 |       expect(next).not.toHaveBeenCalled();
      236 |     });
    > 237 |
          | ^
      238 |     test('should handle expired token gracefully', async () => {
      239 |       // Create expired token
      240 |       const expiredToken = jwt.sign(

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:237:16)

  â— Auth Middleware â€º Token Security â€º should include unique jti in tokens

    expect(received).toBeDefined()

    Received: undefined

      247 |         'test-jwt-secret',
      248 |         { expiresIn: '-1s' } // Already expired
    > 249 |       );
          |         ^
      250 |
      251 |       req.headers = {
      252 |         authorization: `Bearer ${expiredToken}`

      at Object.<anonymous> (src/__tests__/middleware/auth.test.ts:249:49)

FAIL src/__tests__/services/TwoFactorAuthService.test.ts
  â— TwoFactorAuthService â€º generateSecret â€º should generate a new 2FA secret successfully

    Failed to save 2FA secret



      at TwoFactorAuthService.generateSecret (src/services/TwoFactorAuthService.ts:12247:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:51:28)

  â— TwoFactorAuthService â€º generateSecret â€º should handle QR code generation failure

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate QR code"
    Received message:   "Failed to save 2FA secret"

      at TwoFactorAuthService.generateSecret (src/services/TwoFactorAuthService.ts:12247:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:80:13)
      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:81:26)

  â— TwoFactorAuthService â€º Error handling â€º should handle Redis connection errors gracefully

    Redis connection failed

      302 |
      303 |       const result = await twoFactorService.generateBackupCodes(testUserId);
    > 304 |
          | ^
      305 |       expect(result).toHaveLength(10);
      306 |       expect(result.every(code => typeof code === 'string' && code.length === 8)).toBe(true);
      307 |       expect(mockUserInstance.update).toHaveBeenCalledWith({

      at Object.<anonymous> (src/__tests__/services/TwoFactorAuthService.test.ts:304:69)


  â— Test suite failed to run

    2FA is not enabled



      at TwoFactorAuthService.generateBackupCodes (src/services/TwoFactorAuthService.ts:12625:13)

  â— Test suite failed to run

    2FA is not enabled



      at TwoFactorAuthService.generateBackupCodes (src/services/TwoFactorAuthService.ts:12625:13)

FAIL src/__tests__/services/RedisService.test.ts
  â— RedisService â€º Connection Management â€º should connect to Redis successfully

    expect(received).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      26 |   });
      27 |
    > 28 |   describe('Connection Management', () => {
         |                                            ^
      29 |     test('should connect to Redis successfully', async () => {
      30 |       mockRedisClient.connect.mockResolvedValue(undefined);
      31 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:28:60)

  â— RedisService â€º Connection Management â€º should handle connection errors

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      31 |
      32 |       await redisService.connect();
    > 33 |
         | ^
      34 |       expect(mockRedisClient.connect).toHaveBeenCalled();
      35 |     });
      36 |

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:33:76)

  â— RedisService â€º Connection Management â€º should disconnect from Redis

    expect(received).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      37 |     test('should handle connection errors', async () => {
      38 |       const connectionError = new Error('Connection failed');
    > 39 |       mockRedisClient.connect.mockRejectedValue(connectionError);
         |                                                               ^
      40 |
      41 |       await expect(redisService.connect()).rejects.toThrow('Connection failed');
      42 |       expect(mockRedisClient.connect).toHaveBeenCalled();

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:39:63)

  â— RedisService â€º Connection Management â€º should check if Redis is ready

    TypeError: redis_1.default.isReady is not a function

      40 |
      41 |       await expect(redisService.connect()).rejects.toThrow('Connection failed');
    > 42 |       expect(mockRedisClient.connect).toHaveBeenCalled();
         |                                             ^
      43 |     });
      44 |
      45 |     test('should disconnect from Redis', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:42:45)

  â— RedisService â€º Basic Operations â€º should get value by key

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-value"
    Received: undefined

      50 |       expect(mockRedisClient.disconnect).toHaveBeenCalled();
      51 |     });
    > 52 |
         | ^
      53 |     test('should check if Redis is ready', () => {
      54 |       const isReady = redisService.isReady();
      55 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:52:43)

  â— RedisService â€º Basic Operations â€º should set key-value pair

    expect(received).toHaveBeenCalledWith(...expected)

    Expected: "test-key", "test-value"

    Number of calls: 0

      58 |   });
      59 |
    > 60 |   describe('Basic Operations', () => {
         |                                       ^
      61 |     test('should get value by key', async () => {
      62 |       const key = 'test-key';
      63 |       const expectedValue = 'test-value';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:60:56)

  â— RedisService â€º Basic Operations â€º should set key-value pair with expiration

    expect(received).toHaveBeenCalledWith(...expected)

    Expected: "test-key", 3600, "test-value"

    Number of calls: 0

      66 |       const result = await redisService.get(key);
      67 |
    > 68 |       expect(result).toBe(expectedValue);
         |                                          ^
      69 |       expect(mockRedisClient.get).toHaveBeenCalledWith(key);
      70 |     });
      71 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:68:58)

  â— RedisService â€º Basic Operations â€º should delete key

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      72 |     test('should set key-value pair', async () => {
      73 |       const key = 'test-key';
    > 74 |       const value = 'test-value';
         |                                  ^
      75 |       mockRedisClient.set.mockResolvedValue('OK');
      76 |
      77 |       await redisService.set(key, value);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:74:43)

  â— RedisService â€º Basic Operations â€º should check if key exists

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      79 |       expect(mockRedisClient.set).toHaveBeenCalledWith(key, value);
      80 |     });
    > 81 |
         | ^
      82 |     test('should set key-value pair with expiration', async () => {
      83 |       const key = 'test-key';
      84 |       const value = 'test-value';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:81:43)

  â— RedisService â€º Basic Operations â€º should set expiration for key

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      87 |
      88 |       await redisService.set(key, value, ttl);
    > 89 |
         | ^
      90 |       expect(mockRedisClient.setEx).toHaveBeenCalledWith(key, ttl, value);
      91 |     });
      92 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:89:43)

  â— RedisService â€º Basic Operations â€º should get TTL for key

    expect(received).toBe(expected) // Object.is equality

    Expected: 3600
    Received: undefined

       95 |       mockRedisClient.del.mockResolvedValue(1);
       96 |
    >  97 |       const result = await redisService.del(key);
          |                                           ^
       98 |
       99 |       expect(result).toBe(1);
      100 |       expect(mockRedisClient.del).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:97:43)

  â— RedisService â€º Advanced Operations â€º should get multiple keys

    TypeError: redis_1.default.mget is not a function

      104 |       const key = 'test-key';
      105 |       mockRedisClient.exists.mockResolvedValue(1);
    > 106 |
          | ^
      107 |       const result = await redisService.exists(key);
      108 |
      109 |       expect(result).toBe(1);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:106:50)

  â— RedisService â€º Advanced Operations â€º should set multiple key-value pairs

    TypeError: redis_1.default.mset is not a function

      111 |     });
      112 |
    > 113 |     test('should set expiration for key', async () => {
          |                                                  ^
      114 |       const key = 'test-key';
      115 |       const ttl = 3600;
      116 |       mockRedisClient.expire.mockResolvedValue(1);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:113:50)

  â— RedisService â€º Advanced Operations â€º should increment counter

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: undefined

      119 |
      120 |       expect(result).toBe(true);
    > 121 |       expect(mockRedisClient.expire).toHaveBeenCalledWith(key, ttl);
          |                                           ^
      122 |     });
      123 |
      124 |     test('should get TTL for key', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:121:43)

  â— RedisService â€º Advanced Operations â€º should decrement counter

    TypeError: redis_1.default.decr is not a function

      125 |       const key = 'test-key';
      126 |       const ttl = 3600;
    > 127 |       mockRedisClient.ttl.mockResolvedValue(ttl);
          |                                                  ^
      128 |
      129 |       const result = await redisService.ttl(key);
      130 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:127:50)

  â— RedisService â€º Hash Operations â€º should get hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      135 |
      136 |   describe('Advanced Operations', () => {
    > 137 |     test('should get multiple keys', async () => {
          |                                  ^
      138 |       const keys = ['key1', 'key2', 'key3'];
      139 |       const values = ['value1', 'value2', 'value3'];
      140 |       mockRedisClient.mget.mockResolvedValue(values);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:137:34)

  â— RedisService â€º Hash Operations â€º should set hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      144 |       expect(result).toEqual(values);
      145 |       expect(mockRedisClient.mget).toHaveBeenCalledWith(keys);
    > 146 |     });
          |        ^
      147 |
      148 |     test('should set multiple key-value pairs', async () => {
      149 |       const keyValues = { key1: 'value1', key2: 'value2' };

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:146:34)

  â— RedisService â€º Hash Operations â€º should get all hash fields

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      152 |       const result = await redisService.mset(keyValues);
      153 |
    > 154 |       expect(result).toBe('OK');
          |                                 ^
      155 |       expect(mockRedisClient.mset).toHaveBeenCalledWith(keyValues);
      156 |     });
      157 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:154:37)

  â— RedisService â€º Hash Operations â€º should delete hash field

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      160 |       mockRedisClient.incr.mockResolvedValue(1);
      161 |
    > 162 |       const result = await redisService.incr(key);
          |                                  ^
      163 |
      164 |       expect(result).toBe(1);
      165 |       expect(mockRedisClient.incr).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:162:34)

  â— RedisService â€º List Operations â€º should push to left of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      170 |       mockRedisClient.decr.mockResolvedValue(0);
      171 |
    > 172 |       const result = await redisService.decr(key);
          |                                   ^
      173 |
      174 |       expect(result).toBe(0);
      175 |       expect(mockRedisClient.decr).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:172:35)

  â— RedisService â€º List Operations â€º should push to right of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      178 |
      179 |   describe('Hash Operations', () => {
    > 180 |     test('should get hash field', async () => {
          |                                   ^
      181 |       const key = 'test-hash';
      182 |       const field = 'field1';
      183 |       const value = 'value1';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:180:35)

  â— RedisService â€º List Operations â€º should pop from left of list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      186 |       const result = await redisService.hget(key, field);
      187 |
    > 188 |       expect(result).toBe(value);
          |                                  ^
      189 |       expect(mockRedisClient.hget).toHaveBeenCalledWith(key, field);
      190 |     });
      191 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:188:34)

  â— RedisService â€º List Operations â€º should get range from list

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      196 |       mockRedisClient.hset.mockResolvedValue(1);
      197 |
    > 198 |       const result = await redisService.hset(key, field, value);
          |                                    ^
      199 |
      200 |       expect(result).toBe(1);
      201 |       expect(mockRedisClient.hset).toHaveBeenCalledWith(key, field, value);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:198:36)

  â— RedisService â€º Set Operations â€º should add to set

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      206 |       const hash = { field1: 'value1', field2: 'value2' };
      207 |       mockRedisClient.hgetall.mockResolvedValue(hash);
    > 208 |
          | ^
      209 |       const result = await redisService.hgetall(key);
      210 |
      211 |       expect(result).toEqual(hash);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:208:34)

  â— RedisService â€º Set Operations â€º should remove from set

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      214 |
      215 |     test('should delete hash field', async () => {
    > 216 |       const key = 'test-hash';
          |                               ^
      217 |       const field = 'field1';
      218 |       mockRedisClient.hdel.mockResolvedValue(1);
      219 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:216:34)

  â— RedisService â€º Set Operations â€º should get all set members

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      222 |       expect(result).toBe(1);
      223 |       expect(mockRedisClient.hdel).toHaveBeenCalledWith(key, field);
    > 224 |     });
          |        ^
      225 |   });
      226 |
      227 |   describe('List Operations', () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:224:38)

  â— RedisService â€º Utility Operations â€º should get keys matching pattern

    expect(received).toEqual(expected) // deep equality

    Expected: ["test:key1", "test:key2"]
    Received: undefined

      234 |
      235 |       expect(result).toBe(1);
    > 236 |       expect(mockRedisClient.lpush).toHaveBeenCalledWith(key, value);
          |                                           ^
      237 |     });
      238 |
      239 |     test('should push to right of list', async () => {

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:236:43)

  â— RedisService â€º Utility Operations â€º should flush database

    TypeError: Cannot read properties of undefined (reading 'mockResolvedValue')

      238 |
      239 |     test('should push to right of list', async () => {
    > 240 |       const key = 'test-list';
          |                               ^
      241 |       const value = 'value1';
      242 |       mockRedisClient.rpush.mockResolvedValue(1);
      243 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:240:37)

  â— RedisService â€º Utility Operations â€º should ping Redis

    expect(received).toBe(expected) // Object.is equality

    Expected: "PONG"
    Received: undefined

      246 |       expect(result).toBe(1);
      247 |       expect(mockRedisClient.rpush).toHaveBeenCalledWith(key, value);
    > 248 |     });
          |        ^
      249 |
      250 |     test('should pop from left of list', async () => {
      251 |       const key = 'test-list';

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:248:43)

  â— RedisService â€º Health Check â€º should perform health check successfully

    TypeError: redis_1.default.healthCheck is not a function

      253 |       mockRedisClient.lpop.mockResolvedValue(value);
      254 |
    > 255 |       const result = await redisService.lpop(key);
          |                                                  ^
      256 |
      257 |       expect(result).toBe(value);
      258 |       expect(mockRedisClient.lpop).toHaveBeenCalledWith(key);

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:255:50)

  â— RedisService â€º Health Check â€º should detect unhealthy Redis

    TypeError: redis_1.default.healthCheck is not a function

      262 |       const key = 'test-list';
      263 |       const start = 0;
    > 264 |       const stop = -1;
          |                       ^
      265 |       const values = ['value1', 'value2', 'value3'];
      266 |       mockRedisClient.lrange.mockResolvedValue(values);
      267 |

      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:264:50)

  â— RedisService â€º Error Handling â€º should handle Redis errors gracefully

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      271 |       expect(mockRedisClient.lrange).toHaveBeenCalledWith(key, start, stop);
      272 |     });
    > 273 |   });
          |      ^
      274 |
      275 |   describe('Set Operations', () => {
      276 |     test('should add to set', async () => {

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:273:82)

  â— RedisService â€º Error Handling â€º should handle connection timeout

    expect(received).rejects.toThrow()

    Matcher error: received value must be a promise or a function returning a promise

    Received has value: undefined

      276 |     test('should add to set', async () => {
      277 |       const key = 'test-set';
    > 278 |       const member = 'member1';
          |                                ^
      279 |       mockRedisClient.sadd.mockResolvedValue(1);
      280 |
      281 |       const result = await redisService.sadd(key, member);

      at Object.toThrow (../../node_modules/jest-circus/node_modules/expect/build/index.js:204:13)
      at Object.<anonymous> (src/__tests__/services/RedisService.test.ts:278:76)

FAIL src/__tests__/controllers/AIController.test.ts
  â— AIController â€º getRecommendations â€º should generate personalized recommendations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", ["goals", "coaches", "content"], 5

    Number of calls: 0

      76 |   });
      77 |
    > 78 |   describe('getRecommendations', () => {
         |                                         ^
      79 |     test('should generate personalized recommendations', async () => {
      80 |       mockRequest.query = {
      81 |         types: 'goals,coaches,content',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:78:104)

  â— AIController â€º getRecommendations â€º should use default limit if not provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", undefined, 5

    Number of calls: 0

      87 |         { type: 'coach', title: 'Life Coach - John Doe', score: 0.85 },
      88 |         { type: 'content', title: 'Mindfulness Article', score: 0.8 },
    > 89 |       ];
         |         ^
      90 |
      91 |       (recommendationEngine.generateRecommendations as jest.Mock).mockResolvedValue(
      92 |         mockRecommendations

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:89:104)

  â— AIController â€º getRecommendations â€º should handle recommendation generation errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<Error>

    Number of calls: 0

      92 |         mockRecommendations
      93 |       );
    > 94 |
         | ^
      95 |       await controller.getRecommendations(
      96 |         mockRequest as Request,
      97 |         mockResponse as Response,

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:94:45)

  â— AIController â€º getOptimalTiming â€º should predict optimal timing for activities

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "workout"

    Number of calls: 0

      106 |       expect(mockJson).toHaveBeenCalledWith({
      107 |         success: true,
    > 108 |         recommendations: mockRecommendations,
          |                                              ^
      109 |         generatedAt: expect.any(Date),
      110 |       });
      111 |     });

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:108:97)

  â— AIController â€º getOptimalTiming â€º should handle different activity types

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "meditation"

    Number of calls: 0

      121 |         mockNext
      122 |       );
    > 123 |
          | ^
      124 |       expect(recommendationEngine.generateRecommendations).toHaveBeenCalledWith(
      125 |         'user-123',
      126 |         undefined,

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:123:101)

  â— AIController â€º getAdaptiveSchedule â€º should generate adaptive schedule for specified date

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", Any<Date>

    Number of calls: 0

      141 |
      142 |       expect(mockNext).toHaveBeenCalledWith(expect.any(Error));
    > 143 |     });
          |        ^
      144 |   });
      145 |
      146 |   describe('getOptimalTiming', () => {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:143:105)

  â— AIController â€º getAdaptiveSchedule â€º should use current date if not specified

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", Any<Date>

    Number of calls: 0

      153 |         reasoning: 'Based on your historical patterns and energy levels',
      154 |         nextBestTime: '2024-01-15T06:00:00Z',
    > 155 |       };
          |         ^
      156 |
      157 |       (recommendationEngine.getOptimalTiming as jest.Mock).mockResolvedValue(mockTiming);
      158 |

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:155:105)

  â— AIController â€º processMessage â€º should process conversational AI message

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "How can I improve my productivity?", "conv-123", {"previousTopic": "time management"}

    Number of calls: 0

      172 |       });
      173 |     });
    > 174 |
          | ^
      175 |     test('should handle different activity types', async () => {
      176 |       const activityTypes = ['meditation', 'study', 'work', 'sleep'];
      177 |

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:174:92)

  â— AIController â€º processMessage â€º should handle new conversation without conversationId

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "Hello!", undefined, undefined

    Number of calls: 0

      187 |           mockRequest as Request,
      188 |           mockResponse as Response,
    > 189 |           mockNext
          |                   ^
      190 |         );
      191 |
      192 |         expect(recommendationEngine.getOptimalTiming).toHaveBeenCalledWith(

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:189:92)

  â— AIController â€º processMessage â€º should maintain conversation context

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      203 |
      204 |       const mockSchedule = {
    > 205 |         date: '2024-01-15',
          |                            ^
      206 |         activities: [
      207 |           { time: '06:00', activity: 'Morning workout', priority: 'high' },
      208 |           { time: '09:00', activity: 'Deep work session', priority: 'high' },

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:205:92)

  â— AIController â€º generateSmartResponse â€º should generate contextual smart response

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "I'm feeling unmotivated", {"length": "medium", "tone": "encouraging"}

    Number of calls: 0

      222 |         mockResponse as Response,
      223 |         mockNext
    > 224 |       );
          |         ^
      225 |
      226 |       expect(recommendationEngine.generateAdaptiveSchedule).toHaveBeenCalledWith(
      227 |         'user-123',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:224:94)

  â— AIController â€º generateSmartResponse â€º should support different response tones

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 0

      241 |       });
      242 |
    > 243 |       await controller.getAdaptiveSchedule(
          |                                            ^
      244 |         mockRequest as Request,
      245 |         mockResponse as Response,
      246 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:243:94)

  â— AIController â€º getPredictions â€º should retrieve comprehensive user predictions

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123"

    Number of calls: 0

      259 |         message: 'How can I improve my productivity?',
      260 |         conversationId: 'conv-123',
    > 261 |         context: { previousTopic: 'time management' },
          |                                                       ^
      262 |       };
      263 |
      264 |       const mockResult = {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:261:97)

  â— AIController â€º getPredictions â€º should identify at-risk users

    TypeError: Cannot read properties of undefined (reading '0')

      280 |       expect(conversationalAI.processConversation).toHaveBeenCalledWith(
      281 |         'user-123',
    > 282 |         'How can I improve my productivity?',
          |                                              ^
      283 |         'conv-123',
      284 |         { previousTopic: 'time management' }
      285 |       );

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:282:50)

  â— AIController â€º predictGoalCompletion â€º should predict goal completion probability

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "goal-123"

    Number of calls: 0

      297 |       (conversationalAI.processConversation as jest.Mock).mockResolvedValue({
      298 |         response: 'Hello! How can I help you today?',
    > 299 |         conversationId: 'conv-new-123',
          |                                        ^
      300 |       });
      301 |
      302 |       await controller.processMessage(

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:299:100)

  â— AIController â€º predictGoalCompletion â€º should handle goals with low completion probability

    TypeError: Cannot read properties of undefined (reading '0')

      312 |         undefined
      313 |       );
    > 314 |     });
          |        ^
      315 |
      316 |     test('should maintain conversation context', async () => {
      317 |       const messages = [

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:314:50)

  â— AIController â€º createLearningPath â€º should create personalized learning path

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "goal-456", {"duration": "8 weeks", "level": "intermediate", "topic": "Leadership Skills"}

    Number of calls: 0

      340 |   });
      341 |
    > 342 |   describe('generateSmartResponse', () => {
          |                                            ^
      343 |     test('should generate contextual smart response', async () => {
      344 |       mockRequest.body = {
      345 |         message: 'I\'m feeling unmotivated',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:342:103)

  â— AIController â€º createLearningPath â€º should adapt to user skill level

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      366 |       expect(conversationalAI.generateSmartResponse).toHaveBeenCalledWith(
      367 |         'user-123',
    > 368 |         'I\'m feeling unmotivated',
          |                                    ^
      369 |         { tone: 'encouraging', length: 'medium' }
      370 |       );
      371 |       expect(mockJson).toHaveBeenCalledWith({

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:368:103)

  â— AIController â€º analyzeVoice â€º should analyze voice recording for insights

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", {"data": [98, 97, 115, 101, 54, 52, 95, 101, 110, 99, â€¦], "type": "Buffer"}, {"previousContext": {"mood": "positive"}, "sessionType": "journal"}

    Number of calls: 0

      391 |         await controller.generateSmartResponse(
      392 |           mockRequest as Request,
    > 393 |           mockResponse as Response,
          |                                    ^
      394 |           mockNext
      395 |         );
      396 |       }

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:393:67)

  â— AIController â€º analyzeVoice â€º should detect emotional patterns in voice

    TypeError: Cannot read properties of undefined (reading '0')

      411 |         },
      412 |       };
    > 413 |
          | ^
      414 |       (predictiveAnalytics.predictUserSuccess as jest.Mock).mockResolvedValue(
      415 |         mockPredictions.success
      416 |       );

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:413:50)

  â— AIController â€º getInsightReport â€º should generate comprehensive insight report

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "weekly"

    Number of calls: 0

      436 |         predictions: mockPredictions,
      437 |       });
    > 438 |     });
          |        ^
      439 |
      440 |     test('should identify at-risk users', async () => {
      441 |       (predictiveAnalytics.predictUserSuccess as jest.Mock).mockResolvedValue({

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:438:94)

  â— AIController â€º getInsightReport â€º should support different reporting periods

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "user-123", "daily"

    Number of calls: 0

      451 |       });
      452 |
    > 453 |       await controller.getPredictions(
          |                                       ^
      454 |         mockRequest as Request,
      455 |         mockResponse as Response,
      456 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:453:98)

  â— AIController â€º hybridGenerate â€º should use hybrid AI generation strategy

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: [{"content": "Generate a personalized coaching message", "role": "user"}], ObjectContaining {"preferences": {"length": "short", "tone": "encouraging"}, "task": "content_generation"}

    Number of calls: 0

      487 |       expect(predictiveAnalytics.predictGoalCompletion).toHaveBeenCalledWith('goal-123');
      488 |       expect(mockJson).toHaveBeenCalledWith({
    > 489 |         success: true,
          |                       ^
      490 |         prediction: mockPrediction,
      491 |       });
      492 |     });

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:489:77)

  â— AIController â€º hybridGenerate â€º should route to optimal model based on task

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 3
    Received number of calls: 0

      524 |         },
      525 |       };
    > 526 |
          | ^
      527 |       const mockLearningPath = {
      528 |         id: 'path-123',
      529 |         topic: 'Leadership Skills',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:526:77)

  â— AIController â€º Error Handling â€º should handle AI service errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"message": "AI model timeout"}

    Number of calls: 0

      531 |           { id: 'mod-1', title: 'Communication Basics', duration: '2 weeks' },
      532 |           { id: 'mod-2', title: 'Team Management', duration: '3 weeks' },
    > 533 |           { id: 'mod-3', title: 'Decision Making', duration: '3 weeks' },
          |                                             ^
      534 |         ],
      535 |         totalDuration: '8 weeks',
      536 |         difficulty: 'intermediate',

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:533:45)

  â— AIController â€º Error Handling â€º should handle missing user ID

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "", Anything, Anything

    Number of calls: 0

      539 |       (adaptiveLearning.createPersonalizedLearningPath as jest.Mock).mockResolvedValue(mockLearningPath);
      540 |
    > 541 |       await controller.createLearningPath(
          |                                           ^
      542 |         mockRequest as Request,
      543 |         mockResponse as Response,
      544 |         mockNext

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:541:104)

  â— AIController â€º Error Handling â€º should handle invalid date formats

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<Error>

    Number of calls: 0

      545 |       );
      546 |
    > 547 |       expect(adaptiveLearning.createPersonalizedLearningPath).toHaveBeenCalledWith(
          |                                             ^
      548 |         'user-123',
      549 |         'goal-456',
      550 |         {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:547:45)

  â— AIController â€º Performance Considerations â€º should use parallel processing for predictions

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      557 |         success: true,
      558 |         learningPath: mockLearningPath,
    > 559 |       });
          |          ^
      560 |     });
      561 |
      562 |     test('should adapt to user skill level', async () => {

      at Object.<anonymous> (src/__tests__/controllers/AIController.test.ts:559:97)

FAIL src/middleware/sqlInjectionProtection.test.ts
  â— SQL Injection Protection â€º containsSQLInjection â€º should detect hex-encoded injection

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      26 |       expect(containsSQLInjection("' UNION SELECT * FROM users--")).toBe(true);
      27 |       expect(containsSQLInjection("1 UNION ALL SELECT password FROM users")).toBe(true);
    > 28 |     });
         |        ^
      29 |
      30 |     it('should detect boolean-based SQL injection', () => {
      31 |       expect(containsSQLInjection("1' OR '1'='1")).toBe(true);

      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:28:90)

  â— SQL Injection Protection â€º validateSQLInjection middleware â€º should allow safe request body

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      117 |     it('should block SQL injection in URL parameters', () => {
      118 |       mockRequest.params = { id: "1' OR '1'='1" };
    > 119 |
          | ^
      120 |       validateSQLInjection(
      121 |         mockRequest as Request,
      122 |         mockResponse as Response,

      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:119:30)

  â— SQL Injection Protection â€º Real-world SQL injection attempts â€º should block UNION-based data extraction

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      280 |
      281 |     it('should create pattern for start match', () => {
    > 282 |       expect(createSafeLikePattern('test', 'start')).toBe('test%');
          |                                                                    ^
      283 |     });
      284 |
      285 |     it('should create pattern for end match', () => {

      at src/middleware/sqlInjectionProtection.test.ts:282:84
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/middleware/sqlInjectionProtection.test.ts:281:21)

FAIL src/__tests__/services/SchedulerService.test.ts
  â— SchedulerService â€º Job Management â€º should get job status

    expect(received).toBe(expected) // Object.is equality

    Expected: "scheduled"
    Received: [{"name": "daily-snapshot", "running": true}, {"name": "hourly-reports", "running": true}, {"name": "weekly-cost-analysis", "running": true}, {"name": "monthly-health-check", "running": true}, {"name": "quarterly-projections", "running": true}, {"name": "alert-monitoring", "running": true}]

      281 |
      282 |   describe('Monthly Health Check Job', () => {
    > 283 |     test('should execute monthly health check successfully', async () => {
          |                                               ^
      284 |       const performMonthlyHealthCheckSpy = jest
      285 |         .spyOn(SchedulerService as any, 'performMonthlyHealthCheck')
      286 |         .mockResolvedValue(undefined);

      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:283:47)

  â— SchedulerService â€º Error Handling â€º should handle job initialization errors gracefully

    expect(received).not.toThrow()

    Error name:    "Error"
    Error message: "Invalid cron expression"

          349 |
          350 |     test('should handle errors in quarterly projections', async () => {
        > 351 |       const error = new Error('Projections failed');
              |                       ^
          352 |       const generateQuarterlyProjectionsSpy = jest
          353 |         .spyOn(SchedulerService as any, 'generateQuarterlyProjections')
          354 |         .mockRejectedValue(error);

      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:351:23)
      at Function.scheduleJob (src/services/SchedulerService.ts:3280:37)
      at Function.initialize (src/services/SchedulerService.ts:3122:10)
      at src/__tests__/services/SchedulerService.test.ts:354:77
      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:354:95)
      at Object.<anonymous> (src/__tests__/services/SchedulerService.test.ts:354:95)

FAIL src/__tests__/services/StripeWebhookService.test.ts
  â— StripeWebhookService â€º handleWebhook â€º should log new billing events

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:86:13)

  â— StripeWebhookService â€º Payment Intent Events â€º should handle payment_intent.succeeded event

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:120:13)

  â— StripeWebhookService â€º Payment Intent Events â€º should handle payment_intent.payment_failed event

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentFailed (src/services/financial/StripeWebhookService.ts:3559:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3364:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:149:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.created event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"amount": 29.99, "currency": "usd", "plan": "Premium Plan", "status": "active", "userId": 123}

    Number of calls: 0

      190 |       );
      191 |     });
    > 192 |   });
          |      ^
      193 |
      194 |   describe('Subscription Events', () => {
      195 |     test('should handle customer.subscription.created event', async () => {

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:192:60)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.updated event

    TypeError: Cannot read properties of undefined (reading 'data')



      at StripeWebhookService.handleSubscriptionUpdated (src/services/financial/StripeWebhookService.ts:3722:85)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3380:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:221:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle customer.subscription.deleted event

    TypeError: subscription.update is not a function



      at StripeWebhookService.handleSubscriptionDeleted (src/services/financial/StripeWebhookService.ts:3805:24)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3388:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:247:13)

  â— StripeWebhookService â€º Subscription Events â€º should handle trial_will_end event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"stripeCustomerId": "cus_test123"}}

    Number of calls: 0

      268 |           status: SubscriptionStatus.PAST_DUE,
      269 |         }),
    > 270 |         expect.objectContaining({
          |                                  ^
      271 |           where: { stripeSubscriptionId: 'sub_123' },
      272 |         })
      273 |       );

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:270:53)

  â— StripeWebhookService â€º Invoice Events â€º should handle invoice.payment_succeeded event

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"amount": 29.99, "status": "completed", "type": Any<String>, "userId": 123}

    Number of calls: 0

      294 |       mockSubscription.findOne.mockResolvedValue({ id: 1 } as unknown);
      295 |       mockSubscription.update.mockResolvedValue([1] as unknown);
    > 296 |
          | ^
      297 |       await webhookService.handleWebhook(subscriptionDeletedEvent);
      298 |
      299 |       expect(mockSubscription.update).toHaveBeenCalledWith(

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:296:59)

  â— StripeWebhookService â€º Invoice Events â€º should handle invoice.payment_failed event

    TypeError: subscription.update is not a function



      at StripeWebhookService.handleInvoicePaymentFailed (src/services/financial/StripeWebhookService.ts:3988:24)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3412:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:324:13)

  â— StripeWebhookService â€º Refund Events â€º should handle charge.refunded event

    TypeError: transaction.update is not a function



      at StripeWebhookService.handleChargeRefunded (src/services/financial/StripeWebhookService.ts:4054:23)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3420:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:358:13)

  â— StripeWebhookService â€º Dispute Events â€º should handle charge.dispute.created event

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      384 |         },
      385 |       } as unknown as Stripe.Event;
    > 386 |
          | ^
      387 |       mockBillingEvent.findOne.mockResolvedValue(null);
      388 |       mockBillingEvent.create.mockResolvedValue({} as unknown);
      389 |       mockUser.findOne.mockResolvedValue({ id: testUserId, email: testEmail } as unknown);

      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:386:60)

  â— StripeWebhookService â€º Error Handling â€º should handle database errors gracefully

    expect(received).resolves.toBeUndefined()

    Received promise rejected instead of resolved
    Rejected to value: [Error: Database connection failed]

      413 |             refunds: {
      414 |               data: [{
    > 415 |                 id: 're_123',
          |                              ^
      416 |                 amount: 5000,
      417 |                 reason: 'requested_by_customer',
      418 |               }],

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:415:40)

  â— StripeWebhookService â€º Error Handling â€º should handle missing metadata gracefully

    expect(received).resolves.toBeUndefined()

    Received promise rejected instead of resolved
    Rejected to value: [TypeError: Cannot read properties of undefined (reading 'PAYMENT')]

      431 |       await webhookService.handleWebhook(refundEvent);
      432 |
    > 433 |       expect(mockTransaction.update).toHaveBeenCalledWith(
          |                                        ^
      434 |         expect.objectContaining({
      435 |           status: TransactionStatus.REFUNDED,
      436 |         }),

      at expect (../../node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:433:40)

  â— StripeWebhookService â€º Amount Conversion â€º should correctly convert cents to dollars

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:455:13)

  â— StripeWebhookService â€º Amount Conversion â€º should handle zero-decimal currencies correctly

    TypeError: Cannot read properties of undefined (reading 'PAYMENT')



      at StripeWebhookService.handlePaymentSucceeded (src/services/financial/StripeWebhookService.ts:3484:38)
      at StripeWebhookService.handleWebhook (src/services/financial/StripeWebhookService.ts:3356:11)
      at Object.<anonymous> (src/__tests__/services/StripeWebhookService.test.ts:478:13)

FAIL src/__tests__/utils/logger.minimal.test.ts
  â— Logger Utility - Minimal Coverage â€º should import logger without errors

    expect(received).not.toThrow()

    Error name:    "TypeError"
    Error message: "winston_1.default.format.printf is not a function"

      at Object.<anonymous> (src/utils/logger.ts:2521:63)
      at src/__tests__/utils/logger.minimal.test.ts:31:32
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:33:16)
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:33:16)

  â— Logger Utility - Minimal Coverage â€º should handle basic logging operations

    TypeError: winston_1.default.format.printf is not a function



      at Object.<anonymous> (src/utils/logger.ts:2521:63)
      at Object.<anonymous> (src/__tests__/utils/logger.minimal.test.ts:36:28)

FAIL src/__tests__/services/RedisService.simple.test.ts
  â— RedisService â€º should handle basic Redis operations

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-value"
    Received: undefined



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:83:39)

  â— RedisService â€º should handle Redis connection

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:89:56)

  â— RedisService â€º should handle Redis ping

    expect(received).toBe(expected) // Object.is equality

    Expected: "PONG"
    Received: undefined



      at Object.<anonymous> (src/__tests__/services/RedisService.simple.test.ts:95:39)

FAIL src/__tests__/services/EmailService.test.ts
  â— Test suite failed to run

    TypeError: nodemailer_1.default.createTransporter is not a function



      at EmailService.initializeTransporter (src/services/EmailService.ts:1396:47)
      at new EmailService (src/services/EmailService.ts:1344:10)
      at Object.<anonymous> (src/services/EmailService.ts:1824:24)
      at Object.<anonymous> (src/__tests__/services/EmailService.test.ts:8:24)

FAIL src/__tests__/controllers/CoachController.test.ts
  â— Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'isString')



      at CoachController.<instance_members_initializer> (src/controllers/CoachController.ts:3989:89)
      at new CoachController (src/controllers/CoachController.ts:3985:1)
      at Object.<anonymous> (src/controllers/CoachController.ts:5227:27)
      at Object.<anonymous> (src/__tests__/controllers/CoachController.test.ts:21:27)


Test Suites: 26 failed, 29 passed, 55 total
Tests:       419 failed, 515 passed, 934 total
Snapshots:   0 total
Time:        41.368 s
Ran all test suites.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/services/api
npm error workspace @upcoach/api@1.0.0
npm error location /Users/ardisetiadharma/CURSOR Repository/UpCoach/upcoach-project/services/api
npm error command failed
npm error command sh -c NODE_OPTIONS='--max-old-space-size=2048' jest --passWithNoTests --verbose
