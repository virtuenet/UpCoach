name: Frontend - Test & Deploy to Vercel

on:
  push:
    branches: [main, develop]
    paths:
      - 'upcoach-project/apps/admin-panel/**'
      - 'upcoach-project/apps/cms-panel/**'
      - 'upcoach-project/apps/landing-page/**'
      - '.github/workflows/frontend-deploy.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'upcoach-project/apps/admin-panel/**'
      - 'upcoach-project/apps/cms-panel/**'
      - 'upcoach-project/apps/landing-page/**'

env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # ADMIN PANEL - Build & Deploy
  # ========================================
  admin-panel-build:
    name: Admin Panel - Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./upcoach-project/apps/admin-panel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './upcoach-project/apps/admin-panel/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: admin-panel-build
          path: ./upcoach-project/apps/admin-panel/.next
          retention-days: 7

  admin-panel-deploy-staging:
    name: Admin Panel - Deploy to Staging
    runs-on: ubuntu-latest
    needs: admin-panel-build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
          working-directory: ./upcoach-project/apps/admin-panel
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

  admin-panel-deploy-production:
    name: Admin Panel - Deploy to Production
    runs-on: ubuntu-latest
    needs: admin-panel-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production-admin
      url: https://admin.upcoach.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
          working-directory: ./upcoach-project/apps/admin-panel
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Admin Panel deployed to production'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ========================================
  # CMS PANEL - Build & Deploy
  # ========================================
  cms-panel-build:
    name: CMS Panel - Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./upcoach-project/apps/cms-panel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './upcoach-project/apps/cms-panel/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cms-panel-build
          path: ./upcoach-project/apps/cms-panel/.next
          retention-days: 7

  cms-panel-deploy-staging:
    name: CMS Panel - Deploy to Staging
    runs-on: ubuntu-latest
    needs: cms-panel-build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_CMS }}
          working-directory: ./upcoach-project/apps/cms-panel
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

  cms-panel-deploy-production:
    name: CMS Panel - Deploy to Production
    runs-on: ubuntu-latest
    needs: cms-panel-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production-cms
      url: https://cms.upcoach.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_CMS }}
          working-directory: ./upcoach-project/apps/cms-panel
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'CMS Panel deployed to production'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ========================================
  # LANDING PAGE - Build & Deploy
  # ========================================
  landing-page-build:
    name: Landing Page - Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./upcoach-project/apps/landing-page

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './upcoach-project/apps/landing-page/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: landing-page-build
          path: ./upcoach-project/apps/landing-page/.next
          retention-days: 7

  landing-page-deploy-staging:
    name: Landing Page - Deploy to Staging
    runs-on: ubuntu-latest
    needs: landing-page-build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_LANDING }}
          working-directory: ./upcoach-project/apps/landing-page
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

  landing-page-deploy-production:
    name: Landing Page - Deploy to Production
    runs-on: ubuntu-latest
    needs: landing-page-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production-landing
      url: https://upcoach.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_LANDING }}
          working-directory: ./upcoach-project/apps/landing-page
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Landing Page deployed to production'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ========================================
  # LIGHTHOUSE CI (Performance Check)
  # ========================================
  lighthouse-ci:
    name: Lighthouse CI Performance Check
    runs-on: ubuntu-latest
    needs: [landing-page-deploy-staging]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://upcoach-staging.vercel.app
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ========================================
  # PREVIEW DEPLOYMENTS (PRs)
  # ========================================
  preview-admin:
    name: Admin Panel - Preview Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        id: deploy-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
          working-directory: ./upcoach-project/apps/admin-panel
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Admin Panel Preview Deployed\n\nPreview URL: ${{ steps.deploy-preview.outputs.preview-url }}\n\nThis preview will be automatically deleted when the PR is closed.`
            })

  preview-cms:
    name: CMS Panel - Preview Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        id: deploy-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_CMS }}
          working-directory: ./upcoach-project/apps/cms-panel
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ CMS Panel Preview Deployed\n\nPreview URL: ${{ steps.deploy-preview.outputs.preview-url }}\n\nThis preview will be automatically deleted when the PR is closed.`
            })

  preview-landing:
    name: Landing Page - Preview Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        id: deploy-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_LANDING }}
          working-directory: ./upcoach-project/apps/landing-page
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Landing Page Preview Deployed\n\nPreview URL: ${{ steps.deploy-preview.outputs.preview-url }}\n\nThis preview will be automatically deleted when the PR is closed.`
            })
